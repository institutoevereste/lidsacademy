<!DOCTYPE html>
<html lang="pt-pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evereste Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos do dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Cores do Logo LIDS */
      --brand-blue: #0066cc;
      --brand-orange: #ff6b35;
      --brand-teal: #00a896;
      --brand-purple: #6a4c93;
      --brand-yellow: #ffc857;

      /* Paleta Principal */
      --primary: #0066cc;
      --primary-dark: #004c99;
      --primary-light: #3385d6;
      --accent: #ff6b35;
      --accent-light: #ff8c61;

      /* Tema Claro */
      --surface: #ffff;
      --surface-light: #f8fafc;
      --surface-card: #ffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: rgba(0, 102, 204, 0.12);
      --glow: rgba(0, 102, 204, 0.2);

      /* Hero (Tema Escuro) */
      --hero-bg: #0f172a;
      --hero-text: #ffff;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 50%, #fef3c7 100%);
      color: var(--text);
      position: relative;
      overflow-x: hidden; /* Previne scroll horizontal */
    }

    /* Scroll Progress Bar */
    #scroll-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
      z-index: 100;
      transition: width 100ms ease;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    /* Header Glassmorphism */
    .header-glass {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(180%) blur(16px);
      background: rgba(255, 255, 255, 0.85);
      border-bottom: 1px solid var(--border);
      transition: all 300ms ease;
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.08);
    }

    .header-scrolled {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 10px 30px rgba(0, 102, 204, 0.15);
      border-color: rgba(0, 102, 204, 0.2);
    }

    /* Hero (Tema Escuro) */
    .hero {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
      background-size: 200% 200%;
      animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {
      0%,
      100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(1200px 500px at 80% -10%, rgba(0, 102, 204, 0.2), transparent 50%),
        radial-gradient(900px 380px at 10% 10%, rgba(255, 107, 53, 0.15), transparent 60%);
      pointer-events: none;
    }

    .scroll-indicator {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      animation: bounce 2s infinite;
      color: var(--hero-text);
    }

    @keyframes bounce {
      0%,
      100% {
        transform: translateX(-50%) translateY(0);
      }
      50% {
        transform: translateX(-50%) translateY(-10px);
      }
    }

    /* Particles */
    .particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .particles span {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 999px;
      animation: float 12s linear infinite;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
    }

    @keyframes float {
      0% {
        transform: translateY(0) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-120vh) translateX(20vw);
        opacity: 0;
      }
    }

    /* 3D Cards with Gradient Border */
    .card-3d {
      background: var(--surface-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 102, 204, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card-3d::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      padding: 2px;
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 300ms ease;
    }

    .card-3d:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0, 102, 204, 0.2), 0 0 0 1px var(--glow);
    }

    .card-3d:hover::before {
      opacity: 1;
    }

    /* Solid Color Course Cards */
    .course-card-solid {
      border: none;
      color: white;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .course-card-solid::before {
      display: none;
    }

    .course-card-solid:hover {
      transform: translateY(-8px) scale(1.02);
      filter: brightness(1.1);
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal));
      border: 1px solid rgba(0, 102, 204, 0.3);
      border-radius: 12px;
      color: #fff;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.25);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      transition: transform 400ms ease;
    }

    .btn-primary:hover::before {
      transform: translateX(100%);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 102, 204, 0.35);
    }

    .btn-ghost {
      background: rgba(0, 102, 204, 0.08);
      border: 1px solid var(--border);
      color: var(--primary);
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
    }

    .btn-ghost:hover {
      transform: translateY(-2px);
      background: rgba(0, 102, 204, 0.15);
      border-color: var(--primary);
    }
    
    .btn-disabled {
      background: #94a3b8;
      color: #e2e8f0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-disabled:hover {
      background: #94a3b8;
      box-shadow: none;
      transform: none;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-danger:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }


    /* Reveal Animation */
    .reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: all 600ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .reveal.show {
      opacity: 1;
      transform: translateY(0);
    }

    .stagger-1 {
      transition-delay: 100ms;
    }

    .stagger-2 {
      transition-delay: 200ms;
    }

    .stagger-3 {
      transition-delay: 300ms;
    }

    .stagger-4 {
      transition-delay: 400ms;
    }

    .stagger-5 {
      transition-delay: 500ms;
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(0, 102, 204, 0.12);
      border: 1px solid rgba(0, 102, 204, 0.25);
      color: var(--primary);
      font-size: 14px;
    }

    .badge-soon {
      background: rgba(255, 200, 87, 0.15);
      border-color: rgba(255, 200, 87, 0.4);
      color: #d97706;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      visibility: hidden;
      transition: all 250ms ease;
      z-index: 70;
      display: flex; /* Alterado para flex */
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-card {
      width: 100%;
      border-radius: 20px;
      background: var(--surface-card);
      border: 1px solid var(--border);
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 70px rgba(0, 102, 204, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      max-height: 90vh; /* Altura máxima */
      overflow-y: auto; /* Scroll se necessário */
    }
    
    .modal-card-sm { max-width: 520px; }
    .modal-card-md { max-width: 640px; }
    .modal-card-lg { max-width: 800px; }
    .modal-card-xl { max-width: 1024px; }


    .modal-backdrop.show .modal-card {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    /* Gradient Text */
    .gradient-text {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Blur Blob Decoration */
    .blur-blob {
      position: absolute;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.15;
      pointer-events: none;
      z-index: -1;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-light);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--brand-blue), var(--brand-teal));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
    
    /* Scrollbar para Modais */
    .modal-card::-webkit-scrollbar-thumb {
      background: var(--brand-purple);
    }

    /* Instructor Avatar */
    .instructor-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      transition: all 250ms ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .instructor-avatar:hover {
      transform: scale(1.1);
    }

    /* Section Backgrounds */
    .section-light {
      background: var(--surface);
    }

    .section-alt {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.03), rgba(0, 168, 150, 0.03));
    }

    /* Course Detail Page Styles */
    .course-detail-hero {
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }

    .course-detail-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Admin Panel Styles (Light Mode) */
    #admin-panel {
      min-height: 100vh;
      display: flex;
    }
    #admin-nav {
      width: 260px;
      background: #ffffff; /* Alterado de escuro para branco */
      color: #334155; /* Alterado de claro para escuro */
      border-right: 1px solid #e2e8f0; /* Adicionada borda */
    }
    #admin-content {
      flex: 1;
      background: #f1f5f9; /* Light gray */
    }
    .admin-nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: #64748b; /* Alterado de #94a3b8 */
      font-weight: 600;
      transition: all 200ms ease;
      border-left: 4px solid transparent;
    }
    .admin-nav-link:hover {
      color: #1e293b; /* Alterado de #f1f5f9 */
      background: #f1f5f9; /* Alterado de #1e293b */
    }
    .admin-nav-link.active {
      color: var(--primary); /* Alterado de #fff */
      background: linear-gradient(90deg, rgba(0,102,204,0.1), transparent); /* Gradiente mais leve */
      border-left-color: var(--brand-blue);
    }
    .admin-nav-link .fa-solid {
      width: 20px;
      text-align: center;
    }
    
    /* Admin Table Styles */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .admin-table th, .admin-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    .admin-table th {
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 700;
    }
    .admin-table td {
      color: #334155;
      font-size: 14px;
    }
    .admin-table tbody tr:last-child td {
      border-bottom: none;
    }
    .admin-table tbody tr:hover {
      background: #f1f5f9;
    }
    .admin-table .actions {
      display: flex;
      gap: 10px;
    }
    
    /* Admin Form Fields */
    .admin-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-muted);
    }
    .admin-input, .admin-textarea, .admin-select {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text);
      background: var(--surface-light);
      transition: all 200ms ease;
    }
    .admin-input:focus, .admin-textarea:focus, .admin-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.2);
    }
    .admin-textarea {
      min-height: 120px;
      font-family: monospace;
    }
    
    /* Checkbox list */
    .checkbox-list {
      max-height: 150px;
      overflow-y: auto;
      background: var(--surface-light);
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
    }
    .checkbox-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    .checkbox-list label:hover {
      background: #e2e8f0;
    }
    .checkbox-list input {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    /* Toasts (Notificações) */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .toast {
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border: 1px solid rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(120%);
      opacity: 0;
      transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 300px;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast-success {
      background: #dcfce7;
      color: #166534;
      border-left: 5px solid #22c55e;
    }
    .toast-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 5px solid #ef4444;
    }
    .toast .icon {
      font-size: 20px;
    }
    .toast-message {
      font-weight: 600;
      flex: 1;
    }
    .toast-close {
      background: transparent;
      border: none;
      color: inherit;
      opacity: 0.6;
      cursor: pointer;
      font-size: 18px;
    }
    .toast-close:hover {
      opacity: 1;
    }
  </style>
</head>

<body class="antialiased">
  <!-- Container de Notificações Toast -->
  <div id="toast-container"></div>
  
  <!-- Scroll Progress Bar -->
  <div id="scroll-progress"></div>

  <!-- Header -->
  <header id="header" class="header-glass">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="#" id="logo-link" class="cursor-pointer">
          <img src="https://i.postimg.cc/hvvWCwnk/Prancheta-1-1.png" alt="Logo LIDS" class="h-10 w-auto" />
        </a>
      </div>
      <div class="flex items-center gap-4">
        <!-- Botão Admin visível apenas se logado como admin -->
        <button id="adminBtnHeader" class="btn-ghost text-sm"><i class="fas fa-lock mr-2"></i>Admin</button>
        <!-- Botão Logout visível apenas se logado como admin -->
        <button id="logoutBtnHeader" class="btn-danger text-sm hidden"><i class="fas fa-right-from-bracket mr-2"></i>Logout</button>
      </div>
    </div>
  </header>

  <!-- Main View (Course List) -->
  <div id="main-view">
    <!-- Hero (Tema Escuro) -->
    <section class="hero relative text-white">
      <div class="relative z-10 container mx-auto px-6 py-24 md:py-32">
        <div class="reveal max-w-3xl">
          <span class="badge mb-5" style="background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-bolt"></i> Inscrições Abertas</span>
          <h1 class="text-5xl md:text-7xl font-black leading-tight mb-4" style="color: white;">Evereste Academy</h1>
          <p class="text-lg md:text-xl text-slate-200 max-w-2xl mb-8">Formações práticas e focadas em resultados para elevar a excelência do Instituto Evereste. Profissionalismo, dinamismo e tecnologia a favor do seu desenvolvimento.</p>
          <div class="flex items-center gap-4 flex-wrap">
            <a href="#cursos" class="btn-primary"><i class="fa-solid fa-graduation-cap mr-2"></i> Ver Cursos</a>
          </div>
        </div>
      </div>
      <div class="scroll-indicator text-white text-2xl">
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="particles" id="particles"></div>
      <img src="https://i.postimg.cc/4xNpxRZJ/capabannerlids.png" alt="Banner" class="absolute inset-0 w-full h-full object-cover opacity-20 pointer-events-none" />
    </section>

    <!-- Cursos Disponíveis -->
    <section id="cursos" class="section-light container mx-auto px-6 py-20 md:py-28 relative">
      <div class="blur-blob" style="background: var(--brand-blue); top: -200px; right: -200px;"></div>
      <div class="blur-blob" style="background: var(--brand-orange); bottom: -200px; left: -200px;"></div>
      
      <!-- Cursos com Vagas Abertas -->
      <div class="reveal text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-black mb-4" style="color: var(--text);">Cursos Disponíveis</h2>
        <p class="text-lg" style="color: var(--text-muted);">Inscrições abertas para as próximas turmas</p>
      </div>
      <div id="courses-list-open" class="grid md:grid-cols-2 gap-8 mb-20">
        <!-- Cards de cursos com status 'aberto' -->
        <p class="text-center md:col-span-2 text-gray-500">A carregar cursos...</p>
      </div>

      <!-- Cursos Futuros -->
      <div class="reveal">
        <h3 class="text-3xl font-bold mb-8 text-center" style="color: var(--text);">Em Breve</h3>
        <div id="courses-list-soon" class="grid md:grid-cols-3 gap-6">
          <!-- Cards de cursos com status 'em_breve' -->
           <p class="text-center md:col-span-3 text-gray-500">A carregar futuros cursos...</p>
        </div>
      </div>
    </section>

    <!-- REMOVIDO: Seção Instrutores -->

    <!-- Sobre -->
    <section id="sobre" class="section-alt container mx-auto px-6 py-20 md:py-28">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div class="reveal">
          <h2 class="text-4xl md:text-5xl font-black mb-6" style="color: var(--text);">Excelência e Profissionalismo</h2>
          <p class="text-lg mb-6" style="color: var(--text-muted);">O Programa Evereste Academy é uma iniciativa do Instituto Evereste que oferece experiências imersivas, conteúdos aplicados e uma abordagem voltada à prática. Unimos design moderno, tecnologia e didática para acelerar o desenvolvimento.</p>
          <ul class="space-y-4">
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Instrutores com experiência prática</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Conteúdo atualizado e relevante</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Foco em resultados e aplicabilidade</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Aprendizagem validada com check-in</span></li>
          </ul>
        </div>
        <div class="reveal">
          <div class="card-3d p-8">
            <img src="https://i.postimg.cc/0NBrsPL3/treinamento-notion-01.jpg" alt="Equipa em treinamento" class="w-full h-auto rounded-lg" />
            <p class="mt-6 text-center font-medium" style="color: var(--text-muted);">Uma iniciativa do Instituto Evereste para formações transformadoras.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="border-t" style="border-color: var(--border); background: var(--surface);">
      <div class="container mx-auto px-6 py-12">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
          <div class="text-center md:text-left">
            <p class="text-sm" style="color: var(--text-muted);">© 2025 Evereste Academy. Todos os direitos reservados.</p>
            <a href="#" id="privacy-policy-link" class="text-sm text-blue-600 hover:underline">Política de Privacidade</a>
          </div>
          <div class="flex items-center gap-4">
            <button id="adminBtnFooter" class="btn-ghost text-sm"><i class="fas fa-lock mr-2"></i>Acesso Admin</button>
            <button id="logoutBtnFooter" class="btn-danger text-sm hidden"><i class="fas fa-right-from-bracket mr-2"></i>Logout</button>
            <img src="https://i.postimg.cc/SKQh2j5n/logo-evereste-2025-horizontal-2.png" alt="Instituto Evereste" class="h-8 w-auto" />
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Course Detail View -->
  <div id="course-detail-view" class="hidden">
    <!-- O conteúdo dinâmico será injetado aqui pela função renderCourseDetail() -->
    <p class="text-center p-20">A carregar detalhes do curso...</p>
  </div>
  
  <!-- Admin Panel View -->
  <div id="admin-panel-view" class="hidden">
    <div id="admin-panel">
      <!-- Navegação Lateral do Admin -->
      <nav id="admin-nav" class="flex flex-col flex-shrink-0 p-6">
        <div class="mb-10 px-4 pt-3"> <!-- Apenas ajustei o padding/margem -->
          <h2 class="text-2xl font-bold text-slate-800">Painel Admin</h2>
        </div>
        <a href="#dashboard" class="admin-nav-link active" data-target="admin-dashboard">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </a>
        <a href="#cursos" class="admin-nav-link" data-target="admin-cursos">
          <i class="fa-solid fa-graduation-cap"></i> Cursos
        </a>
        <a href="#matriculas" class="admin-nav-link" data-target="admin-matriculas">
          <i class="fa-solid fa-users"></i> Matrículas
        </a>
        <a href="#instrutores" class="admin-nav-link" data-target="admin-instrutores">
          <i class="fa-solid fa-chalkboard-user"></i> Instrutores
        </a>
        <div class="mt-auto">
          <a href="#" id="admin-logout-nav" class="admin-nav-link !border-transparent hover:!bg-red-100 hover:!text-red-700"> <!-- Classes de hover alteradas -->
            <i class="fa-solid fa-right-from-bracket"></i> Sair
          </a>
          <p id="admin-user-email" class="text-xs text-center text-slate-500 mt-4 break-all"></p>
        </div>
      </nav>
      
      <!-- Conteúdo Principal do Admin -->
      <main id="admin-content" class="p-10 overflow-y-auto">
        
        <!-- Seção Dashboard -->
        <section id="admin-dashboard" class="admin-section">
          <h1 class="text-3xl font-bold mb-8">Dashboard</h1>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"> <!-- Alterado para 2 colunas -->
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Matrículas</h3>
              <p id="stats-total-enrollments" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Check-ins</h3>
              <p id="stats-total-checkins" class="text-3xl font-bold text-teal-600">0</p>
            </div>
          </div>
          <div class="card-3d !p-6">
            <h3 class="text-lg font-bold mb-4">Matrículas ao Longo do Tempo</h3>
            <canvas id="enrollmentsChart" height="100"></canvas>
          </div>
        </section>
        
        <!-- Seção Cursos -->
        <section id="admin-cursos" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Cursos</h1>
            <button id="admin-add-course-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Novo Curso</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Status</th>
                  <th>Instrutores</th>
                  <th>Data</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-courses-table-body">
                <!-- Linhas de cursos -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Matrículas -->
        <section id="admin-matriculas" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8">Gestão de Matrículas</h1>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Protocolo</th>
                  <th>Aluno</th>
                  <th>E-mail</th>
                  <th>Curso</th>
                  <th>Data</th>
                  <th>Setor</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-enrollments-table-body">
                <!-- Linhas de matrículas -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Instrutores -->
        <section id="admin-instrutores" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Instrutores</h1>
            <button id="admin-add-instructor-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Instrutor</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Foto</th>
                  <th>Nome</th>
                  <th>Título</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-instructors-table-body">
                <!-- Linhas de instrutores -->
              </tbody>
            </table>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAIS -->

  <!-- Modal Login -->
  <div id="modalLogin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Acesso Administrativo</h3>
          <p class="text-sm" style="color: var(--text-muted);">Área restrita para gestores</p>
        </div>
        <button id="closeLogin" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="admin-label">E-mail</label>
          <input id="loginEmail" type="email" class="admin-input" placeholder="admin@evereste.org" required />
        </div>
        <div>
          <label class="admin-label">Senha</label>
          <input id="loginPassword" type="password" class="admin-input" placeholder="••••••••" required />
        </div>
        <p id="loginError" class="text-red-600 text-sm hidden">Erro ao fazer login.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base"><i class="fa-solid fa-right-to-bracket mr-2"></i>Entrar</button>
      </form>
    </div>
  </div>

  <!-- Modal Inscrição -->
  <div id="modalEnroll" class="modal-backdrop">
    <div class="modal-card modal-card-md p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Formulário de Inscrição</h3>
          <p class="text-sm" style="color: var(--text-muted);">Inscreva-se no curso: <strong id="enrollCourseName" class="text-blue-600"></strong></p>
        </div>
        <button id="closeEnroll" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="enrollForm" class="space-y-4">
        <div>
          <label class="admin-label">Nome Completo</label>
          <input id="enrollName" type="text" class="admin-input" placeholder="O seu nome" required />
        </div>
        <div>
          <label class="admin-label">E-mail</label>
          <input id="enrollEmail" type="email" class="admin-input" placeholder="voce@email.com" required />
        </div>
        <div>
          <label class="admin-label">Telefone</label>
          <input id="enrollPhone" type="tel" class="admin-input" placeholder="(00) 00000-0000" required />
        </div>
        <div>
          <label class="admin-label">Setor</label>
          <input id="enrollSector" type="text" class="admin-input" placeholder="Ex: Comunicação, Pedagógico..." required />
        </div>

        <!-- Termos e LGPD -->
        <div class="space-y-3 pt-2">
          <label class="flex items-start gap-3 cursor-pointer text-sm">
            <input type="checkbox" id="enrollTermImage" class="mt-1 h-5 w-5 accent-blue-600" required />
            <span class="text-gray-700">Eu concordo com o <a href="#" target="_blank" class="text-blue-600 underline">Termo de Uso de Imagem</a>.</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer text-sm">
            <input type="checkbox" id="enrollTermPrivacy" class="mt-1 h-5 w-5 accent-blue-600" required />
            <span class="text-gray-700">Eu li e concordo com a <a href="#" target="_blank" class="text-blue-600 underline">Política de Privacidade (LGPD)</a>.</span>
          </label>
        </div>

        <p id="enrollError" class="text-red-600 text-sm hidden">Erro ao processar inscrição. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="enrollSubmitBtnText"><i class="fa-solid fa-paper-plane mr-2"></i>Confirmar Inscrição</span>
          <span id="enrollSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A processar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Sucesso Inscrição (Protocolo) -->
  <div id="modalEnrollSuccess" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
      <div class="text-center">
        <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
        <h3 class="text-2xl font-bold" style="color: var(--text);">Inscrição Confirmada!</h3>
        <p class="text-base mt-2" style="color: var(--text-muted);">Guarde o seu número de protocolo:</p>
        <p id="enrollProtocol" class="text-3xl font-bold text-blue-600 bg-blue-50 border-2 border-blue-200 rounded-lg py-4 my-4"></p>
        <p class="text-sm" style="color: var(--text-muted);">Você receberá os detalhes da inscrição no seu e-mail.</p>
      </div>
      <button id="closeEnrollSuccess" class="btn-primary w-full mt-6">Fechar</button>
    </div>
  </div>

  <!-- Modal Check-in (Simplificado) -->
  <div id="modalCheckin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
      <i class="fas fa-user-check text-6xl text-blue-500 mb-6"></i>
      <h3 class="text-2xl font-bold" style="color: var(--text);">Confirmar Presença</h3>
      <p class="text-base mt-2 mb-6" style="color: var(--text-muted);">Confirma a sua presença neste curso?</p>
      <form id="checkinForm">
        <p id="checkinError" class="text-red-600 text-sm hidden mb-4">Erro ao processar. Tente novamente.</p>
        <div class="flex gap-4">
          <button type="button" id="closeCheckin" class="btn-ghost w-full">Cancelar</button>
          <button type="submit" class="btn-primary w-full">
            <span id="checkinSubmitBtnText">Confirmar</span>
            <span id="checkinSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A confirmar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Avaliar Instrutor -->
  <div id="modalRating" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Avaliar Instrutor</h3>
          <p class="text-sm" style="color: var(--text-muted);">O seu feedback é importante para nós.</p>
        </div>
        <button id="closeRating" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="ratingForm" class="space-y-4">
        <div>
          <label class="admin-label">Selecione o Instrutor</label>
          <select id="ratingInstructorSelect" class="admin-select" required>
            <!-- Opções de instrutores -->
          </select>
        </div>
        <div>
          <label class="admin-label">A sua avaliação (1 a 5 estrelas)</label>
          <div id="ratingStars" class="flex text-3xl text-gray-300 cursor-pointer">
            <i class="fa-solid fa-star" data-value="1"></i>
            <i class="fa-solid fa-star" data-value="2"></i>
            <i class="fa-solid fa-star" data-value="3"></i>
            <i class="fa-solid fa-star" data-value="4"></i>
            <i class="fa-solid fa-star" data-value="5"></i>
          </div>
          <input type="hidden" id="ratingValue" value="0" required>
        </div>
         <div>
          <label class="admin-label">Comentário (Opcional)</label>
          <textarea id="ratingComment" class="admin-textarea" rows="3" placeholder="O que achou da didática?"></textarea>
        </div>
        <p id="ratingError" class="text-red-600 text-sm hidden">Erro ao enviar. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="ratingSubmitBtnText">Enviar Avaliação</span>
          <span id="ratingSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A enviar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Curso -->
  <div id="modalEditCourse" class="modal-backdrop">
    <div class="modal-card modal-card-xl p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalCourseTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditCourse" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="courseForm" class="space-y-6">
        <input type="hidden" id="courseId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="courseTitle">Título</label>
            <input class="admin-input" type="text" id="courseTitle" required>
          </div>
          <div>
            <label class="admin-label" for="courseSubtitle">Subtítulo</label>
            <input class="admin-input" type="text" id="courseSubtitle" required>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="admin-label" for="courseThemeColor">Cor (Hex)</label>
            <input class="admin-input" type="text" id="courseThemeColor" placeholder="#FFC107" required>
          </div>
          <div>
            <label class="admin-label" for="courseIcon">Ícone (FontAwesome)</label>
            <input class="admin-input" type="text" id="courseIcon" placeholder="fa-camera-retro" required>
          </div>
          <div>
            <label class="admin-label" for="courseStatus">Status</label>
            <select id="courseStatus" class="admin-select" required>
              <option value="aberto">Vagas Abertas</option>
              <option value="em_breve">Em Breve</option>
              <option value="fechado">Fechado</option>
            </select>
          </div>
        </div>
         <div>
            <label class="admin-label" for="courseHeaderImage">URL Imagem Capa</label>
            <input class="admin-input" type="text" id="courseHeaderImage" placeholder="https://url-da-imagem.com/capa.jpg" required>
          </div>
        <div>
          <label class="admin-label" for="courseSummary">Resumo (Card)</label>
          <textarea class="admin-textarea" id="courseSummary" rows="2" required></textarea>
        </div>
        <div>
          <label class="admin-label" for="courseFullDescription">Descrição Completa</label>
          <textarea class="admin-textarea" id="courseFullDescription" rows="3" required></textarea>
        </div>
        <div>
          <label class="admin-label" for="courseTargetAudience">Público-alvo</label>
          <textarea class="admin-textarea" id="courseTargetAudience" rows="2" required></textarea>
        </div>
        
        <!-- JSON Fields -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="courseDetails">Detalhes (JSON)</label>
            <textarea class="admin-textarea" id="courseDetails" rows="5" placeholder='{ "Data": "TBA", "Carga": "4h" }' required></textarea>
          </div>
          <div>
            <label class="admin-label" for="courseLearningObjectives">Objetivos (JSON)</label>
            <textarea class="admin-textarea" id="courseLearningObjectives" rows="5" placeholder='[ "Aprender X", "Fazer Y" ]' required></textarea>
          </div>
          <div>
            <label class="admin-label" for="courseRequirements">Requisitos (JSON)</label>
            <textarea class="admin-textarea" id="courseRequirements" rows="5" placeholder='[ "Trazer notebook", "Saber Z" ]' required></textarea>
          </div>
           <div>
            <label class="admin-label" for="courseModules">Módulos (JSON)</label>
            <textarea class="admin-textarea" id="courseModules" rows="5" placeholder='[ { "title": "Módulo 1", "topics": ["Tópico 1"] } ]' required></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="admin-label" for="coursePracticalActivities">Atividades Práticas (JSON)</label>
            <textarea class="admin-textarea" id="coursePracticalActivities" rows="5" placeholder='[ { "title": "Atividade 1", "description": "Fazer X" } ]' required></textarea>
          </div>
        </div>
        
        <!-- Instructors Selection -->
        <div>
          <label class="admin-label">Instrutores</label>
          <div id="courseInstructorsList" class="checkbox-list">
            <!-- Checkboxes de instrutores -->
          </div>
        </div>

        <!-- Liberar Avaliação -->
        <div class="pt-2">
          <label class="flex items-center gap-3 cursor-pointer text-sm">
            <input type="checkbox" id="courseIsRatingEnabled" class="h-5 w-5 accent-blue-600" />
            <span class="text-gray-700 font-medium">Liberar Avaliação do Curso? (Permite que alunos avaliem)</span>
          </label>
        </div>
        
        <p id="courseFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="courseFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="courseSubmitBtnText">Salvar Curso</span>
            <span id="courseFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Instrutor -->
  <div id="modalEditInstructor" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalInstructorTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditInstructor" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="instructorForm" class="space-y-6">
        <input type="hidden" id="instructorId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="instructorName">Nome</label>
            <input class="admin-input" type="text" id="instructorName" required>
          </div>
           <div>
            <label class="admin-label" for="instructorTitle">Título</label>
            <input class="admin-input" type="text" id="instructorTitle" placeholder="Ex: Supervisor de Marketing" required>
          </div>
        </div>
        <div>
            <label class="admin-label" for="instructorImage">URL da Foto</label>
            <input class="admin-input" type="text" id="instructorImage" placeholder="https://url-da-foto.com/perfil.jpg" required>
        </div>
        <div>
          <label class="admin-label" for="instructorBio">Biografia (Card)</label>
          <textarea class="admin-textarea" id="instructorBio" rows="3" placeholder="Pequena descrição que aparece no card..."></textarea>
        </div>
        
        <p id="instructorFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="instructorFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="instructorSubmitBtnText">Salvar Instrutor</span>
            <span id="instructorFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Confirmação de Exclusão -->
  <div id="modalConfirmDelete" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
      <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-6"></i>
      <h3 class="text-2xl font-bold" style="color: var(--text);">Tem a certeza?</h3>
      <p class="text-base mt-2 mb-6" style="color: var(--text-muted);">Você está prestes a excluir <strong id="deleteItemName" class="text-red-600"></strong>. Esta ação não pode ser revertida.</p>
      <div class="flex gap-4">
        <button type="button" id="deleteCancelBtn" class="btn-ghost w-full">Cancelar</button>
        <button type="button" id="deleteConfirmBtn" class="btn-danger w-full">
          <span id="deleteSubmitBtnText">Sim, excluir</span>
          <span id="deleteSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A excluir...</span>
        </button>
      </div>
    </div>
  </div>


  <!-- SCRIPTS -->

  <!-- Firebase -->
  <script type="module">
    // Importar funções do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      signInAnonymously,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      collection,
      query,
      where,
      getDocs,
      onSnapshot,
      Timestamp,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // === CONFIGURAÇÃO E INICIALIZAÇÃO ===
    
    // Configuração do Firebase
    // As variáveis __firebase_config e __app_id são injetadas pelo ambiente.
    let firebaseConfig;
    let appId;

    try {
      // Tenta usar as variáveis injetadas
      firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Fallback (plano B) se as variáveis não forem injetadas
      if (!firebaseConfig.apiKey) {
        console.warn("Variáveis de ambiente não encontradas, usando fallback.");
        firebaseConfig = {
          apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
          authDomain: "academylids.firebaseapp.com",
          projectId: "academylids",
          storageBucket: "academylids.firebasestorage.app",
          messagingSenderId: "826478835273",
          appId: "1:826478835273:web:0995d64419276b932cb198",
          measurementId: "G-T2TN7FL590"
        };
        appId = 'default-app-id'; // Use um appId de fallback se necessário
      }

    } catch (e) {
      console.error("Erro ao parsear configuração do Firebase:", e);
      // Fallback crítico em caso de erro de parse
      firebaseConfig = {
        apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
        authDomain: "academylids.firebaseapp.com",
        projectId: "academylids",
        storageBucket: "academylids.firebasestorage.app",
        messagingSenderId: "826478835273",
        appId: "1:826478835273:web:0995d64419276b932cb198",
        measurementId: "G-T2TN7FL590"
      };
      appId = 'default-app-id';
    }

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    // setLogLevel('debug'); // Descomentar para logs detalhados do Firestore

    // Estado da Aplicação
    let currentUser = null;
    let isAdmin = false;
    let localCourses = []; // Cache local de cursos
    let localInstructors = []; // Cache local de instrutores
    let userCheckins = {}; // Cache de check-ins do usuário
    let currentCourseId = null; // ID do curso na página de detalhes
    
    // Referências de Coleções (Baseado nas Regras)
    const coursesCollection = collection(db, `artifacts/${appId}/public/data/courses`);
    const instructorsCollection = collection(db, `artifacts/${appId}/public/data/instructors`);
    const enrollmentsCollection = collection(db, `artifacts/${appId}/public/data/enrollments`);
    const checkinsCollection = collection(db, `artifacts/${appId}/public/data/checkins`);
    const ratingsCollection = collection(db, `artifacts/${appId}/public/data/ratings`);
    const adminsCollection = collection(db, 'admins'); // Coleção raiz

    // === GESTÃO DE ESTADO E UI ===

    // Elementos DOM
    const mainView = document.getElementById('main-view');
    const courseDetailView = document.getElementById('course-detail-view');
    const adminPanelView = document.getElementById('admin-panel-view');
    const coursesListOpen = document.getElementById('courses-list-open');
    const coursesListSoon = document.getElementById('courses-list-soon');
    // REMOVIDO: const instructorsList = document.getElementById('instructors-list');
    
    // Botões de Admin/Logout
    const adminBtnHeader = document.getElementById('adminBtnHeader');
    const logoutBtnHeader = document.getElementById('logoutBtnHeader');
    const adminBtnFooter = document.getElementById('adminBtnFooter');
    const logoutBtnFooter = document.getElementById('logoutBtnFooter');
    const adminLogoutNav = document.getElementById('admin-logout-nav');
    const adminUserEmail = document.getElementById('admin-user-email');

    // Modais
    const modalLogin = document.getElementById('modalLogin');
    const modalEnroll = document.getElementById('modalEnroll');
    const modalEnrollSuccess = document.getElementById('modalEnrollSuccess');
    const modalCheckin = document.getElementById('modalCheckin');
    const modalRating = document.getElementById('modalRating');
    const modalConfirmDelete = document.getElementById('modalConfirmDelete');
    const modalEditCourse = document.getElementById('modalEditCourse');
    const modalEditInstructor = document.getElementById('modalEditInstructor');

    // Função para mostrar/esconder o painel de Admin
    function setAdminUI(isAdmin) {
      if (isAdmin) {
        adminBtnHeader.textContent = "Painel Admin";
        adminBtnHeader.onclick = () => showView('admin');
        adminBtnFooter.textContent = "Painel Admin";
        adminBtnFooter.onclick = () => showView('admin');
        logoutBtnHeader.classList.remove('hidden');
        logoutBtnFooter.classList.remove('hidden');
        adminUserEmail.textContent = currentUser ? currentUser.email : '';
      } else {
        adminBtnHeader.textContent = "Admin";
        adminBtnHeader.onclick = () => _openModal(modalLogin);
        adminBtnFooter.textContent = "Acesso Admin";
        adminBtnFooter.onclick = () => _openModal(modalLogin);
        logoutBtnHeader.classList.add('hidden');
        logoutBtnFooter.classList.add('hidden');
      }
    }
    
    // Função para navegar entre as vistas
    function showView(viewName) {
      mainView.classList.add('hidden');
      courseDetailView.classList.add('hidden');
      adminPanelView.classList.add('hidden');

      if (viewName === 'main') {
        mainView.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else if (viewName === 'detail') {
        courseDetailView.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else if (viewName === 'admin') {
        if (isAdmin) {
          adminPanelView.classList.remove('hidden');
          window.scrollTo(0, 0);
        } else {
          // Se não for admin, volta para a main e abre o login
          mainView.classList.remove('hidden');
          _openModal(modalLogin);
        }
      }
    }

    // Função para mostrar notificações (toast)
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
      toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
      
      toast.innerHTML = `
        <i class="fas ${iconClass} icon"></i>
        <span class="toast-message">${message}</span>
        <button class="toast-close">&times;</button>
      `;
      
      container.appendChild(toast);
      
      // Animação de entrada
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Fechar
      const closeBtn = toast.querySelector('.toast-close');
      const closeToast = () => {
        toast.classList.remove('show');
        // Remover da DOM após a animação
        setTimeout(() => toast.remove(), 500);
      };
      
      closeBtn.onclick = closeToast;
      // Fechar automaticamente
      setTimeout(closeToast, 5000);
    }

    // === AUTENTICAÇÃO ===

    onAuthStateChanged(auth, async (user) => {
      // Tentativa de login com Custom Token (se injetado)
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !auth.currentUser) {
          try {
              console.log("A tentar login com Custom Token...");
              await signInWithCustomToken(auth, __initial_auth_token);
              // O onAuthStateChanged será chamado novamente com o usuário logado
              return; // Saia por agora, deixe o próximo onAuthStateChanged tratar
          } catch (error) {
              console.error("Erro no login com Custom Token:", error);
              // Continua para login anônimo se o token falhar
          }
      }
      
      if (user) {
        // Usuário está logado
        currentUser = user;
        
        if (user.isAnonymous) {
          console.log("Usuário logado anonimamente:", user.uid);
          isAdmin = false;
          setAdminUI(false);
        } else {
          console.log("Usuário logado:", user.email);
          // É um usuário com e-mail, verificar se é admin
          await checkAdminStatus(user.uid);
          setAdminUI(isAdmin);
          if (isAdmin) {
            // Se for admin, carrega dados do painel
            loadAdminDashboardData();
          }
        }
        
        // Carregar dados públicos (cursos, instrutores)
        // Isso agora acontece DEPOIS que a autenticação (anônima ou não) foi estabelecida
        loadCourses();
        loadInstructors(); // Carrega instrutores para o cache
        
        // Carregar dados privados do usuário (check-ins)
        loadUserCheckins(user.uid);
        
      } else {
        // Usuário está deslogado
        console.log("Nenhum usuário logado. A tentar login anônimo...");
        currentUser = null;
        isAdmin = false;
        setAdminUI(false);
        
        // Tentar login anônimo para ter permissão de leitura
        try {
          await signInAnonymously(auth);
          // O onAuthStateChanged será chamado novamente com o usuário anônimo
        } catch (error) {
          console.error("Erro no login anônimo:", error);
          showToast("Não foi possível conectar. Verifique a sua rede.", "error");
        }
      }
    });

    // Função de verificação de Admin
    async function checkAdminStatus(uid) {
      try {
        const adminDocRef = doc(db, 'admins', uid);
        const adminDoc = await getDoc(adminDocRef);
        isAdmin = adminDoc.exists();
        console.log(`Status de Admin para ${uid}: ${isAdmin}`);
      } catch (error) {
        // MUDANÇA: Tratar erro de permissão como "não-admin" sem poluir a consola
        if (error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
          // Isso é esperado se o usuário for um usuário normal (não-admin)
          // ou se as regras de admin ainda não estiverem 100% corretas.
          console.log("Verificação de admin falhou (provavelmente não é admin):", error.message);
        } else {
          console.error("Erro ao verificar status de admin:", error);
        }
        isAdmin = false;
      }
    }

    // Formulário de Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      
      try {
        errorEl.classList.add('hidden');
        await signInWithEmailAndPassword(auth, email, password);
        // Sucesso! O onAuthStateChanged vai tratar o resto
        _closeModal(modalLogin);
        showToast("Login bem-sucedido!", "success");
        // Força a navegação para o painel admin
        showView('admin');
      } catch (error) {
        console.error("Erro de login:", error.code, error.message);
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          errorEl.textContent = "E-mail ou senha inválidos.";
        } else if (error.code === 'auth/operation-not-allowed') {
          errorEl.textContent = "Login por email e senha não está ativado no Firebase.";
        } else {
          errorEl.textContent = "Erro ao fazer login. Tente novamente.";
        }
        errorEl.classList.remove('hidden');
      }
    });
    
    // Botões de Logout
    [logoutBtnHeader, logoutBtnFooter, adminLogoutNav].forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await signOut(auth);
          // Sucesso! O onAuthStateChanged vai tratar o login anônimo
          showView('main');
          showToast("Logout realizado.", "success");
        } catch (error) {
          console.error("Erro ao fazer logout:", error);
          showToast("Erro ao fazer logout.", "error");
        }
      });
    });

    // === CARREGAMENTO DE DADOS PÚBLICOS ===

    // Carregar Cursos
    async function loadCourses() {
      try {
        // Usar onSnapshot para tempo real
        onSnapshot(coursesCollection, (snapshot) => {
          localCourses = []; // Limpa o cache local
          const openCoursesHTML = [];
          const soonCoursesHTML = [];
          
          snapshot.forEach(doc => {
            const course = { id: doc.id, ...doc.data() };
            localCourses.push(course); // Adiciona ao cache
            
            if (course.status === 'aberto') {
              openCoursesHTML.push(renderCourseCard(course));
            } else if (course.status === 'em_breve') {
              soonCoursesHTML.push(renderCourseCardSoon(course));
            }
          });
          
          coursesListOpen.innerHTML = openCoursesHTML.length ? openCoursesHTML.join('') : '<p class="text-center md:col-span-2 text-gray-500">Nenhum curso com vagas abertas no momento.</p>';
          coursesListSoon.innerHTML = soonCoursesHTML.length ? soonCoursesHTML.join('') : '<p class="text-center md:col-span-3 text-gray-500">Nenhum curso previsto por enquanto.</p>';
          
          // Adicionar listeners de clique aos cards
          addCardClickListeners();

        }, (error) => {
          console.error("Erro ao carregar cursos (snapshot):", error);
          coursesListOpen.innerHTML = '<p class="text-center md:col-span-2 text-red-500">Erro ao carregar cursos.</p>';
          coursesListSoon.innerHTML = '<p class="text-center md:col-span-3 text-red-500">Erro ao carregar cursos.</p>';
        });
        
      } catch (error) {
        console.error("Erro ao carregar cursos:", error);
        coursesListOpen.innerHTML = '<p class="text-center md:col-span-2 text-red-500">Erro ao carregar cursos.</p>';
        coursesListSoon.innerHTML = '<p class="text-center md:col-span-3 text-red-500">Erro ao carregar cursos.</p>';
      }
    }
    
    // Carregar Instrutores (apenas para o cache)
    async function loadInstructors() {
      try {
        onSnapshot(instructorsCollection, (snapshot) => {
          localInstructors = [];
          snapshot.forEach(doc => {
            localInstructors.push({ id: doc.id, ...doc.data() });
          });
          console.log("Cache de instrutores atualizado:", localInstructors.length);
        }, (error) => {
          console.error("Erro ao carregar instrutores (snapshot):", error);
        });
      } catch (error) {
        console.error("Erro ao carregar instrutores:", error);
      }
    }
    
    // Carregar Check-ins do Usuário
    async function loadUserCheckins(uid) {
      if (!uid) return;
      try {
        const q = query(checkinsCollection, where("userId", "==", uid));
        onSnapshot(q, (snapshot) => {
          userCheckins = {}; // Limpa cache de check-ins
          snapshot.forEach(doc => {
            const checkin = doc.data();
            userCheckins[checkin.courseId] = true; // Marca que o usuário fez check-in para este curso
          });
          console.log("Check-ins do usuário carregados:", userCheckins);
          
          // Se estivermos na página de detalhes, atualiza os botões
          if (currentCourseId && !mainView.classList.contains('hidden')) {
             const course = localCourses.find(c => c.id === currentCourseId);
             if (course) updateCourseDetailButtons(course);
          }
        });
      } catch (error) {
        console.error("Erro ao carregar check-ins do usuário:", error);
      }
    }
    
    // === RENDERIZAÇÃO (PÁGINA PÚBLICA) ===
    
    // Renderizar Card de Curso (Aberto)
    function renderCourseCard(course) {
      // Aplicar regra 60/30/10 com cores LIDS (Ex: 60% Blue, 30% Teal, 10% Orange)
      // Para simplificar, usamos a cor principal do curso.
      const themeColor = course.themeColor || 'var(--brand-blue)';
      const instructors = (course.instructors || []).map(inst => inst.name).join(', ');

      return `
        <article class="card-3d p-8 reveal stagger-1 cursor-pointer course-card-solid" data-course-id="${course.id}" style="background: ${themeColor}; color: white;">
          <div class="flex items-center gap-3 mb-4">
            <i class="fa-solid ${course.icon || 'fa-graduation-cap'} text-3xl"></i>
            <div>
              <h3 class="text-2xl font-bold">${course.title}</h3>
              <p class="text-sm opacity-90">${course.subtitle}</p>
            </div>
          </div>
          <div class="overflow-hidden rounded-lg mb-4 h-48 w-full">
            <img src="${course.headerOverlayImage || 'https://placehold.co/600x400/000/fff?text=Curso'}" alt="${course.title}" class="w-full h-full object-cover opacity-80" />
          </div>
          <p class="mb-6 opacity-90 h-20 overflow-hidden">${course.summary}</p>
          <div class="mt-auto">
            <p class="text-xs font-semibold opacity-80 mb-2">Instrutores: ${instructors || 'A definir'}</p>
            <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-3 px-4 rounded-lg transition-all"><i class="fa-solid fa-arrow-right mr-2"></i>Ver Detalhes</button>
          </div>
        </article>
      `;
    }
    
    // Renderizar Card de Curso (Em Breve)
    function renderCourseCardSoon(course) {
      const themeColor = course.themeColor || 'var(--brand-purple)';
      const instructors = (course.instructors || []).map(inst => inst.name).join(', ');
      
      return `
        <div class="card-3d p-6 course-card-solid" style="background: ${themeColor};">
          <span class="badge-soon mb-3" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-clock mr-2"></i>Em breve</span>
          <h4 class="font-bold text-lg mb-2">${course.title}</h4>
          <p class="text-sm opacity-90">${instructors || 'A definir'}</p>
        </div>
      `;
    }
    
    // Adicionar listeners de clique aos cards de curso
    function addCardClickListeners() {
      document.querySelectorAll('[data-course-id]').forEach(card => {
        card.onclick = () => {
          const courseId = card.dataset.courseId;
          const course = localCourses.find(c => c.id === courseId);
          if (course) {
            currentCourseId = course.id; // Define o curso atual
            renderCourseDetail(course);
            showView('detail');
          } else {
            console.error("Curso não encontrado no cache local.");
            showToast("Erro ao carregar detalhes do curso.", "error");
          }
        };
      });
    }

    // Renderizar Página de Detalhes do Curso
    function renderCourseDetail(course) {
      const detailsHTML = Object.entries(course.details || {}).map(([key, value]) => `
        <div class="flex items-start">
          <i class="fas fa-check mt-1 mr-3" style="color: ${course.themeColor};"></i>
          <span><strong>${key}:</strong> ${value}</span>
        </div>
      `).join('');

      const instructorsHTML = (course.instructors || []).map(instructor => `
        <div class="flex items-center space-x-4">
          <img class="h-16 w-16 rounded-full object-cover" src="${instructor.image}" alt="${instructor.name}">
          <div>
            <p class="font-bold text-gray-800">${instructor.name}</p>
            <p class="text-sm text-gray-500">${instructor.title}</p>
            ${instructor.bio ? `<p class="text-xs text-gray-400 mt-1">${instructor.bio}</p>` : ''}
          </div>
        </div>
      `).join('');

      const modulesHTML = (course.modules || []).map(module => `
        <div class="bg-gray-50 p-5 rounded-lg border-l-4" style="border-color: ${course.themeColor};">
          <h4 class="font-bold text-lg" style="color: var(--primary);">${module.title}</h4>
          <ul class="mt-3 space-y-2 list-disc list-inside text-gray-600">
            ${(module.topics || []).map(topic => `<li>${topic}</li>`).join('')}
          </ul>
        </div>
      `).join('');

      const practicalActivitiesHTML = (course.practicalActivities || []).map(activity => `
        <div class="bg-white p-5 rounded-lg border border-gray-200">
          <h4 class="font-bold flex items-center text-lg" style="color: ${course.themeColor};"><i class="fas fa-flask mr-3"></i>${activity.title}</h4>
          <p class="text-gray-600 mt-2 pl-8">${activity.description}</p>
        </div>
      `).join('');

      const courseHTML = `
        <section class="relative text-white py-20 md:py-32 overflow-hidden course-detail-hero" style="background: linear-gradient(-45deg, ${course.themeColor}, ${course.themeColorDark || course.themeColor});">
          <div class="absolute inset-0 bg-cover bg-center opacity-20" style="background-image: url('${course.headerOverlayImage}');"></div>
          <div class="container mx-auto px-6 relative">
            <p class="text-lg font-semibold mb-2"><i class="fas ${course.icon} mr-2"></i>Evereste Academy</p>
            <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">${course.title}</h1>
            <p class="mt-2 text-xl md:text-2xl opacity-90">${course.subtitle}</p>
          </div>
        </section>
        <div class="container mx-auto px-6 py-16 course-detail-content">
          <button id="back-to-courses-btn" class="mb-12 font-semibold hover:underline" style="color: ${course.themeColor};">
            <i class="fas fa-arrow-left mr-2"></i>Voltar para todos os cursos
          </button>
          
          <div class="grid lg:grid-cols-3 gap-12">
            <!-- Conteúdo Principal -->
            <div class="lg:col-span-2 space-y-10">
              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Sobre a atividade</h2>
                <p class="text-gray-600 leading-relaxed">${course.fullDescription}</p>
              </div>
              
              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">O que irá aprender</h2>
                <ul class="space-y-3">${(course.learningObjectives || []).map(obj => `<li class="flex items-start"><i class="fas fa-check-circle mt-1 mr-3" style="color: ${course.themeColor};"></i><span>${obj}</span></li>`).join('')}</ul>
              </div>
              
              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Conteúdo Programático</h2>
                <div class="space-y-6">${modulesHTML}</div>
              </div>
              
              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Atividades Práticas</h2>
                <div class="space-y-4">${practicalActivitiesHTML}</div>
              </div>

              <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Requisitos</h2>
                <ul class="space-y-3">${(course.requirements || []).map(req => `<li class="flex items-start"><i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i><span>${req}</span></li>`).join('')}</ul>
              </div>
            </div>
            
            <!-- Sidebar (Ações) -->
            <div class="lg:col-span-1">
              <div class="bg-white p-6 rounded-lg shadow-xl sticky top-24">
                <span class="inline-block text-sm font-semibold mb-4 px-3 py-1 rounded-full" style="background-color: ${course.themeColor}20; color: ${course.themeColor};">Inscrições abertas</span>
                <h3 class="text-xl font-bold mb-4" style="color: var(--primary);">${course.title}</h3>
                <div class="space-y-3 mb-6 text-gray-700">${detailsHTML}</div>
                
                <!-- Botões de Ação do Aluno -->
                <div class="space-y-3">
                  <button id="enroll-btn-detail" class="btn-primary w-full" style="background: ${course.themeColor}; border: none;">
                    <i class="fas fa-paper-plane mr-2"></i>Inscreva-se
                  </button>
                  <button id="checkin-btn-detail" class="btn-primary w-full" style="background: var(--brand-teal); border: none;">
                    <i class="fas fa-user-check mr-2"></i>Fazer Check-in
                  </button>
                  <button id="rating-btn-detail" class="btn-primary w-full btn-disabled">
                    <i class="fas fa-star mr-2"></i>Avaliar Instrutor
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Seção de Instrutores (Abaixo) -->
          <div class="mt-16 pt-8 border-t">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Instrutores</h2>
            <div class="flex flex-col md:flex-row gap-8">${instructorsHTML || '<p>Instrutores a definir.</p>'}</div>
          </div>
          
          <!-- Público-alvo -->
          <div class="mt-16 pt-8 border-t">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Público-alvo</h2>
            <p class="text-gray-600">${course.targetAudience}</p>
          </div>
        </div>
      `;
      
      courseDetailView.innerHTML = courseHTML;
      updateCourseDetailButtons(course); // Atualiza o estado dos botões (ex: desabilitar check-in)
    }
    
    // Atualizar botões da página de detalhes (Check-in, Avaliação, etc.)
    function updateCourseDetailButtons(course) {
      const hasCheckedIn = userCheckins[course.id] === true;
      const isRatingEnabled = course.isRatingEnabled === true;

      const checkinBtn = document.getElementById('checkin-btn-detail');
      const ratingBtn = document.getElementById('rating-btn-detail');
      
      if (hasCheckedIn) {
        checkinBtn.classList.add('btn-disabled');
        checkinBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Check-in Realizado';
        // Se já fez check-in E admin liberou, habilita avaliação
        if (isRatingEnabled) {
          ratingBtn.classList.remove('btn-disabled');
        } else {
          ratingBtn.innerHTML = '<i class="fas fa-star mr-2"></i>Avaliação Fechada';
          ratingBtn.classList.add('btn-disabled');
        }
      } else {
        checkinBtn.classList.remove('btn-disabled');
        checkinBtn.innerHTML = '<i class="fas fa-user-check mr-2"></i>Fazer Check-in';
        // Se não fez check-in, desabilita avaliação
        ratingBtn.classList.add('btn-disabled');
      }
    }


    // === AÇÕES DO ALUNO (MODAIS) ===

    // Abrir modal de Inscrição
    function openEnrollModal(courseId) {
      const course = localCourses.find(c => c.id === courseId);
      if (!course) return;
      
      document.getElementById('enrollCourseName').textContent = course.title;
      document.getElementById('enrollForm').dataset.courseId = course.id;
      document.getElementById('enrollForm').dataset.courseName = course.title;
      document.getElementById('enrollForm').reset();
      document.getElementById('enrollError').classList.add('hidden');
      _openModal(modalEnroll);
    }
    
    // Submeter Inscrição
    document.getElementById('enrollForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showToast("Erro: Usuário não autenticado. Tente recarregar a página.", "error");
        return;
      }
      
      // Mostrar spinner
      document.getElementById('enrollSubmitBtnText').classList.add('hidden');
      document.getElementById('enrollSpinner').classList.remove('hidden');
      document.getElementById('enrollError').classList.add('hidden');
      
      const courseId = e.target.dataset.courseId;
      const courseName = e.target.dataset.courseName;
      const protocol = `EVR-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;
      
      const enrollmentData = {
        userId: currentUser.uid,
        userName: document.getElementById('enrollName').value,
        userEmail: document.getElementById('enrollEmail').value,
        userPhone: document.getElementById('enrollPhone').value,
        userSector: document.getElementById('enrollSector').value,
        courseId: courseId,
        courseName: courseName,
        protocol: protocol,
        createdAt: serverTimestamp(),
        termsImage: document.getElementById('enrollTermImage').checked,
        termsPrivacy: document.getElementById('enrollTermPrivacy').checked,
      };
      
      try {
        await addDoc(enrollmentsCollection, enrollmentData);
        _closeModal(modalEnroll);
        document.getElementById('enrollProtocol').textContent = protocol;
        _openModal(modalEnrollSuccess);
        
      } catch (error) {
        console.error("Erro ao inscrever:", error);
        document.getElementById('enrollError').textContent = `Erro ao processar inscrição: ${error.message}`;
        document.getElementById('enrollError').classList.remove('hidden');
      } finally {
        // Esconder spinner
        document.getElementById('enrollSubmitBtnText').classList.remove('hidden');
        document.getElementById('enrollSpinner').classList.add('hidden');
      }
    });

    // Abrir modal de Check-in (Simplificado)
    function openCheckinModal(courseId) {
      if (!currentUser) {
        showToast("Você precisa estar logado para fazer check-in.", "error");
        return;
      }
      document.getElementById('checkinForm').dataset.courseId = courseId;
      document.getElementById('checkinError').classList.add('hidden');
      _openModal(modalCheckin);
    }
    
    // Submeter Check-in (Simplificado)
    document.getElementById('checkinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btnText = document.getElementById('checkinSubmitBtnText');
      const spinner = document.getElementById('checkinSpinner');
      const errorEl = document.getElementById('checkinError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      errorEl.classList.add('hidden');
      
      const courseId = e.target.dataset.courseId;
      const userId = currentUser.uid;
      
      try {
        // ID único para o documento de check-in
        const checkinId = `${userId}_${courseId}`;
        const checkinRef = doc(db, `artifacts/${appId}/public/data/checkins`, checkinId);
        
        await setDoc(checkinRef, {
          userId: userId,
          courseId: courseId,
          createdAt: serverTimestamp()
        });
        
        // Atualiza o cache local
        userCheckins[courseId] = true;
        // Atualiza os botões na página
        const course = localCourses.find(c => c.id === courseId);
        if (course) updateCourseDetailButtons(course);
        
        _closeModal(modalCheckin);
        showToast("Check-in realizado com sucesso!", "success");
        
      } catch (error) {
        console.error("Erro ao fazer check-in:", error);
        errorEl.textContent = `Erro ao processar: ${error.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    });
    
    // Abrir modal de Avaliação
    function openRatingModal(courseId) {
      const course = localCourses.find(c => c.id === courseId);
      if (!course || !currentUser) return;

      const select = document.getElementById('ratingInstructorSelect');
      select.innerHTML = '<option value="">Selecione um instrutor</option>';
      (course.instructors || []).forEach(inst => {
        select.innerHTML += `<option value="${inst.name}">${inst.name}</option>`;
      });
      
      document.getElementById('ratingForm').dataset.courseId = course.id;
      document.getElementById('ratingForm').reset();
      // Resetar estrelas
      document.querySelectorAll('#ratingStars .fa-star').forEach(star => {
        star.style.color = '#cbd5e1'; // Cor cinza
      });
      document.getElementById('ratingValue').value = "0";
      
      _openModal(modalRating);
    }
    
    // Lógica das Estrelas de Avaliação
    document.getElementById('ratingStars').addEventListener('click', (e) => {
      if (e.target.matches('.fa-star')) {
        const rating = e.target.dataset.value;
        document.getElementById('ratingValue').value = rating;
        
        document.querySelectorAll('#ratingStars .fa-star').forEach(star => {
          star.style.color = star.dataset.value <= rating ? '#f59e0b' : '#cbd5e1';
        });
      }
    });
    
    // Submeter Avaliação
    document.getElementById('ratingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btnText = document.getElementById('ratingSubmitBtnText');
      const spinner = document.getElementById('ratingSpinner');
      const errorEl = document.getElementById('ratingError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      errorEl.classList.add('hidden');
      
      const ratingData = {
        userId: currentUser.uid,
        courseId: e.target.dataset.courseId,
        instructorName: document.getElementById('ratingInstructorSelect').value,
        rating: parseInt(document.getElementById('ratingValue').value),
        comment: document.getElementById('ratingComment').value,
        createdAt: serverTimestamp()
      };
      
      if (ratingData.rating === 0) {
        errorEl.textContent = "Por favor, selecione de 1 a 5 estrelas.";
        errorEl.classList.remove('hidden');
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        return;
      }

      try {
        await addDoc(ratingsCollection, ratingData);
        _closeModal(modalRating);
        showToast("Avaliação enviada com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao enviar avaliação:", error);
        errorEl.textContent = "Erro ao enviar. Tente novamente.";
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    });
    

    // === PAINEL DE ADMINISTRAÇÃO ===
    
    // Navegação do Painel Admin
    document.getElementById('admin-nav').addEventListener('click', (e) => {
      const link = e.target.closest('.admin-nav-link');
      if (link && link.dataset.target) {
        e.preventDefault();
        
        // Atualiza links ativos
        document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        // Mostra seção correta
        document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(link.dataset.target).classList.remove('hidden');
        
        // Carrega dados da seção
        switch(link.dataset.target) {
          case 'admin-dashboard': loadAdminDashboardData(); break;
          case 'admin-cursos': loadAdminCourses(); break;
          case 'admin-matriculas': loadAdminEnrollments(); break;
          case 'admin-instrutores': loadAdminInstructorsAdmin(); break;
        }
      }
    });
    
    let enrollmentsChartInstance = null;
    
    // Carregar Dados do Dashboard
    async function loadAdminDashboardData() {
      // Carregar Stats
      try {
        const enrollmentsSnap = await getDocs(enrollmentsCollection);
        document.getElementById('stats-total-enrollments').textContent = enrollmentsSnap.size;
        
        const checkinsSnap = await getDocs(checkinsCollection);
        document.getElementById('stats-total-checkins').textContent = checkinsSnap.size;
        
        // Renderizar Gráfico
        renderEnrollmentsChart(enrollmentsSnap.docs.map(d => d.data()));
        
      } catch (e) { console.error("Erro ao carregar stats:", e); }
    }
    
    // Renderizar Gráfico de Matrículas
    function renderEnrollmentsChart(enrollments) {
      const ctx = document.getElementById('enrollmentsChart').getContext('2d');
      
      // Agrupar matrículas por dia
      const enrollmentsByDay = enrollments.reduce((acc, curr) => {
        if (curr.createdAt) {
          const date = curr.createdAt.toDate().toLocaleDateString('pt-BR');
          acc[date] = (acc[date] || 0) + 1;
        }
        return acc;
      }, {});
      
      const labels = Object.keys(enrollmentsByDay);
      const data = Object.values(enrollmentsByDay);
      
      if (enrollmentsChartInstance) {
        enrollmentsChartInstance.destroy(); // Destrói gráfico anterior
      }
      
      enrollmentsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Matrículas por Dia',
            data: data,
            borderColor: 'rgba(0, 102, 204, 1)',
            backgroundColor: 'rgba(0, 102, 204, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                 stepSize: 1 // Garante números inteiros
              }
            }
          }
        }
      });
    }

    // Carregar Tabela de Cursos (Admin)
    function loadAdminCourses() {
      const tbody = document.getElementById('admin-courses-table-body');
      tbody.innerHTML = '<tr><td colspan="5">A carregar...</td></tr>';
      
      // Filtra localmente para mostrar apenas 'aberto' e 'em_breve'
      const activeCourses = localCourses.filter(c => c.status === 'aberto' || c.status === 'em_breve');
      
      if (activeCourses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Nenhum curso ativo ou "em breve" encontrado.</td></tr>';
        return;
      }
      
      tbody.innerHTML = activeCourses.map(course => {
        const instructors = (course.instructors || []).map(inst => inst.name).join(', ');
        const statusBadge = course.status === 'aberto' 
          ? `<span class="text-xs font-medium px-2 py-1 rounded-full bg-green-100 text-green-800">Aberto</span>`
          : `<span class="text-xs font-medium px-2 py-1 rounded-full bg-yellow-100 text-yellow-800">Em Breve</span>`;
          
        return `
          <tr>
            <td>${course.title}</td>
            <td>${statusBadge}</td>
            <td>${instructors || 'N/A'}</td>
            <td>${course.details?.Data || 'TBA'}</td>
            <td class="actions">
              <button class="btn-edit !px-3 !py-2" onclick="window.openEditCourseModal('${course.id}')"><i class="fas fa-pencil"></i></button>
              <button class="btn-danger !px-3 !py-2" onclick="window.openDeleteModal('course', '${course.id}', '${course.title}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // Carregar Tabela de Matrículas (Admin)
    function loadAdminEnrollments() {
      const tbody = document.getElementById('admin-enrollments-table-body');
      tbody.innerHTML = '<tr><td colspan="7">A carregar...</td></tr>';
      
      onSnapshot(enrollmentsCollection, (snapshot) => {
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="7">Nenhuma matrícula encontrada.</td></tr>';
          return;
        }
        
        tbody.innerHTML = snapshot.docs.map(doc => {
          const e = doc.data();
          return `
            <tr>
              <td>${e.protocol}</td>
              <td>${e.userName}</td>
              <td>${e.userEmail}</td>
              <td>${e.courseName}</td>
              <td>${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pt-BR') : 'N/A'}</td>
              <td>${e.userSector}</td>
              <td class="actions">
                <button class="btn-danger !px-3 !py-2" onclick="window.openDeleteModal('enrollment', '${doc.id}', 'Matrícula de ${e.userName}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        }).join('');
      }, (error) => {
        console.error("Erro ao carregar matrículas:", error);
        tbody.innerHTML = `<tr><td colspan="7">Erro ao carregar: ${error.message}</td></tr>`;
      });
    }

    // Carregar Tabela de Instrutores (Admin)
    function loadAdminInstructorsAdmin() {
      const tbody = document.getElementById('admin-instructors-table-body');
      tbody.innerHTML = '<tr><td colspan="4">A carregar...</td></tr>';
      
      onSnapshot(instructorsCollection, (snapshot) => {
        if (snapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="4">Nenhum instrutor cadastrado.</td></tr>';
          return;
        }
        
        tbody.innerHTML = snapshot.docs.map(doc => {
          const inst = doc.data();
          return `
            <tr>
              <td><img src="${inst.image}" alt="${inst.name}" class="w-10 h-10 rounded-full object-cover"></td>
              <td>${inst.name}</td>
              <td>${inst.title}</td>
              <td class="actions">
                <button class="btn-edit !px-3 !py-2" onclick="window.openEditInstructorModal('${doc.id}')"><i class="fas fa-pencil"></i></button>
                <button class="btn-danger !px-3 !py-2" onclick="window.openDeleteModal('instructor', '${doc.id}', '${inst.name}')"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
        }).join('');
      }, (error) => {
        console.error("Erro ao carregar instrutores (admin):", error);
        tbody.innerHTML = `<tr><td colspan="4">Erro ao carregar: ${error.message}</td></tr>`;
      });
    }

    // --- ADMIN: ABRIR MODAIS ---
    
    // Abrir Modal de Curso (Novo)
    document.getElementById('admin-add-course-btn').addEventListener('click', () => {
      document.getElementById('courseForm').reset();
      document.getElementById('courseId').value = '';
      document.getElementById('modalCourseTitle').textContent = "Adicionar Novo Curso";
      document.getElementById('courseFormError').classList.add('hidden');
      
      // Limpa e popula instrutores
      populateInstructorChecklist([]);
      
      // Limpa JSON fields
      document.getElementById('courseDetails').value = '{\n  "Data": "TBA",\n  "Carga": "4h",\n  "Modalidade": "Presencial"\n}';
      document.getElementById('courseLearningObjectives').value = '[\n  "Objetivo 1",\n  "Objetivo 2"\n]';
      document.getElementById('courseRequirements').value = '[\n  "Requisito 1"\n]';
      document.getElementById('courseModules').value = '[\n  {\n    "title": "Módulo 1",\n    "topics": ["Tópico 1", "Tópico 2"]\n  }\n]';
      document.getElementById('coursePracticalActivities').value = '[\n  {\n    "title": "Atividade 1",\n    "description": "Descrição da atividade."\n  }\n]';
      document.getElementById('courseIsRatingEnabled').checked = false;
      
      _openModal(modalEditCourse);
    });

    // Abrir Modal de Curso (Editar)
    window.openEditCourseModal = (id) => {
      const course = localCourses.find(c => c.id === id);
      if (!course) {
        showToast("Erro: Curso não encontrado.", "error");
        return;
      }
      
      document.getElementById('courseForm').reset();
      document.getElementById('courseFormError').classList.add('hidden');
      document.getElementById('modalCourseTitle').textContent = "Editar Curso";
      
      // Preenche campos
      document.getElementById('courseId').value = course.id;
      document.getElementById('courseTitle').value = course.title || '';
      document.getElementById('courseSubtitle').value = course.subtitle || '';
      document.getElementById('courseThemeColor').value = course.themeColor || '';
      document.getElementById('courseIcon').value = course.icon || '';
      document.getElementById('courseStatus').value = course.status || 'fechado';
      document.getElementById('courseHeaderImage').value = course.headerOverlayImage || '';
      document.getElementById('courseSummary').value = course.summary || '';
      document.getElementById('courseFullDescription').value = course.fullDescription || '';
      document.getElementById('courseTargetAudience').value = course.targetAudience || '';
      document.getElementById('courseIsRatingEnabled').checked = course.isRatingEnabled === true;
      
      // Preenche JSON fields (com formatação)
      document.getElementById('courseDetails').value = JSON.stringify(course.details || {}, null, 2);
      document.getElementById('courseLearningObjectives').value = JSON.stringify(course.learningObjectives || [], null, 2);
      document.getElementById('courseRequirements').value = JSON.stringify(course.requirements || [], null, 2);
      document.getElementById('courseModules').value = JSON.stringify(course.modules || [], null, 2);
      document.getElementById('coursePracticalActivities').value = JSON.stringify(course.practicalActivities || [], null, 2);
      
      // Popula e marca instrutores
      const courseInstructorIds = (course.instructors || []).map(inst => inst.id);
      populateInstructorChecklist(courseInstructorIds);
      
      _openModal(modalEditCourse);
    }
    
    // Abrir Modal de Instrutor (Novo)
    document.getElementById('admin-add-instructor-btn').addEventListener('click', () => {
      document.getElementById('instructorForm').reset();
      document.getElementById('instructorId').value = '';
      document.getElementById('modalInstructorTitle').textContent = "Adicionar Novo Instrutor";
      document.getElementById('instructorFormError').classList.add('hidden');
      _openModal(modalEditInstructor);
    });
    
    // Abrir Modal de Instrutor (Editar)
    window.openEditInstructorModal = (id) => {
      const instructor = localInstructors.find(inst => inst.id === id);
      if (!instructor) {
        showToast("Erro: Instrutor não encontrado.", "error");
        return;
      }
      
      document.getElementById('instructorForm').reset();
      document.getElementById('instructorFormError').classList.add('hidden');
      document.getElementById('modalInstructorTitle').textContent = "Editar Instrutor";
      
      document.getElementById('instructorId').value = instructor.id;
      document.getElementById('instructorName').value = instructor.name || '';
      document.getElementById('instructorTitle').value = instructor.title || '';
      document.getElementById('instructorImage').value = instructor.image || '';
      document.getElementById('instructorBio').value = instructor.bio || '';
      
      _openModal(modalEditInstructor);
    }
    
    // Abrir Modal de Confirmação de Exclusão
    let deleteHandler = null; // Armazena a função de exclusão
    window.openDeleteModal = (type, id, name) => {
      // Limpa handler anterior
      const deleteBtn = document.getElementById('deleteConfirmBtn');
      deleteBtn.removeEventListener('click', deleteHandler);
      
      document.getElementById('deleteItemName').textContent = `"${name}"`;
      
      // Define o novo handler
      deleteHandler = async () => {
        const btnText = document.getElementById('deleteSubmitBtnText');
        const spinner = document.getElementById('deleteSpinner');
        btnText.classList.add('hidden');
        spinner.classList.remove('hidden');
        
        try {
          let docRef;
          if (type === 'course') {
            docRef = doc(db, `artifacts/${appId}/public/data/courses`, id);
          } else if (type === 'instructor') {
            docRef = doc(db, `artifacts/${appId}/public/data/instructors`, id);
          } else if (type === 'enrollment') {
            docRef = doc(db, `artifacts/${appId}/public/data/enrollments`, id);
          } else {
            throw new Error("Tipo de exclusão desconhecido.");
          }
          
          await deleteDoc(docRef);
          showToast(`${name} foi excluído com sucesso.`, "success");
          _closeModal(modalConfirmDelete);
          
        } catch (error) {
          console.error("Erro ao excluir:", error);
          showToast(`Erro ao excluir: ${error.message}`, "error");
        } finally {
          btnText.classList.remove('hidden');
          spinner.classList.add('hidden');
        }
      };
      
      deleteBtn.addEventListener('click', deleteHandler);
      _openModal(modalConfirmDelete);
    }

    
    // --- ADMIN: SALVAR DADOS (FORMULÁRIOS) ---
    
    // Salvar Curso (Adicionar ou Editar)
    document.getElementById('courseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btnText = document.getElementById('courseSubmitBtnText');
      const spinner = document.getElementById('courseFormSpinner');
      const errorEl = document.getElementById('courseFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      errorEl.classList.add('hidden');
      
      let courseId = document.getElementById('courseId').value;
      const isNew = !courseId;
      
      // 1. Validar e Parsear JSON
      let courseData;
      try {
        // Coleta instrutores selecionados
        const selectedInstructorIds = Array.from(document.querySelectorAll('#courseInstructorsList input:checked')).map(cb => cb.value);
        const selectedInstructors = localInstructors
          .filter(inst => selectedInstructorIds.includes(inst.id))
          .map(inst => ({ // Salva apenas os dados necessários
            id: inst.id,
            name: inst.name,
            title: inst.title,
            image: inst.image,
            bio: inst.bio || ''
          }));
          
        courseData = {
          title: document.getElementById('courseTitle').value,
          subtitle: document.getElementById('courseSubtitle').value,
          themeColor: document.getElementById('courseThemeColor').value,
          icon: document.getElementById('courseIcon').value,
          status: document.getElementById('courseStatus').value,
          headerOverlayImage: document.getElementById('courseHeaderImage').value,
          summary: document.getElementById('courseSummary').value,
          fullDescription: document.getElementById('courseFullDescription').value,
          targetAudience: document.getElementById('courseTargetAudience').value,
          isRatingEnabled: document.getElementById('courseIsRatingEnabled').checked,
          
          // Parsear campos JSON
          details: JSON.parse(document.getElementById('courseDetails').value),
          learningObjectives: JSON.parse(document.getElementById('courseLearningObjectives').value),
          requirements: JSON.parse(document.getElementById('courseRequirements').value),
          modules: JSON.parse(document.getElementById('courseModules').value),
          practicalActivities: JSON.parse(document.getElementById('coursePracticalActivities').value),
          
          // Adicionar instrutores
          instructors: selectedInstructors
        };

      } catch (jsonError) {
        console.error("Erro de JSON:", jsonError);
        errorEl.textContent = `Erro de Formato: O formato JSON em um dos campos (Detalhes, Objetivos, etc.) está inválido. ${jsonError.message}`;
        errorEl.classList.remove('hidden');
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        return;
      }
      
      // 2. Salvar no Banco de Dados
      try {
        let docRef;
        if (isNew) {
          // Criar novo (addDoc)
          docRef = await addDoc(coursesCollection, courseData);
          courseId = docRef.id; // Pega o ID do novo documento
        } else {
          // Atualizar (setDoc)
          docRef = doc(db, `artifacts/${appId}/public/data/courses`, courseId);
          await setDoc(docRef, courseData, { merge: true }); // Merge para não sobrescrever campos não gerenciados
        }
        
        showToast(`Curso "${courseData.title}" salvo com sucesso!`, "success");
        _closeModal(modalEditCourse);
        
      } catch (saveError) {
        console.error("Erro ao salvar curso:", saveError);
        errorEl.textContent = `Erro ao Salvar: Não foi possível salvar no banco de dados. ${saveError.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    });

    // Salvar Instrutor (Adicionar ou Editar)
    document.getElementById('instructorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btnText = document.getElementById('instructorSubmitBtnText');
      const spinner = document.getElementById('instructorFormSpinner');
      const errorEl = document.getElementById('instructorFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      errorEl.classList.add('hidden');
      
      const instructorId = document.getElementById('instructorId').value;
      const isNew = !instructorId;
      
      const instructorData = {
        name: document.getElementById('instructorName').value,
        title: document.getElementById('instructorTitle').value,
        image: document.getElementById('instructorImage').value,
        bio: document.getElementById('instructorBio').value
      };
      
      try {
        let docRef;
        if (isNew) {
          docRef = await addDoc(instructorsCollection, instructorData);
        } else {
          docRef = doc(db, `artifacts/${appId}/public/data/instructors`, instructorId);
          await setDoc(docRef, instructorData, { merge: true });
        }
        
        showToast(`Instrutor "${instructorData.name}" salvo com sucesso!`, "success");
        _closeModal(modalEditInstructor);
        
      } catch (error) {
        console.error("Erro ao salvar instrutor:", error);
        errorEl.textContent = `Erro ao salvar: ${error.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    });
    
    // --- Funções Helper do Construtor de Formulário ---
    
    // Popula a lista de checkboxes de instrutores no modal de curso
    function populateInstructorChecklist(selectedIds = []) {
      const container = document.getElementById('courseInstructorsList');
      if (localInstructors.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 p-2">Nenhum instrutor cadastrado. Adicione instrutores na aba "Instrutores" primeiro.</p>';
        return;
      }
      
      container.innerHTML = localInstructors.map(inst => {
        const isChecked = selectedIds.includes(inst.id);
        return `
          <label>
            <input type="checkbox" value="${inst.id}" ${isChecked ? 'checked' : ''}>
            <img src="${inst.image}" class="w-6 h-6 rounded-full object-cover">
            <span>${inst.name}</span>
          </label>
        `;
      }).join('');
    }

    // --- POPULAR DADOS INICIAIS (Helper Admin) ---
    document.getElementById('populate-db-btn').addEventListener('click', async () => {
      if (!isAdmin) {
        showToast("Apenas admins podem fazer isso.", "error");
        return;
      }
      if (!confirm("Tem certeza que deseja popular o banco de dados? Isso pode sobrescrever dados existentes.")) {
        return;
      }
      
      const batch = writeBatch(db);
      
      // Dados Iniciais (Cursos)
      const initialCourses = [
        {
          id: "fotografia",
          themeColor: "#FFC107",
          themeColorDark: "#E6A700",
          headerOverlayImage: "https://i.postimg.cc/3rLTy2xn/medium-shot-people-with-camera.jpg",
          icon: "fa-camera-retro",
          title: "Workshop de Fotografia",
          subtitle: "O Olhar que Conecta Histórias",
          summary: "Aprenda a capturar a essência dos nossos projetos com sensibilidade e técnica. Este workshop oferece as ferramentas para transformar o registo de atividades institucionais.",
          fullDescription: "No Instituto Evereste, cada imagem conta uma parte da nossa história. Este workshop é um convite para desenvolver a sua percepção e criatividade, capacitando-o a registar os nossos eventos e projetos com a qualidade e profissionalismo que eles merecem. Mais do que técnica, aprenderá a contar histórias que conectam e inspiram através das suas lentes.",
          learningObjectives: [
            "Introduzir conceitos básicos de fotografia (composição, iluminação, enquadramento).",
            "Desenvolver habilidades práticas em fotografia com câmaras e celulares.",
            "Capacitar para o registo de eventos e projetos com qualidade profissional.",
            "Promover a criatividade e a percepção estética.",
          ],
          modules: [
            { title: "Módulo 1: Fundamentos e Equipamento", topics: ["Introdução à história e ao impacto da fotografia.", "Dominando o corpo da câmera: visor, obturador, diafragma e fotômetro.", "Entendendo ISO, lentes e o uso do flash.", "Controle de exposição e balanço de branco."] },
            { title: "Módulo 2: Composição e Iluminação", topics: ["A arte do enquadramento: planos, ângulos e lados.", "Trabalhando com a luz: compreendendo luz dura e luz suave.", "Princípios de composição de imagens: regra dos terços, formas e cores.", "Criando profundidade e perspectiva nas suas fotos."] },
            { title: "Módulo 3: Edição e Pós-Produção", topics: ["Introdução à edição e pós-produção no Lightroom.", "Análise do histograma e correção de cores.", "Definindo a intenção narrativa da sua fotografia.", "Exercícios práticos para aplicar todos os conceitos."] }
          ],
          requirements: ["Não são necessários pré-requisitos, apenas vontade de aprender.", "Incentivamos a trazer o seu próprio smartphone ou câmara."],
          targetAudience: "O Curso de Fotografia é voltado para pessoas que desejam explorar o poder da imagem como forma de expressão, comunicação e transformação social. Destina-se a jovens, estudantes, profissionais da área criativa, comunicadores e entusiastas da fotografia, que buscam desenvolver um olhar técnico e artístico para capturar histórias, emoções e realidades por meio da lente.",
          instructors: [], // Será preenchido abaixo
          details: { "Data": "28 de Outubro de 2025", "Horário": "08:30h - 12:15h", "Carga": "4 horas", "Modalidade": "Presencial e Online" },
          practicalActivities: [
            { title: "Exercício de Teste: Contando uma História", description: "Em duplas, os participantes tiram 3 fotos um do outro para se acostumarem com os equipamentos e explorarem a narrativa visual." },
            { title: "Exercício de Conhecimento: Dominando a Luz", description: "Os participantes tiram 3-5 fotos com diferentes tipos de iluminação para entender na prática os conceitos de luz, sombra e intencionalidade." },
            { title: "Exercício Prático Transversal: A Evolução", description: "As duplas refazem as fotos do primeiro exercício, agora aplicando todos os conceitos aprendidos, para comparar e observar a sua evolução." }
          ],
          status: "aberto",
          isRatingEnabled: true
        },
        {
          id: "ia",
          themeColor: "#4CAF50",
          themeColorDark: "#388E3C",
          headerOverlayImage: "https://i.postimg.cc/bv25v2BZ/relat-rio-1.png",
          icon: "fa-brain",
          title: "IA Aplicada à Análise de Dados",
          subtitle: "Do Relatório ao Insight",
          summary: "Transforme relatórios e dados brutos em dashboards web interativos e de alto impacto. Capacite-se para tomar decisões estratégicas com mais clareza e agilidade.",
          fullDescription: "Num mundo movido por dados, a capacidade de extrair insights rápidos é um superpoder. Com o 'Método Evereste Ágil', este curso vai desmistificar a IA e dar-lhe a autonomia para converter números complexos em apresentações dinâmicas e convincentes. Deixe de ser um espectador de relatórios e torne-se um protagonista na tomada de decisões estratégicas da nossa instituição.",
          learningObjectives: [
            "Formular prompts eficazes no Gemini para gerar códigos de dashboards.",
            "Publicar um dashboard interativo na web utilizando o GitHub Pages.",
            "Estruturar uma apresentação de resultados de alto impacto.",
            "Adotar uma cultura de análise de dados ágil e orientada à ação.",
          ],
          modules: [
            { title: "Módulo 1: Fundamentos e Geração de Código", topics: ["Os 3 pilares do Método Evereste Ágil.", "Introdução às ferramentas de inteligência artificial.", "O desafio da gestão moderna na análise de resultados.", "Oficina Prática: Construindo o prompt perfeito para o seu dashboard."] },
            { title: "Módulo 2: Publicação e Interatividade", topics: ["Desmistificando o GitHub: repositórios e o serviço GitHub Pages.", "Oficina Prática: Publicando o seu primeiro dashboard interativo na web.", "Análise e refinamento: como fazer pequenas alterações e atualizar o seu projeto."] },
            { title: "Módulo 3: Apresentação Estratégica e Encerramento", topics: ["Técnicas para apresentar resultados usando um dashboard dinâmico.", "Simulação de apresentação para a diretoria.", "Próximos passos para aplicar o método no dia a dia.", "Transformando a cultura de apresentação de resultados."] }
          ],
          requirements: ["É indispensável ter um notebook para participar nas atividades práticas.", "Computador com acesso à internet.", "Conta Google para acesso ao Gemini.", "Conta gratuita no ChatGPT.", "Conta no GitHub (pode ser criada durante o curso)."],
          targetAudience: "Para todos os colaboradores, entusiastas de tecnologia e qualquer pessoa curiosa sobre o poder da inteligência artificial para simplificar tarefas. Não é necessário conhecimento prévio, apenas vontade de inovar.",
          instructors: [], // Será preenchido abaixo
          details: { "Data": "06 de Novembro de 2025", "Carga": "4 horas", "Modalidade": "Presencial ou Online", "Público": "Livre" },
          practicalActivities: [
            { title: "Oficina Prática 1: O Prompt Perfeito", description: "Os participantes recebem um relatório de exemplo e, com orientação, devem construir um prompt detalhado no Gemini para solicitar um dashboard." },
            { title: "Oficina Prática 2: O Seu Primeiro Dashboard no Ar", description: "Passo a passo guiado onde cada participante irá criar um repositório no GitHub, copiar o código do Gemini e publicar o seu dashboard online." },
            { title: "Simulação de Apresentação", description: "Voluntários apresentam o seu dashboard como se estivessem a falar para a diretoria, recebendo feedback construtivo." }
          ],
          status: "aberto",
          isRatingEnabled: false
        }
      ];
      
      // Dados Iniciais (Instrutores)
      const initialInstructors = {
        "marllon": { id: "marllon", name: "Marllon Costa", title: "Técnico em TI | Designer | Marketing | Inovação e IA", image: "https://i.postimg.cc/sxm4TVvF/IMG-9781.jpg", bio: "Designer gráfico, graduando em marketing e autodidata em Inovação e IA. Trabalha e estuda sobre IA desde 2021." },
        "vinicius": { id: "vinicius", name: "Vinícius Sena", title: "Fotógrafo Documental/Eventos | Animação", image: "https://i.postimg.cc/bw7kHG3D/vinicius.jpg", bio: "Formado em Animação, estudante e entusiasta de fotografia desde 2019, trabalha com pós-produção de imagens." },
        "bruno": { id: "bruno", name: "Bruno Diogo", title: "Supervisor de Marketing | Designer | UX & UI | Fotografia", image: "https://i.postimg.cc/yNhgmLJK/IMG-7311.avif", bio: "Supervisor de Marketing e Mídias Visuais | Designer Gráfico e Digital | UX & UI | 📸 Fotografia" },
        "keven": { id: "keven", name: "Keven Menezes", title: "Analista de TI | Designer Gráfico | Motion Design", image: "https://i.postimg.cc/fTgkcmpP/Whats-App-Image-2025-10-27-at-12-11-25.jpg", bio: "Formado em Design Gráfico e possui mais de 5 anos de experiência em criação visual e motion design." },
        "deyse": { id: "deyse", name: "Deyse Pereira", title: "Estrategista em Comunicação, Design e Gestão", image: "https://i.postimg.cc/T1sL3bXz/IMG-7381-jpg.png", bio: "Mestre em Design de Artefatos Digitais, pós-graduanda em Gestão de Projetos e Metodologias Ágeis." }
      };
      
      // Adiciona instrutores aos cursos
      initialCourses[0].instructors = [initialInstructors.bruno, initialInstructors.vinicius]; // Fotografia
      initialCourses[1].instructors = [initialInstructors.marllon]; // IA
      
      // Adiciona Cursos ao Batch
      initialCourses.forEach(course => {
        const docRef = doc(db, `artifacts/${appId}/public/data/courses`, course.id);
        batch.set(docRef, course);
      });
      
      // Adiciona Instrutores ao Batch
      Object.values(initialInstructors).forEach(inst => {
        const docRef = doc(db, `artifacts/${appId}/public/data/instructors`, inst.id);
        batch.set(docRef, inst);
      });
      
      try {
        await batch.commit();
        showToast("Banco de dados populado com sucesso!", "success");
        // Recarrega os dados locais
        loadCourses();
        loadInstructors();
      } catch (error) {
        console.error("Erro ao popular banco de dados:", error);
        showToast(`Erro ao popular: ${error.message}`, "error");
      }
    });

    // === INICIALIZAÇÃO E EVENT LISTENERS GLOBAIS ===

    // Função helper para abrir modal
    function _openModal(modal) {
      modal.classList.add('show');
    }
    
    // Função helper para fechar modal
    function _closeModal(modal) {
      modal.classList.remove('show');
    }
    
    // Fechar todos os modais
    function closeAllModals() {
      document.querySelectorAll('.modal-backdrop').forEach(modal => _closeModal(modal));
    }
    
    // Fechar ao clicar no backdrop
    document.querySelectorAll('.modal-backdrop').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          _closeModal(modal);
        }
      });
    });
    
    // Fechar com botões de fechar
    document.getElementById('closeLogin')?.addEventListener('click', () => _closeModal(modalLogin));
    document.getElementById('closeEnroll')?.addEventListener('click', () => _closeModal(modalEnroll));
    document.getElementById('closeEnrollSuccess')?.addEventListener('click', () => _closeModal(modalEnrollSuccess));
    document.getElementById('closeCheckin')?.addEventListener('click', () => _closeModal(modalCheckin));
    document.getElementById('closeRating')?.addEventListener('click', () => _closeModal(modalRating));
    document.getElementById('closeEditCourse')?.addEventListener('click', () => _closeModal(modalEditCourse));
    document.getElementById('courseFormCancel')?.addEventListener('click', () => _closeModal(modalEditCourse));
    document.getElementById('closeEditInstructor')?.addEventListener('click', () => _closeModal(modalEditInstructor));
    document.getElementById('instructorFormCancel')?.addEventListener('click', () => _closeModal(modalEditInstructor));
    document.getElementById('deleteCancelBtn')?.addEventListener('click', () => _closeModal(modalConfirmDelete));
    
    
    // Animação de Scroll (Reveal)
    const io = new IntersectionObserver((entries) => {
      entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('show'); });
    }, { threshold: 0.1 });
    document.querySelectorAll('.reveal').forEach(el => io.observe(el));
    
    // Logo click
    document.getElementById('logo-link').addEventListener('click', (e) => {
      e.preventDefault();
      showView('main');
    });

    // Event listeners da Página de Detalhes (usando delegação de eventos)
    courseDetailView.addEventListener('click', (e) => {
      const targetId = e.target.closest('button')?.id;
      if (targetId === 'back-to-courses-btn') {
        currentCourseId = null; // Limpa o curso atual
        showView('main');
      } else if (targetId === 'enroll-btn-detail') {
        openEnrollModal(currentCourseId);
      } else if (targetId === 'checkin-btn-detail') {
        openCheckinModal(currentCourseId);
      } else if (targetId === 'rating-btn-detail') {
        openRatingModal(currentCourseId);
      }
    });

    // Scroll Progress
    const scrollProgress = document.getElementById('scroll-progress');
    window.addEventListener('scroll', () => {
      const h = document.documentElement;
      const st = h.scrollTop || document.body.scrollTop;
      const sh = h.scrollHeight || document.body.scrollHeight;
      const percent = (st / (sh - h.clientHeight)) * 100;
      scrollProgress.style.width = percent + '%';
    });

    // Header Scroll
    const header = document.getElementById('header');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 10) header.classList.add('header-scrolled');
      else header.classList.remove('header-scrolled');
    });

    // Particles
    const particles = document.getElementById('particles');
    if (particles) {
      const createParticle = () => {
        const s = document.createElement('span');
        s.style.left = Math.random() * 100 + 'vw';
        s.style.bottom = '-10px';
        s.style.width = (Math.random() * 2 + 1) + 'px';
        s.style.height = (Math.random() * 2 + 1) + 'px';
        s.style.animationDelay = Math.random() * 8 + 's';
        particles.appendChild(s);
        setTimeout(() => s.remove(), 14000);
      };
      for (let i = 0; i < 60; i++) createParticle();
      setInterval(createParticle, 600);
    }
    
  </script>
</body>
</html>

