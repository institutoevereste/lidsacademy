<!DOCTYPE html>
<html lang="pt-pt" class=""> <!-- Classe 'dark' será alternada aqui -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evereste Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos do dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      /* Paleta Principal */
      --primary: #0066cc;
      --primary-dark: #004c99;
      --primary-light: #3385d6;
      --accent: #ff6b35;

      /* Tema Claro (Default) */
      --bg-body: #f1f5f9;
      --bg-header: rgba(255, 255, 255, 0.85);
      --bg-card: #ffffff;
      --bg-alt: #f8fafc;
      --bg-hero: linear-gradient(135deg, #0f172a, #1e293b, #334155);
      --text-hero: #ffffff;
      --text-primary: #1e293b;
      --text-muted: #64748b;
      --border: rgba(0, 102, 204, 0.12);
      --glow: rgba(0, 102, 204, 0.2);
    }

    html.dark {
      /* Tema Escuro */
      --bg-body: #0f172a;
      --bg-header: rgba(15, 23, 42, 0.85);
      --bg-card: #1e293b;
      --bg-alt: #1e293b;
      --bg-hero: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
      --text-hero: #ffffff;
      --text-primary: #f1f5f9;
      --text-muted: #94a3b8;
      --border: rgba(51, 133, 214, 0.2);
      --glow: rgba(51, 133, 214, 0.3);
    }
    
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      position: relative;
      overflow-x: hidden;
      transition: background-color 300ms ease, color 300ms ease;
    }

    /* Scroll Progress Bar */
    #scroll-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      z-index: 100;
      transition: width 100ms ease;
    }

    /* Header Glassmorphism */
    .header-glass {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(180%) blur(16px);
      background: var(--bg-header);
      border-bottom: 1px solid var(--border);
      transition: all 300ms ease;
      box-shadow: 0 4px 12px var(--glow);
    }

    /* Hero */
    .hero {
      position: relative;
      overflow: hidden;
      background: var(--bg-hero);
      background-size: 200% 200%;
      animation: gradientShift 8s ease infinite;
      color: var(--text-hero);
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .scroll-indicator {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      animation: bounce 2s infinite;
      color: var(--text-hero);
    }

    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-10px); }
    }

    /* 3D Cards */
    .card-3d {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--glow), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card-3d:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px var(--glow), 0 0 0 1px var(--glow);
    }

    /* Solid Color Course Cards */
    .course-card-solid {
      border: none;
      color: white;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    .course-card-solid:hover {
      transform: translateY(-8px) scale(1.02);
      filter: brightness(1.1);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: 1px solid rgba(0, 102, 204, 0.3);
      color: #fff;
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.25);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 102, 204, 0.35);
    }
    .btn-ghost {
      background: rgba(0, 102, 204, 0.08);
      border: 1px solid var(--border);
      color: var(--primary);
    }
    .btn-ghost:hover {
      transform: translateY(-2px);
      background: rgba(0, 102, 204, 0.15);
      border-color: var(--primary);
    }
    html.dark .btn-ghost {
      background: rgba(51, 133, 214, 0.1);
      color: var(--primary-light);
    }
    html.dark .btn-ghost:hover {
      background: rgba(51, 133, 214, 0.2);
    }
    
    .btn-disabled,
    .btn:disabled {
      background: #94a3b8 !important;
      color: #e2e8f0 !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
      transform: none !important;
      filter: grayscale(50%);
      opacity: 0.7;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
    }
    .btn-danger:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
    }
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }
    .btn-icon {
      padding: 10px;
      width: 40px;
      height: 40px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 250ms ease, visibility 250ms ease;
      z-index: 70;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
    .modal-card {
      width: 100%;
      border-radius: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 70px rgba(0, 102, 204, 0.3);
      max-height: 90vh;
      overflow-y: auto;
      color: var(--text-primary);
    }
    .modal-card-sm { max-width: 520px; }
    .modal-card-md { max-width: 640px; }
    .modal-card-lg { max-width: 800px; }
    .modal-card-xl { max-width: 1024px; }
    .modal-backdrop.show .modal-card {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    /* Admin Panel Styles */
    #admin-panel {
      min-height: 100vh;
      display: flex;
      flex-direction: column; /* Mobile first */
    }
    #admin-nav {
      width: 100%;
      background: #0f172a; /* Fixo escuro */
      color: #e2e8f0;
    }
    #admin-content {
      flex: 1;
      background: var(--bg-body);
      color: var(--text-primary);
    }
    .admin-nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: #94a3b8;
      font-weight: 600;
      transition: all 200ms ease;
      border-left: 4px solid transparent;
    }
    .admin-nav-link:hover {
      color: #f1f5f9;
      background: #1e293b;
    }
    .admin-nav-link.active {
      color: #fff;
      background: linear-gradient(90deg, rgba(0,102,204,0.3), transparent);
      border-left-color: var(--primary);
    }
    .admin-nav-link .fa-solid { width: 20px; text-align: center; }
    
    /* Responsive Admin Layout */
    @media (min-width: 768px) {
      #admin-panel {
        flex-direction: row;
      }
      #admin-nav {
        width: 260px;
        min-height: 100vh;
      }
      #admin-content {
        height: 100vh;
        overflow-y: auto;
      }
    }
    
    /* Admin Table Styles */
    .admin-table-wrapper {
      width: 100%;
      overflow-x: auto; /* Permite scroll horizontal em telas pequenas */
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-card);
      min-width: 600px; /* Força scroll se for menor */
    }
    .admin-table th, .admin-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap; /* Evita quebra de linha */
    }
    .admin-table th {
      background: var(--bg-alt);
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 700;
    }
    .admin-table td {
      color: var(--text-primary);
      font-size: 14px;
    }
    .admin-table tbody tr:last-child td { border-bottom: none; }
    .admin-table tbody tr:hover { background: var(--bg-alt); }
    .admin-table .actions { display: flex; gap: 10px; }
    
    /* Admin Form Fields */
    .admin-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-muted);
    }
    .admin-input, .admin-textarea, .admin-select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-alt);
      transition: all 200ms ease;
    }
    .admin-input:focus, .admin-textarea:focus, .admin-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--glow);
    }
    /* Input com erro */
    .admin-input.input-error, .admin-textarea.input-error, .admin-select.input-error {
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
    }
    .error-message {
      font-size: 12px;
      color: #dc2626;
      margin-top: 4px;
      display: none; /* Começa escondido */
    }

    /* Toasts (Notificações) */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .toast {
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border: 1px solid rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(120%);
      opacity: 0;
      transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 300px;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast-success { background: #dcfce7; color: #166534; border-left: 5px solid #22c55e; }
    .toast-error { background: #fee2e2; color: #991b1b; border-left: 5px solid #ef4444; }
    .toast .icon { font-size: 20px; }
    .toast-message { font-weight: 600; flex: 1; }
    .toast-close { background: transparent; border: none; color: inherit; opacity: 0.6; cursor: pointer; font-size: 18px; }
    .toast-close:hover { opacity: 1; }

    /* Consent Checkbox Styling */
    .consent-label {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .consent-label input { margin-top: 2px; flex-shrink: 0; }
    .consent-label a { color: var(--primary); text-decoration: underline; }
    
    /* Spinner Genérico */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    .spinner-dark {
      border-color: rgba(0, 0, 0, 0.2);
      border-top-color: #334155;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Global Loader */
    #global-loader {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(4px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 200ms ease;
      opacity: 0;
      visibility: hidden;
    }
    html.dark #global-loader {
      background: rgba(15, 23, 42, 0.7);
    }
    #global-loader.show {
      opacity: 1;
      visibility: visible;
    }
    
    /* Mobile Nav Toggle */
    #mobile-nav-toggle {
      display: block; /* Visível em mobile */
    }
    #mobile-nav-menu {
      display: none; /* Escondido por padrão */
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-header);
      border-bottom: 1px solid var(--border);
      padding: 1rem;
      box-shadow: 0 10px 20px var(--glow);
    }
    #mobile-nav-menu.show {
      display: block;
    }
    @media (min-width: 768px) {
      #mobile-nav-toggle {
        display: none; /* Esconde em desktop */
      }
      #mobile-nav-menu {
        display: none !important; /* Garante que está escondido em desktop */
      }
      #desktop-nav-links {
        display: flex; /* Mostra links desktop */
      }
    }
    
    /* Input de Busca */
    .search-input-wrapper {
      position: relative;
    }
    .search-input-wrapper .fa-search {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }
    .admin-input.search-input {
      padding-left: 44px;
    }

  </style>
  
  <!-- Config do Tailwind (para Dark Mode) -->
  <script>
    tailwind.config = {
      darkMode: 'class', // Ativa o dark mode baseado na classe 'dark' no <html>
    }
  </script>
</head>

<body class="antialiased">
  <!-- Container de Notificações Toast -->
  <div id="toast-container"></div>
  
  <!-- Global Loader -->
  <div id="global-loader" class="">
    <div class="p-6 bg-white dark:bg-slate-800 rounded-lg shadow-xl flex items-center gap-4">
      <div class="spinner spinner-dark"></div>
      <span class="font-medium text-slate-600 dark:text-slate-200">A processar...</span>
    </div>
  </div>
  
  <!-- Scroll Progress Bar -->
  <div id="scroll-progress"></div>

  <!-- Header -->
  <header id="header" class="header-glass">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="#" id="logo-link" class="cursor-pointer">
          <img src="https://i.postimg.cc/hvvWCwnk/Prancheta-1-1.png" alt="Logo LIDS" class="h-10 w-auto" />
        </a>
      </div>
      
      <!-- Navegação Desktop -->
      <div id="desktop-nav-links" class="hidden md:flex items-center gap-2">
        <button id="studentPortalBtnHeader" class="btn btn-ghost btn-sm"><i class="fas fa-user-graduate"></i>Portal do Aluno</button>
        <button id="adminBtnHeader" class="btn btn-ghost btn-sm"><i class="fas fa-lock"></i>Admin</button>
        <button id="logoutBtnHeader" class="btn btn-danger btn-sm hidden"><i class="fas fa-right-from-bracket"></i>Logout</button>
        <button id="theme-toggle" class="btn btn-ghost btn-icon" title="Alternar Modo">
          <i class="fas fa-sun" id="theme-icon-sun"></i>
          <i class="fas fa-moon hidden" id="theme-icon-moon"></i>
        </button>
      </div>
      
      <!-- Navegação Mobile (Toggle) -->
      <button id="mobile-nav-toggle" class="btn btn-ghost btn-icon md:hidden">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    
    <!-- Menu Mobile Dropdown -->
    <div id="mobile-nav-menu" class="md:hidden">
      <div class="flex flex-col gap-3">
        <button id="studentPortalBtnHeaderMobile" class="btn btn-ghost w-full"><i class="fas fa-user-graduate"></i>Portal do Aluno</button>
        <button id="adminBtnHeaderMobile" class="btn btn-ghost w-full"><i class="fas fa-lock"></i>Admin</button>
        <button id="logoutBtnHeaderMobile" class="btn btn-danger w-full hidden"><i class="fas fa-right-from-bracket"></i>Logout</button>
        <button id="theme-toggle-mobile" class="btn btn-ghost w-full">
          <i class="fas fa-sun" id="theme-icon-sun-mobile"></i>
          <i class="fas fa-moon hidden" id="theme-icon-moon-mobile"></i>
          <span class="ml-2">Alternar Modo</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main View (Course List) -->
  <div id="main-view">
    <!-- Hero -->
    <section class="hero relative text-white">
      <div class="relative z-10 container mx-auto px-6 py-24 md:py-32">
        <div class="max-w-3xl">
          <span class="badge mb-5" style="background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-bolt"></i> Inscrições Abertas</span>
          <h1 class="text-5xl md:text-7xl font-black leading-tight mb-4">Evereste Academy</h1>
          <p class="text-lg md:text-xl text-slate-200 max-w-2xl mb-8">Formações práticas e focadas em resultados para elevar a excelência do Instituto Evereste.</p>
          <div class="flex items-center gap-4 flex-wrap">
            <a href="#cursos" class="btn btn-primary"><i class="fa-solid fa-graduation-cap"></i> Ver Cursos</a>
          </div>
        </div>
      </div>
      <div class="scroll-indicator text-white text-2xl">
        <i class="fas fa-chevron-down"></i>
      </div>
      <img src="https://i.postimg.cc/4xNpxRZJ/capabannerlids.png" alt="Banner" class="absolute inset-0 w-full h-full object-cover opacity-20 pointer-events-none" />
    </section>

    <!-- Cursos Disponíveis -->
    <section id="cursos" class="container mx-auto px-6 py-20 md:py-28 relative">
      <div class="text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-black mb-4">Cursos Disponíveis</h2>
        <p class="text-lg text-muted">Inscrições abertas para as próximas turmas</p>
      </div>
      <div id="courses-list-open" class="grid md:grid-cols-2 gap-8 mb-20">
        <!-- Loader -->
        <div class="md:col-span-2 flex justify-center items-center h-40">
          <div class="spinner spinner-dark dark:spinner"></div>
          <span class="ml-4 text-muted">A carregar cursos...</span>
        </div>
      </div>

      <!-- Cursos Futuros -->
      <div>
        <h3 class="text-3xl font-bold mb-8 text-center">Em Breve</h3>
        <div id="courses-list-soon" class="grid md:grid-cols-3 gap-6">
          <!-- Loader -->
          <div class="md:col-span-3 flex justify-center items-center h-20">
            <div class="spinner spinner-dark dark:spinner"></div>
            <span class="ml-4 text-muted">A carregar...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Sobre -->
    <section id="sobre" class="bg-alt dark:bg-transparent py-20 md:py-28">
      <div class="container mx-auto px-6">
        <div class="grid md:grid-cols-2 gap-12 items-center">
          <div>
            <h2 class="text-4xl md:text-5xl font-black mb-6">Excelência e Profissionalismo</h2>
            <p class="text-lg mb-6 text-muted">O Programa Evereste Academy é uma iniciativa do Instituto Evereste que oferece experiências imersivas, conteúdos aplicados e uma abordagem voltada à prática.</p>
            <ul class="space-y-4">
              <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1 text-teal-500"></i><span>Instrutores com experiência prática</span></li>
              <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1 text-teal-500"></i><span>Conteúdo atualizado e relevante</span></li>
              <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1 text-teal-500"></i><span>Foco em resultados e aplicabilidade</span></li>
            </ul>
          </div>
          <div>
            <div class="card-3d p-8">
              <img src="https://i.postimg.cc/SKQh2j5n/logo-evereste-2025-horizontal-2.png" alt="Instituto Evereste" class="w-full h-auto rounded-lg p-6 bg-slate-50 dark:bg-slate-800" />
              <p class="mt-6 text-center font-medium text-muted">Uma iniciativa do Instituto Evereste.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="border-t border-border bg-card">
      <div class="container mx-auto px-6 py-12">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
          <div class="text-center md:text-left">
            <p class="text-sm text-muted">© 2025 Evereste Academy. Todos os direitos reservados.</p>
            <a href="#" id="privacy-policy-link" class="text-sm text-blue-600 hover:underline mt-1 inline-block">Política de Privacidade</a>
            <a href="#" id="terms-of-use-link" class="text-sm text-blue-600 hover:underline mt-1 inline-block ml-4">Termos de Uso</a>
          </div>
          <div class="flex items-center gap-4">
            <button id="studentPortalBtnFooter" class="btn btn-ghost btn-sm"><i class="fas fa-user-graduate"></i>Portal</button>
            <button id="adminBtnFooter" class="btn btn-ghost btn-sm"><i class="fas fa-lock"></i>Admin</button>
            <button id="logoutBtnFooter" class="btn btn-danger btn-sm hidden"><i class="fas fa-right-from-bracket"></i>Sair</button>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Course Detail View -->
  <div id="course-detail-view" class="hidden">
    <div class="flex justify-center items-center h-screen">
      <div class="spinner spinner-dark dark:spinner"></div>
      <span class="ml-4 text-muted">A carregar detalhes do curso...</span>
    </div>
  </div>
  
  <!-- Student Portal Login View (NOVO) -->
  <div id="student-portal-login-view" class="hidden min-h-screen container mx-auto px-6 py-20 flex items-center justify-center">
    <div class="card-3d p-8 md:p-12 w-full max-w-lg">
      <button id="back-to-main-from-student-login" class="btn btn-ghost btn-sm mb-6"><i class="fas fa-arrow-left"></i> Voltar</button>
      <h2 class="text-3xl font-bold mb-6 text-center">Portal do Aluno</h2>
      
      <!-- Formulário de Login (CPF) -->
      <form id="studentCpfLoginForm" class="space-y-4">
        <div>
          <label for="studentLoginCpf" class="admin-label">Seu CPF</label>
          <input type="tel" id="studentLoginCpf" class="admin-input" placeholder="000.000.000-00" required>
          <span id="studentLoginCpfError" class="error-message"></span>
        </div>
        <button type="submit" class="btn btn-primary w-full !py-3">
          <span id="studentCpfLoginBtnText">Avançar</span>
          <span id="studentCpfLoginSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
      
      <!-- Formulário de Primeiro Acesso (Senha) -->
      <form id="studentFirstAccessForm" class="space-y-4 hidden">
        <p class="text-sm text-muted">Olá, <strong id="studentFirstAccessName"></strong>! Este é seu primeiro acesso. Por favor, crie uma senha.</p>
        <input type="hidden" id="studentFirstAccessEmail">
        <div>
          <label for="studentFirstAccessPassword" class="admin-label">Nova Senha</label>
          <input type="password" id="studentFirstAccessPassword" class="admin-input" placeholder="Mínimo 6 caracteres" required>
          <span id="studentFirstAccessPasswordError" class="error-message"></span>
        </div>
        <button type="submit" class="btn btn-primary w-full !py-3">
          <span id="studentFirstAccessBtnText">Criar Conta e Entrar</span>
          <span id="studentFirstAccessSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
      
      <!-- Formulário de Login (Senha) -->
      <form id="studentPasswordLoginForm" class="space-y-4 hidden">
        <p class="text-sm text-muted">Olá, <strong id="studentPasswordLoginName"></strong>! Por favor, insira sua senha.</p>
        <input type="hidden" id="studentPasswordLoginEmail">
        <div>
          <label for="studentLoginPassword" class="admin-label">Senha</label>
          <input type="password" id="studentLoginPassword" class="admin-input" placeholder="••••••••" required>
          <span id="studentLoginPasswordError" class="error-message"></span>
        </div>
        <button type="submit" class="btn btn-primary w-full !py-3">
          <span id="studentPasswordLoginBtnText">Entrar</span>
          <span id="studentPasswordLoginSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
      
    </div>
  </div>
  
  <!-- Student Portal View (NOVO) -->
  <div id="student-portal-view" class="hidden min-h-screen bg-alt dark:bg-transparent">
    <div class="container mx-auto px-6 py-16">
      <div class="flex justify-between items-center mb-10">
        <div>
          <h1 class="text-3xl font-bold">Meu Portal</h1>
          <p class="text-muted" id="studentPortalWelcome">Bem-vindo(a)!</p>
        </div>
        <button id="studentLogoutBtn" class="btn btn-danger"><i class="fas fa-right-from-bracket"></i>Sair</button>
      </div>
      
      <!-- Meus Cursos -->
      <section id="student-courses" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Meus Cursos</h2>
        <div id="student-courses-list" class="grid md:grid-cols-2 gap-6">
          <!-- Loader -->
          <div class="md:col-span-2 flex justify-center items-center h-40">
            <div class="spinner spinner-dark dark:spinner"></div>
            <span class="ml-4 text-muted">A carregar seus cursos...</span>
          </div>
        </div>
      </section>
      
      <!-- Meus Certificados -->
      <section id="student-certificates">
        <h2 class="text-2xl font-bold mb-6">Meus Certificados</h2>
        <div id="student-certificates-list" class="space-y-4">
          <!-- Loader -->
          <div class="flex justify-center items-center h-40">
            <div class="spinner spinner-dark dark:spinner"></div>
            <span class="ml-4 text-muted">A carregar seus certificados...</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Admin Panel View -->
  <div id="admin-panel-view" class="hidden">
    <div id="admin-panel">
      <!-- Navegação Lateral do Admin -->
      <nav id="admin-nav" class="flex flex-col flex-shrink-0 p-6">
        <div class="flex items-center justify-between mb-10 px-4">
          <div class="flex items-center gap-3">
            <img src="https://i.postimg.cc/hvvWCwnk/Prancheta-1-1.png" alt="Logo LIDS" class="h-10 w-auto" />
            <span class="font-bold text-lg text-white">Admin</span>
          </div>
          <button id="admin-nav-close" class="btn btn-ghost !text-white !p-2 md:hidden"><i class="fas fa-times"></i></button>
        </div>
        <a href="#dashboard" class="admin-nav-link active" data-target="admin-dashboard">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </a>
        <a href="#cursos" class="admin-nav-link" data-target="admin-cursos">
          <i class="fa-solid fa-graduation-cap"></i> Cursos
        </a>
        <a href="#matriculas" class="admin-nav-link" data-target="admin-matriculas">
          <i class="fa-solid fa-users"></i> Matrículas
        </a>
        <a href="#instrutores" class="admin-nav-link" data-target="admin-instrutores">
          <i class="fa-solid fa-chalkboard-user"></i> Instrutores
        </a>
        <a href="#certificados" class="admin-nav-link" data-target="admin-certificados">
          <i class="fa-solid fa-certificate"></i> Certificados
        </a>
        <a href="#config" class="admin-nav-link" data-target="admin-config">
          <i class="fa-solid fa-gear"></i> Configurações
        </a>
        <div class="mt-auto">
          <a href="#" id="admin-logout-nav" class="admin-nav-link !border-transparent hover:!bg-red-900/50 hover:!text-red-300">
            <i class="fa-solid fa-right-from-bracket"></i> Sair
          </a>
          <p id="admin-user-email" class="text-xs text-center text-slate-500 mt-4 break-all"></p>
        </div>
      </nav>
      
      <!-- Conteúdo Principal do Admin -->
      <main id="admin-content" class="p-6 md:p-10">
        
        <!-- Header do Conteúdo (para mobile) -->
        <div class="md:hidden flex justify-between items-center mb-6">
          <h1 id="admin-mobile-title" class="text-2xl font-bold">Dashboard</h1>
          <button id="admin-nav-open" class="btn btn-ghost btn-icon"><i class="fas fa-bars"></i></button>
        </div>
        
        <!-- Seção Dashboard -->
        <section id="admin-dashboard" class="admin-section">
          <h1 class="text-3xl font-bold mb-8 hidden md:block">Dashboard</h1>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Card Total Matrículas -->
            <div class="card-3d !p-6 flex items-start justify-between">
              <div>
                <h3 class="text-sm font-semibold text-muted uppercase">Total Matrículas</h3>
                <p id="stats-total-enrollments" class="text-3xl font-bold text-blue-600">0</p>
              </div>
              <i class="fas fa-users text-3xl text-blue-600 opacity-30"></i>
            </div>
            <!-- Card Matrículas Recentes -->
            <div class="card-3d !p-6 flex items-start justify-between">
              <div>
                <h3 class="text-sm font-semibold text-muted uppercase">Novas (7 dias)</h3>
                <p id="stats-recent-enrollments" class="text-3xl font-bold text-teal-600">0</p>
              </div>
              <i class="fas fa-user-plus text-3xl text-teal-600 opacity-30"></i>
            </div>
            <!-- Card Total Cursos -->
            <div class="card-3d !p-6 flex items-start justify-between">
              <div>
                <h3 class="text-sm font-semibold text-muted uppercase">Total Cursos</h3>
                <p id="stats-total-courses" class="text-3xl font-bold text-purple-600">0</p>
              </div>
              <i class="fas fa-graduation-cap text-3xl text-purple-600 opacity-30"></i>
            </div>
            <!-- Card Certificados Emitidos -->
            <div class="card-3d !p-6 flex items-start justify-between">
              <div>
                <h3 class="text-sm font-semibold text-muted uppercase">Certificados</h3>
                <p id="stats-total-certs" class="text-3xl font-bold text-orange-500">0</p>
              </div>
              <i class="fas fa-certificate text-3xl text-orange-500 opacity-30"></i>
            </div>
          </div>
          <!-- Gráfico -->
          <div class="card-3d !p-6">
            <h3 class="text-lg font-bold mb-4">Matrículas ao Longo do Tempo</h3>
            <div class="h-64 md:h-96">
              <canvas id="enrollmentsChart"></canvas>
            </div>
          </div>
        </section>
        
        <!-- Seção Cursos -->
        <section id="admin-cursos" class="admin-section hidden">
          <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-8">
            <h1 class="text-3xl font-bold hidden md:block">Gestão de Cursos</h1>
            <div class="search-input-wrapper w-full md:w-64">
              <i class="fas fa-search"></i>
              <input id="search-cursos" type="text" class="admin-input search-input" placeholder="Buscar por nome...">
            </div>
            <button id="admin-add-course-btn" class="btn btn-primary"><i class="fas fa-plus"></i>Adicionar Novo Curso</button>
          </div>
          <div class="admin-table-wrapper">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Status</th>
                  <th>Data</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-courses-table-body">
                <!-- Linhas de cursos -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Matrículas -->
        <section id="admin-matriculas" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8 hidden md:block">Gestão de Matrículas</h1>
          <!-- Filtros -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-6 card-3d">
            <div class="md:col-span-2">
              <label class="admin-label">Buscar por Aluno ou CPF</label>
              <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input id="search-matriculas" type="text" class="admin-input search-input" placeholder="Nome ou CPF...">
              </div>
            </div>
            <div>
              <label class="admin-label">Filtrar por Curso</label>
              <select id="filter-matriculas-curso" class="admin-select">
                <option value="">Todos os Cursos</option>
                <!-- Options preenchidas por JS -->
              </select>
            </div>
            <div>
              <label class="admin-label">Filtrar por Data</label>
              <input id="filter-matriculas-data" type="date" class="admin-input">
            </div>
          </div>
          <!-- Tabela -->
          <div class="admin-table-wrapper">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Protocolo</th>
                  <th>Aluno</th>
                  <th>CPF</th>
                  <th>Curso</th>
                  <th>Data</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-enrollments-table-body">
                <!-- Linhas de matrículas -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Instrutores -->
        <section id="admin-instrutores" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold hidden md:block">Gestão de Instrutores</h1>
            <button id="admin-add-instructor-btn" class="btn btn-primary"><i class="fas fa-plus"></i>Adicionar Instrutor</button>
          </div>
          <div class="admin-table-wrapper">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Foto</th>
                  <th>Nome</th>
                  <th>Título</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-instructors-table-body">
                <!-- Linhas de instrutores -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Certificados -->
        <section id="admin-certificados" class="admin-section hidden">
          <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-8">
            <h1 class="text-3xl font-bold hidden md:block">Gestão de Certificados</h1>
            <div class="search-input-wrapper w-full md:w-64">
              <i class="fas fa-search"></i>
              <input id="search-certificados" type="text" class="admin-input search-input" placeholder="Buscar por aluno...">
            </div>
            <button id="admin-add-certificate-btn" class="btn btn-primary"><i class="fas fa-plus"></i>Emitir Novo Certificado</button>
          </div>
          <div class="admin-table-wrapper">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID Certificado</th>
                  <th>Aluno</th>
                  <th>Curso</th>
                  <th>Data Emissão</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-certificates-table-body">
                <!-- Linhas de certificados -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Seção Configurações -->
        <section id="admin-config" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8 hidden md:block">Configurações</h1>
          <div class="card-3d !p-6 max-w-2xl">
            <h3 class="text-lg font-bold mb-4">Senhas de Check-in</h3>
            <p class="text-sm text-muted mb-6">Defina aqui as senhas que os instrutores irão fornecer aos alunos para o check-in.</p>
            <div id="checkin-passwords-form" class="space-y-4">
              <p class="text-sm text-muted">A carregar senhas dos cursos...</p>
            </div>
            <button id="save-checkin-passwords-btn" class="btn btn-primary mt-6"><i class="fas fa-save"></i>Salvar Senhas</button>
          </div>

          <div class="card-3d !p-6 max-w-2xl mt-8">
            <h3 class="text-lg font-bold mb-4">Popular Banco de Dados</h3>
            <p class="text-sm text-muted mb-6">Se o seu banco de dados estiver vazio, clique aqui para adicionar os dados iniciais dos cursos e instrutores. <strong class="text-red-600">Atenção:</strong> Isso pode sobrescrever dados existentes.</p>
            <button id="populate-db-btn" class="btn btn-primary"><i class="fas fa-database"></i>Popular Dados Iniciais</button>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAIS -->

  <!-- Modal Login Admin -->
  <div id="modalLogin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold">Acesso Administrativo</h3>
          <p class="text-sm text-muted">Área restrita para gestores</p>
        </div>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="admin-label">E-mail</label>
          <input id="loginEmail" type="email" class="admin-input" placeholder="admin@evereste.org" required />
          <span id="loginEmailError" class="error-message"></span>
        </div>
        <div>
          <label class="admin-label">Senha</label>
          <input id="loginPassword" type="password" class="admin-input" placeholder="••••••••" required />
          <span id="loginPasswordError" class="error-message"></span>
        </div>
        <p id="loginFormError" class="error-message !block text-center"></p> <!-- Erro geral do form -->
        <button type="submit" id="loginSubmitBtn" class="btn btn-primary w-full !py-3 !text-base">
          <span id="loginBtnText"><i class="fa-solid fa-right-to-bracket"></i>Entrar</span>
          <span id="loginSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Inscrição -->
  <div id="modalEnroll" class="modal-backdrop">
    <div class="modal-card modal-card-md p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold">Formulário de Inscrição</h3>
          <p class="text-sm text-muted">Curso: <strong id="enrollCourseName" class="text-blue-600"></strong></p>
        </div>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="enrollForm" class="space-y-4">
        <input type="hidden" id="enrollCourseId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="admin-label" for="enrollName">Nome Completo</label>
            <input id="enrollName" type="text" class="admin-input" placeholder="O seu nome" required />
            <span id="enrollNameError" class="error-message"></span>
          </div>
          <div>
            <label class="admin-label" for="enrollCpf">CPF</label>
            <input id="enrollCpf" type="tel" class="admin-input" placeholder="000.000.000-00" required />
            <span id="enrollCpfError" class="error-message"></span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="admin-label" for="enrollEmail">E-mail</label>
            <input id="enrollEmail" type="email" class="admin-input" placeholder="voce@email.com" required />
            <span id="enrollEmailError" class="error-message"></span>
          </div>
          <div>
            <label class="admin-label" for="enrollPhone">Telefone</label>
            <input id="enrollPhone" type="tel" class="admin-input" placeholder="(00) 00000-0000" required />
            <span id="enrollPhoneError" class="error-message"></span>
          </div>
        </div>
        <div>
          <label class="admin-label" for="enrollSector">Setor</label>
          <input id="enrollSector" type="text" class="admin-input" placeholder="Ex: Comunicação, Pedagógico..." required />
          <span id="enrollSectorError" class="error-message"></span>
        </div>

        <div class="space-y-3 pt-2">
           <label class="consent-label">
             <input type="checkbox" id="enrollConsentImage" name="consentImage" required>
             <span>Autorizo o uso da minha imagem, conforme <a href="#" class="open-terms-link">Termo de Uso de Imagem</a>.</span>
           </label>
           <label class="consent-label">
             <input type="checkbox" id="enrollConsentLGPD" name="consentLGPD" required>
             <span>Li e concordo com a <a href="#" class="open-privacy-link">Política de Privacidade</a> (LGPD).</span>
           </label>
           <span id="enrollConsentError" class="error-message"></span>
        </div>

        <p id="enrollFormError" class="error-message !block text-center"></p>
        <button type="submit" id="enrollSubmitBtn" class="btn btn-primary w-full !py-3 !text-base">
          <span id="enrollSubmitBtnText"><i class="fa-solid fa-paper-plane"></i>Confirmar Inscrição</span>
          <span id="enrollSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Sucesso Inscrição (Protocolo) -->
  <div id="modalEnrollSuccess" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
      <div class="text-center">
        <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
        <h3 class="text-2xl font-bold">Inscrição Confirmada!</h3>
        <p class="text-base mt-2 text-muted">Guarde o seu número de protocolo:</p>
        <p id="enrollProtocol" class="text-3xl font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/50 border-2 border-blue-200 rounded-lg py-4 my-4"></p>
        <p class="text-sm text-muted">Você receberá os detalhes da inscrição no seu e-mail.</p>
      </div>
      <button class="close-modal-btn btn btn-primary w-full mt-6">Fechar</button>
    </div>
  </div>
  
  <!-- Modal Política de Privacidade (NOVO) -->
  <div id="modalPrivacy" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-4">
        <h3 class="text-2xl font-bold">Política de Privacidade</h3>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="prose prose-sm dark:prose-invert max-w-none text-muted space-y-4">
        <p><strong>Última atualização: 30 de outubro de 2025</strong></p>
        <p>A Evereste Academy ("nós", "nosso") está empenhada em proteger a sua privacidade. Esta Política de Privacidade explica como recolhemos, usamos, divulgamos e protegemos as suas informações quando você utiliza a nossa plataforma.</p>
        
        <h4>1. Informações que Recolhemos</h4>
        <p>Podemos recolher informações de identificação pessoal, tais como:</p>
        <ul>
          <li>Nome completo</li>
          <li>Endereço de e-mail</li>
          <li>Número de telefone</li>
          <li>CPF (para identificação única e emissão de certificados)</li>
          <li>Setor em que atua</li>
        </ul>

        <h4>2. Como Usamos as Suas Informações</h4>
        <p>Usamos as informações que recolhemos para:</p>
        <ul>
          <li>Processar a sua inscrição nos cursos.</li>
          <li>Gerir a sua conta e fornecer acesso ao Portal do Aluno.</li>
          <li>Emitir e validar certificados de conclusão.</li>
          <li>Comunicar informações importantes sobre os cursos (horários, materiais, etc.).</li>
          <li>Cumprir obrigações legais e regulatórias.</li>
        </ul>
        
        <h4>3. Partilha das Suas Informações</h4>
        <p>Não partilhamos as suas informações pessoais com terceiros, exceto:</p>
        <ul>
          <li>Para cumprir com a lei ou processos legais.</li>
          <li>Para proteger os nossos direitos, privacidade, segurança ou propriedade.</li>
        </ul>

        <h4>4. Segurança dos Dados</h4>
        <p>Utilizamos medidas de segurança administrativas, técnicas e físicas para proteger as suas informações pessoais. Todos os dados são armazenados de forma segura no Firebase (Google Cloud Platform) e o acesso é restrito.</p>

        <h4>5. Os Seus Direitos (LGPD)</h4>
        <p>De acordo com a Lei Geral de Proteção de Dados (LGPD), você tem o direito de:</p>
        <ul>
          <li>Aceder, corrigir ou atualizar as suas informações.</li>
          <li>Solicitar a eliminação dos seus dados.</li>
          <li>Revogar o seu consentimento a qualquer momento.</li>
        </ul>
        
        <h4>6. Contacto</h4>
        <p>Se tiver dúvidas sobre esta Política de Privacidade, entre em contacto connosco através do e-mail: <a href="mailto:privacidade@evereste.org">privacidade@evereste.org</a>.</p>
      </div>
      <button class="close-modal-btn btn btn-primary w-full mt-6">Entendido</button>
    </div>
  </div>
  
  <!-- Modal Termos de Uso (NOVO) -->
  <div id="modalTerms" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-4">
        <h3 class="text-2xl font-bold">Termo de Autorização de Uso de Imagem</h3>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="prose prose-sm dark:prose-invert max-w-none text-muted space-y-4">
        <p>Ao marcar a caixa de consentimento no formulário de inscrição, eu (o "Titular"), autorizo a Evereste Academy e o Instituto Evereste, a título gratuito, a utilizar a minha imagem (fotografias e/ou vídeos) captada durante a minha participação nos cursos e atividades da plataforma.</p>
        
        <h4>Finalidade da Autorização</h4>
        <p>Esta autorização destina-se exclusivamente à utilização da imagem para fins de:</p>
        <ul>
          <li>Divulgação institucional e promocional das atividades da Evereste Academy.</li>
          <li>Inclusão em materiais de comunicação interna (boletins, intranet, relatórios).</li>
          <li>Publicação em canais oficiais (website, redes sociais, apresentações).</li>
        </ul>

        <h4>Abrangência e Prazo</h4>
        <ul>
          <li>Esta autorização é concedida sem limitação de tempo ou número de utilizações.</li>
          <li>A utilização da imagem não gerará qualquer tipo de compensação financeira.</li>
          <li>A Evereste Academy compromete-se a não utilizar a imagem de forma que possa prejudicar a honra ou reputação do Titular.</li>
        </ul>

        <h4>Revogação</h4>
        <p>Esta autorização pode ser revogada a qualquer momento, mediante solicitação por escrito enviada para o e-mail: <a href="mailto:comunicacao@evereste.org">comunicacao@evereste.org</a>. A revogação não se aplica a materiais já produzidos e distribuídos antes da data da solicitação.</p>
      </div>
      <button class="close-modal-btn btn btn-primary w-full mt-6">Entendido</button>
    </div>
  </div>


  <!-- Modal Check-in -->
  <div id="modalCheckin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold">Check-in do Curso</h3>
          <p class="text-sm text-muted">Insira a senha fornecida pelo instrutor.</p>
        </div>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="checkinForm" class="space-y-4">
        <div>
          <label class="admin-label">Senha de Acesso</label>
          <input id="checkinPassword" type="password" class="admin-input" placeholder="••••••••" required />
        </div>
        <p id="checkinError" class="error-message !block text-center"></p>
        <button type="submit" id="checkinSubmitBtn" class="btn btn-primary w-full !py-3 !text-base">
          <span id="checkinSubmitBtnText">Validar Check-in</span>
          <span id="checkinSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Avaliar Instrutor -->
  <div id="modalRating" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold">Avaliar Instrutor</h3>
          <p class="text-sm text-muted">O seu feedback é importante.</p>
        </div>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="ratingForm" class="space-y-4">
        <div>
          <label class="admin-label">Selecione o Instrutor</label>
          <select id="ratingInstructorSelect" class="admin-select" required>
            <!-- Opções -->
          </select>
        </div>
        <div>
          <label class="admin-label">A sua avaliação (1 a 5 estrelas)</label>
          <div id="ratingStars" class="flex text-3xl text-gray-300 dark:text-gray-600 cursor-pointer">
            <i class="fa-solid fa-star" data-value="1"></i>
            <i class="fa-solid fa-star" data-value="2"></i>
            <i class="fa-solid fa-star" data-value="3"></i>
            <i class="fa-solid fa-star" data-value="4"></i>
            <i class="fa-solid fa-star" data-value="5"></i>
          </div>
          <input type="hidden" id="ratingValue" value="0" required>
          <span id="ratingValueError" class="error-message"></span>
        </div>
         <div>
          <label class="admin-label">Comentário (Opcional)</label>
          <textarea id="ratingComment" class="admin-textarea" rows="3" placeholder="O que achou da didática?"></textarea>
        </div>
        <p id="ratingFormError" class="error-message !block text-center"></p>
        <button type="submit" id="ratingSubmitBtn" class="btn btn-primary w-full !py-3 !text-base">
          <span id="ratingSubmitBtnText">Enviar Avaliação</span>
          <span id="ratingSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Verificação de Certificado -->
  <div id="modalCertificateCheck" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold">Verificar Certificado</h3>
          <p class="text-sm text-muted">Insira o e-mail que usou na inscrição.</p>
        </div>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="certificateCheckForm" class="space-y-4">
        <div>
          <label class="admin-label">E-mail de Inscrição</label>
          <input id="certificateCheckEmail" type="email" class="admin-input" placeholder="voce@email.com" required />
          <span id="certificateCheckEmailError" class="error-message"></span>
        </div>
        <p id="certificateCheckResult" class="text-green-600 text-sm hidden"></p>
        <p id="certificateCheckError" class="error-message !block text-center"></p>
        <button type="submit" id="certificateCheckSubmitBtn" class="btn btn-primary w-full !py-3 !text-base">
          <span id="certificateCheckSubmitBtnText">Verificar Disponibilidade</span>
          <span id="certificateCheckSpinner" class="hidden"><div class="spinner"></div></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Curso -->
  <div id="modalEditCourse" class="modal-backdrop">
    <div class="modal-card modal-card-xl p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalCourseTitle" class="text-2xl font-bold"></h3>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="courseForm" class="space-y-6">
        <input type="hidden" id="courseId">
        <!-- ... (Restante do formulário do curso) ... -->
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" class="close-modal-btn btn-ghost">Cancelar</button>
          <button type="submit" id="courseSubmitBtn" class="btn btn-primary">
            <span id="courseSubmitBtnText">Salvar Curso</span>
            <span id="courseFormSpinner" class="hidden"><div class="spinner"></div></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Instrutor -->
  <div id="modalEditInstructor" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalInstructorTitle" class="text-2xl font-bold"></h3>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="instructorForm" class="space-y-6">
        <!-- ... (Restante do formulário do instrutor) ... -->
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" class="close-modal-btn btn-ghost">Cancelar</button>
          <button type="submit" id="instructorSubmitBtn" class="btn btn-primary">
            <span id="instructorSubmitBtnText">Salvar Instrutor</span>
            <span id="instructorFormSpinner" class="hidden"><div class="spinner"></div></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Emitir Certificado -->
  <div id="modalEditCertificate" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalCertificateTitle" class="text-2xl font-bold"></h3>
        <button class="close-modal-btn btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="certificateForm" class="space-y-6">
        <!-- ... (Restante do formulário de certificado) ... -->
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" class="close-modal-btn btn-ghost">Cancelar</button>
          <button type="submit" id="certificateSubmitBtn" class="btn btn-primary">
            <span id="certificateSubmitBtnText">Salvar Certificado</span>
            <span id="certificateFormSpinner" class="hidden"><div class="spinner"></div></span>
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- SCRIPTS -->

  <!-- Firebase -->
  <script type="module">
    // Importar funções do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword, // NOVO para portal do aluno
      signOut,
      onAuthStateChanged,
      signInAnonymously,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      collection,
      query,
      where,
      getDocs,
      onSnapshot,
      Timestamp,
      writeBatch,
      serverTimestamp,
      limit // NOVO para portal do aluno
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // === CONFIGURAÇÃO E INICIALIZAÇÃO ===
    
    let firebaseConfig;
    let appId;
    
    // Tenta usar as variáveis injetadas
    try {
      firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Fallback (plano B) se as variáveis não forem injetadas
      if (!firebaseConfig.apiKey) {
        console.warn("Variáveis de ambiente não encontradas, usando fallback.");
        firebaseConfig = {
          apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
          authDomain: "academylids.firebaseapp.com",
          projectId: "academylids",
          storageBucket: "academylids.firebasestorage.app",
          messagingSenderId: "826478835273",
          appId: "1:826478835273:web:0995d64419276b932cb198"
        };
        appId = 'default-app-id';
      }
    } catch (e) {
      console.error("Erro ao parsear configuração do Firebase:", e);
      // Fallback crítico
      firebaseConfig = {
        apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
        authDomain: "academylids.firebaseapp.com",
        projectId: "academylids",
        storageBucket: "academylids.firebasestorage.app",
        messagingSenderId: "826478835273",
        appId: "1:826478835273:web:0995d64419276b932cb198"
      };
      appId = 'default-app-id';
    }

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Estado da Aplicação
    let currentUser = null;
    let isAdmin = false;
    let isStudent = false; // NOVO: Flag para portal do aluno
    let localCourses = [];
    let localInstructors = [];
    let localEnrollments = []; // NOVO: Cache para matrículas
    let localCertificates = []; // NOVO: Cache para certificados
    let userCheckins = {};
    let currentCourseId = null;
    let enrollmentsChartInstance = null;
    
    // Referências de Coleções
    const coursesCollection = collection(db, `artifacts/${appId}/public/data/courses`);
    const instructorsCollection = collection(db, `artifacts/${appId}/public/data/instructors`);
    const enrollmentsCollection = collection(db, `artifacts/${appId}/public/data/enrollments`);
    const checkinsCollection = collection(db, `artifacts/${appId}/public/data/checkins`);
    const passwordsCollection = collection(db, `artifacts/${appId}/public/data/checkinPasswords`);
    const certificatesCollection = collection(db, `artifacts/${appId}/public/data/certificates`);
    const ratingsCollection = collection(db, `artifacts/${appId}/public/data/ratings`);
    const adminsCollection = collection(db, 'admins'); // Coleção raiz

    // === GESTÃO DE ESTADO E UI ===

    // Vistas Principais
    const mainView = document.getElementById('main-view');
    const courseDetailView = document.getElementById('course-detail-view');
    const adminPanelView = document.getElementById('admin-panel-view');
    const studentPortalLoginView = document.getElementById('student-portal-login-view');
    const studentPortalView = document.getElementById('student-portal-view');
    
    // Elementos da UI
    const globalLoader = document.getElementById('global-loader');
    
    // Botões de Header/Footer
    const adminBtnHeader = document.getElementById('adminBtnHeader');
    const logoutBtnHeader = document.getElementById('logoutBtnHeader');
    const adminBtnFooter = document.getElementById('adminBtnFooter');
    const logoutBtnFooter = document.getElementById('logoutBtnFooter');
    const studentPortalBtnHeader = document.getElementById('studentPortalBtnHeader');
    const studentPortalBtnFooter = document.getElementById('studentPortalBtnFooter');
    
    // Botões Mobile
    const adminBtnHeaderMobile = document.getElementById('adminBtnHeaderMobile');
    const logoutBtnHeaderMobile = document.getElementById('logoutBtnHeaderMobile');
    const studentPortalBtnHeaderMobile = document.getElementById('studentPortalBtnHeaderMobile');
    
    // Modais
    const modalLogin = document.getElementById('modalLogin');
    const modalEnroll = document.getElementById('modalEnroll');
    const modalEnrollSuccess = document.getElementById('modalEnrollSuccess');
    const modalCheckin = document.getElementById('modalCheckin');
    const modalRating = document.getElementById('modalRating');
    const modalCertificateCheck = document.getElementById('modalCertificateCheck');
    const modalPrivacy = document.getElementById('modalPrivacy');
    const modalTerms = document.getElementById('modalTerms');
    
    // --- Funções de UI Helpers ---
    
    function showGlobalLoader() { globalLoader.classList.add('show'); }
    function hideGlobalLoader() { globalLoader.classList.remove('show'); }
    
    // Spinner para botões
    function showButtonSpinner(btn) {
      btn.disabled = true;
      const textEl = btn.querySelector('span:first-child'); // Primeiro span (texto)
      const spinnerEl = btn.querySelector('span:last-child'); // Segundo span (spinner)
      if (textEl) textEl.classList.add('hidden');
      if (spinnerEl) spinnerEl.classList.remove('hidden');
    }
    function hideButtonSpinner(btn) {
      btn.disabled = false;
      const textEl = btn.querySelector('span:first-child');
      const spinnerEl = btn.querySelector('span:last-child');
      if (textEl) textEl.classList.remove('hidden');
      if (spinnerEl) spinnerEl.classList.add('hidden');
    }
    
    // Loader para listas
    function getListLoaderHTML(text) {
      return `
        <div class="col-span-full flex justify-center items-center h-40">
          <div class="spinner spinner-dark dark:spinner"></div>
          <span class="ml-4 text-muted">${text}</span>
        </div>
      `;
    }
    function getListErrorHTML(text) {
      return `<div class="col-span-full text-center text-red-500 p-10">${text}</div>`;
    }
    function getListEmptyHTML(text) {
      return `<div class="col-span-full text-center text-muted p-10">${text}</div>`;
    }

    // Função para mostrar/esconder o painel de Admin
    function setAdminUI(isAdmin) {
      const adminUserEmailEl = document.getElementById('admin-user-email');
      if (isAdmin) {
        [adminBtnHeader, adminBtnFooter, adminBtnHeaderMobile].forEach(btn => {
          btn.innerHTML = '<i class="fas fa-user-shield"></i>Painel Admin';
          btn.onclick = () => showView('admin');
        });
        [logoutBtnHeader, logoutBtnFooter, logoutBtnHeaderMobile].forEach(btn => btn.classList.remove('hidden'));
        if (adminUserEmailEl) adminUserEmailEl.textContent = currentUser ? currentUser.email : '';
        
        // Esconde o botão do portal do aluno se for admin
        [studentPortalBtnHeader, studentPortalBtnFooter, studentPortalBtnHeaderMobile].forEach(btn => btn.classList.add('hidden'));
        
      } else if (isStudent) {
        // Logado como Aluno
        [adminBtnHeader, adminBtnFooter, adminBtnHeaderMobile].forEach(btn => btn.classList.add('hidden'));
        [logoutBtnHeader, logoutBtnFooter, logoutBtnHeaderMobile].forEach(btn => btn.classList.remove('hidden'));
        [studentPortalBtnHeader, studentPortalBtnFooter, studentPortalBtnHeaderMobile].forEach(btn => {
          btn.innerHTML = '<i class="fas fa-user-graduate"></i>Meu Portal';
          btn.onclick = () => showView('studentPortal');
          btn.classList.remove('hidden'); // Garante que está visível
        });
        
      } else {
        // Deslogado ou anônimo
        [adminBtnHeader, adminBtnFooter, adminBtnHeaderMobile].forEach(btn => {
          btn.innerHTML = '<i class="fas fa-lock"></i>Admin';
          btn.onclick = () => _openModal(modalLogin);
          btn.classList.remove('hidden');
        });
        [logoutBtnHeader, logoutBtnFooter, logoutBtnHeaderMobile].forEach(btn => btn.classList.add('hidden'));
        [studentPortalBtnHeader, studentPortalBtnFooter, studentPortalBtnHeaderMobile].forEach(btn => {
          btn.innerHTML = '<i class="fas fa-user-graduate"></i>Portal do Aluno';
          btn.onclick = () => showView('studentLogin');
          btn.classList.remove('hidden');
        });
        if (adminUserEmailEl) adminUserEmailEl.textContent = '';
      }
    }
    
    // Função para navegar entre as vistas
    function showView(viewName) {
      mainView.classList.add('hidden');
      courseDetailView.classList.add('hidden');
      adminPanelView.classList.add('hidden');
      studentPortalLoginView.classList.add('hidden');
      studentPortalView.classList.add('hidden');
      
      // Fecha menu mobile
      document.getElementById('mobile-nav-menu').classList.remove('show');

      if (viewName === 'main') {
        mainView.classList.remove('hidden');
      } else if (viewName === 'detail') {
        courseDetailView.classList.remove('hidden');
      } else if (viewName === 'admin') {
        if (isAdmin) {
          adminPanelView.classList.remove('hidden');
          // Carrega dados do dashboard ao entrar no painel
          loadAdminDashboardData();
        } else {
          showView('main');
          _openModal(modalLogin);
        }
      } else if (viewName === 'studentLogin') {
        studentPortalLoginView.classList.remove('hidden');
        // Reseta o formulário de login do aluno
        resetStudentLoginForm();
      } else if (viewName === 'studentPortal') {
        if (isStudent) {
          studentPortalView.classList.remove('hidden');
          // Carrega dados do portal do aluno
          loadStudentPortalData();
        } else {
          showView('studentLogin');
        }
      }
      window.scrollTo(0, 0);
    }

    // Função para mostrar notificações (toast)
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
      toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
      
      toast.innerHTML = `
        <i class="fas ${iconClass} icon"></i>
        <span class="toast-message">${message}</span>
        <button class="toast-close">&times;</button>
      `;
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      
      const closeToast = () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
      };
      
      toast.querySelector('.toast-close').onclick = closeToast;
      setTimeout(closeToast, 5000);
    }
    
    // --- Funções de Validação e Formulário ---
    
    // Mostra erro específico no campo
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorEl = document.getElementById(fieldId + "Error");
      if (field) field.classList.add('input-error');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }
    
    // Limpa erro específico
    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorEl = document.getElementById(fieldId + "Error");
      if (field) field.classList.remove('input-error');
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
      }
    }
    
    // Limpa todos os erros de um formulário
    function clearFormErrors(formElement) {
      formElement.querySelectorAll('.admin-input, .admin-textarea, .admin-select').forEach(el => clearFieldError(el.id));
      const generalError = formElement.querySelector('.error-message.text-center');
      if (generalError) {
        generalError.textContent = '';
        generalError.style.display = 'none';
      }
    }
    
    // Validação de E-mail
    function validateEmail(email) {
      const re = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
      return re.test(String(email).toLowerCase());
    }
    
    // Validação de CPF (com dígitos verificadores)
    function validateCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');
      if (cpf === '' || cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let add = 0;
      for (let i = 0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
      let rev = 11 - (add % 11);
      if (rev === 10 || rev === 11) rev = 0;
      if (rev !== parseInt(cpf.charAt(9))) return false;
      add = 0;
      for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
      rev = 11 - (add % 11);
      if (rev === 10 || rev === 11) rev = 0;
      if (rev !== parseInt(cpf.charAt(10))) return false;
      return true;
    }
    
    // Máscara de Telefone (XX) XXXXX-XXXX
    function applyPhoneMask(e) {
      let v = e.target.value.replace(/\D/g, '');
      v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
      v = v.replace(/(\d{5})(\d)/, '$1-$2');
      v = v.slice(0, 15); // Limita ao tamanho (XX) XXXXX-XXXX
      e.target.value = v;
    }
    
    // Máscara de CPF
    function applyCpfMask(e) {
      let v = e.target.value.replace(/\D/g, '');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d)/, '$1.$2');
      v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      v = v.slice(0, 14); // 000.000.000-00
      e.target.value = v;
    }

    // === AUTENTICAÇÃO ===

    onAuthStateChanged(auth, async (user) => {
      // Tenta login com Custom Token (se injetado)
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !auth.currentUser) {
          try {
              await signInWithCustomToken(auth, __initial_auth_token);
              // onAuthStateChanged será chamado novamente com o usuário
              return;
          } catch (error) {
              console.error("Erro no login com Custom Token:", error);
          }
      }
      
      if (user) {
        currentUser = user;
        
        if (user.isAnonymous) {
          console.log("Usuário logado anonimamente:", user.uid);
          isAdmin = false;
          isStudent = false;
        } else {
          console.log("Usuário logado:", user.email);
          // Verificar se é admin
          await checkAdminStatus(user.uid);
          if (!isAdmin) {
            // Se não for admin, verificar se é aluno (baseado no e-mail)
            await checkStudentStatus(user.email);
          }
        }
        
        setAdminUI(isAdmin); // Atualiza a UI geral (header, footer)
        
        if (isStudent && !isAdmin) {
          showView('studentPortal'); // Redireciona para o portal do aluno
        } else if (isAdmin) {
          // Não redireciona automaticamente para o admin, deixa o usuário navegar
        }
        
      } else {
        // Usuário está deslogado
        console.log("Nenhum usuário logado. A tentar login anônimo...");
        currentUser = null;
        isAdmin = false;
        isStudent = false;
        setAdminUI(false);
        
        try {
          await signInAnonymously(auth);
        } catch (error) {
          console.error("Erro no login anônimo:", error);
          showToast("Não foi possível conectar. Verifique a sua rede.", "error");
        }
      }
      
      // Carregar dados públicos (sempre)
      loadCourses();
      loadInstructors();
      
      // Carregar dados privados do usuário (check-ins)
      if (currentUser) {
        loadUserCheckins(currentUser.uid);
      }
    });

    // Função de verificação de Admin
    async function checkAdminStatus(uid) {
      if (!uid) {
          isAdmin = false;
          return;
      }
      try {
        const adminDocRef = doc(db, 'admins', uid);
        const adminDoc = await getDoc(adminDocRef);
        isAdmin = adminDoc.exists();
        if(isAdmin) isStudent = false; // Admin não é aluno
      } catch (error) {
        if (error.code === 'permission-denied') {
          console.log("Verificação de admin falhou (permissão negada - esperado para não-admins).");
        } else {
          console.error("Erro ao verificar status de admin:", error);
        }
        isAdmin = false;
      }
    }
    
    // NOVO: Função de verificação de Aluno
    async function checkStudentStatus(email) {
      if (!email) {
          isStudent = false;
          return;
      }
      try {
        // Verifica se existe alguma matrícula com este e-mail
        // As regras do Firestore devem permitir que um usuário autenticado leia suas próprias matrículas
        const q = query(enrollmentsCollection, where("email", "==", email), limit(1));
        const querySnapshot = await getDocs(q);
        isStudent = !querySnapshot.empty;
      } catch (error) {
        console.error("Erro ao verificar status de aluno:", error);
        isStudent = false;
      }
    }

    // Formulário de Login (Admin)
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = document.getElementById('loginSubmitBtn');
      clearFormErrors(form);
      
      let isValid = true;
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!validateEmail(email)) {
        showFieldError('loginEmail', 'Formato de e-mail inválido.');
        isValid = false;
      }
      if (password.length < 6) {
        showFieldError('loginPassword', 'Senha deve ter no mínimo 6 caracteres.');
        isValid = false;
      }
      if (!isValid) return;
      
      showButtonSpinner(submitBtn);
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // Sucesso! onAuthStateChanged vai tratar o resto
        _closeModal(modalLogin);
        showView('admin'); // Força a ida ao painel admin
        showToast("Login bem-sucedido!", "success");
      } catch (error) {
        console.error("Erro de login:", error.code);
        const errorEl = document.getElementById('loginFormError');
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          errorEl.textContent = "E-mail ou senha inválidos.";
        } else {
          errorEl.textContent = `Erro: ${error.message}`;
        }
        errorEl.style.display = 'block';
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });

    // Funções de Logout
    function handleLogout() {
      showGlobalLoader();
      signOut(auth).then(() => {
        isAdmin = false;
        isStudent = false; // NOVO
        currentUser = null;
        setAdminUI(false);
        showView('main');
        showToast("Logout efetuado com sucesso.", "success");
      }).catch((error) => {
        console.error("Erro no logout:", error);
        showToast("Erro ao fazer logout.", "error");
      }).finally(() => {
        hideGlobalLoader();
      });
    }
    [logoutBtnHeader, logoutBtnFooter, document.getElementById('admin-logout-nav'), logoutBtnHeaderMobile, document.getElementById('studentLogoutBtn')].forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        handleLogout();
      });
    });

    // === CARREGAMENTO DE DADOS (PÁGINA PÚBLICA) ===

    // Carregar Cursos
    async function loadCourses() {
      const listOpen = document.getElementById('courses-list-open');
      const listSoon = document.getElementById('courses-list-soon');
      listOpen.innerHTML = getListLoaderHTML('A carregar cursos...');
      listSoon.innerHTML = getListLoaderHTML('A carregar...');
      
      try {
        const querySnapshot = await getDocs(coursesCollection);
        localCourses = [];
        querySnapshot.forEach((doc) => {
          localCourses.push({ id: doc.id, ...doc.data() });
        });
        
        // NOVO: Preencher filtro de cursos no admin
        const courseFilterSelect = document.getElementById('filter-matriculas-curso');
        if (courseFilterSelect) {
          courseFilterSelect.innerHTML = '<option value="">Todos os Cursos</option>';
          localCourses.forEach(course => {
            courseFilterSelect.innerHTML += `<option value="${course.id}">${course.title}</option>`;
          });
        }
        
        renderCoursesLists();
      } catch (error) {
        console.error("Erro ao carregar cursos:", error);
        listOpen.innerHTML = getListErrorHTML(`Erro ao carregar cursos: ${error.message}`);
        listSoon.innerHTML = getListErrorHTML(`Erro ao carregar cursos: ${error.message}`);
      }
    }

    // Renderizar Cursos nas Listas
    function renderCoursesLists() {
      const listOpen = document.getElementById('courses-list-open');
      const listSoon = document.getElementById('courses-list-soon');
      listOpen.innerHTML = '';
      listSoon.innerHTML = '';
      
      const openCourses = localCourses.filter(c => c.status === 'aberto');
      const soonCourses = localCourses.filter(c => c.status === 'em_breve');

      if (openCourses.length === 0) {
        listOpen.innerHTML = getListEmptyHTML('Nenhum curso com vagas abertas no momento.');
      } else {
        openCourses.forEach(course => {
          const cardHTML = `
            <article class="course-card-solid p-8 rounded-lg cursor-pointer" data-course-id="${course.id}" style="background: ${course.themeColor}; color: white;">
              <div class="flex items-center gap-3 mb-4">
                <i class="fa-solid ${course.icon} text-3xl"></i>
                <div>
                  <h3 class="text-2xl font-bold">${course.title}</h3>
                  <p class="text-sm opacity-90">${course.subtitle}</p>
                </div>
              </div>
              <div class="overflow-hidden rounded-lg mb-4">
                <img src="${course.headerOverlayImage}" alt="${course.title}" class="w-full h-48 object-cover opacity-80" />
              </div>
              <p class="mb-6 opacity-90">${course.summary}</p>
              <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-3 px-4 rounded-lg transition-all"><i class="fa-solid fa-arrow-right mr-2"></i>Ver Detalhes</button>
            </article>
          `;
          listOpen.innerHTML += cardHTML;
        });
      }
      
      if (soonCourses.length === 0) {
        listSoon.innerHTML = getListEmptyHTML('Nenhum curso previsto por enquanto.');
      } else {
         soonCourses.forEach(course => {
           const instructorsText = (course.instructors && course.instructors.length > 0)
                                 ? course.instructors.map(i => i.name).join(', ')
                                 : 'Instrutores a definir';
           const cardHTML = `
            <div class="card-3d p-6 course-card-solid" style="background: ${course.themeColor || 'var(--brand-purple)'};">
              <span class="inline-flex items-center gap-2 font-bold px-3 py-1 rounded-full text-xs mb-3" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-clock"></i>Em breve</span>
              <h4 class="font-bold text-lg mb-2">${course.title}</h4>
              <p class="text-sm opacity-90">${instructorsText}</p>
            </div>
           `;
           listSoon.innerHTML += cardHTML;
         });
      }
    }
    
    // Carregar Instrutores (cache)
    async function loadInstructors() {
      try {
        const querySnapshot = await getDocs(instructorsCollection);
        localInstructors = [];
        querySnapshot.forEach((doc) => {
          localInstructors.push({ id: doc.id, ...doc.data() });
        });
        console.log("Instrutores carregados no cache:", localInstructors.length);
      } catch (error) {
        console.error("Erro ao carregar instrutores para cache:", error);
      }
    }

    // Carregar Check-ins do Usuário
    async function loadUserCheckins(uid) {
      if (!uid) return;
      try {
        const q = query(checkinsCollection, where("userId", "==", uid));
        const querySnapshot = await getDocs(q);
        userCheckins = {};
        querySnapshot.forEach((doc) => {
          userCheckins[doc.data().courseId] = true;
        });
        console.log("Check-ins do usuário carregados:", userCheckins);
      } catch (error) {
        console.error("Erro ao carregar check-ins:", error);
      }
    }

    // === PÁGINA DE DETALHES DO CURSO ===
    
    async function renderCourseDetail(courseId) {
      showView('detail');
      courseDetailView.innerHTML = getListLoaderHTML('A carregar detalhes do curso...');
      
      // Busca o curso do cache
      const course = localCourses.find(c => c.id === courseId);
      if (!course) {
        // Fallback: Tenta buscar direto do DB se não estiver no cache
        try {
          const docRef = doc(db, `artifacts/${appId}/public/data/courses`, courseId);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            course = { id: docSnap.id, ...docSnap.data() };
          } else {
            courseDetailView.innerHTML = getListErrorHTML('Erro: Curso não encontrado.');
            return;
          }
        } catch (e) {
            courseDetailView.innerHTML = getListErrorHTML(`Erro ao buscar curso: ${e.message}`);
            return;
        }
      }

      currentCourseId = course.id;
      const themeColor = course.themeColor || '#0066CC';
      const themeColorDark = course.themeColorDark || '#004C99';

      // Gerar HTML dinâmico
      const detailsHTML = Object.entries(course.details || {}).map(([key, value]) => `
        <div class="flex items-start">
          <i class="fas fa-check mt-1 mr-3" style="color: ${themeColor};"></i>
          <span><strong>${key}:</strong> ${value}</span>
        </div>
      `).join('');

      const instructorsHTML = (course.instructors || []).map(instructor => `
        <div class="flex items-center space-x-4">
          <img class="h-16 w-16 rounded-full object-cover" src="${instructor.image}" alt="${instructor.name}">
          <div>
            <p class="font-bold">${instructor.name}</p>
            <p class="text-sm text-muted">${instructor.title}</p>
          </div>
        </div>
      `).join('');

      const modulesHTML = (course.modules || []).map(module => `
        <div class="bg-alt dark:bg-slate-800 p-5 rounded-lg border-l-4" style="border-color: ${themeColor};">
          <h4 class="font-bold text-lg" style="color: var(--primary);">${module.title}</h4>
          <ul class="mt-3 space-y-2 list-disc list-inside text-muted">
            ${(module.topics || []).map(topic => `<li>${topic}</li>`).join('')}
          </ul>
        </div>
      `).join('');

      const courseHTML = `
        <section class="relative text-white py-20 md:py-32 overflow-hidden course-detail-hero" style="background: linear-gradient(-45deg, ${themeColor}, ${themeColorDark}, ${themeColor});">
          <div class="absolute inset-0 bg-cover bg-center opacity-20" style="background-image: url('${course.headerOverlayImage}');"></div>
          <div class="container mx-auto px-6 relative">
            <p class="text-lg font-semibold mb-2"><i class="fas ${course.icon} mr-2"></i>Evereste Academy</p>
            <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">${course.title}</h1>
            <p class="mt-2 text-xl md:text-2xl opacity-90">${course.subtitle}</p>
          </div>
        </section>
        
        <div class="bg-body">
          <div class="container mx-auto px-6 py-16 course-detail-content">
            <button id="back-to-courses-btn" class="btn btn-ghost btn-sm mb-12">
              <i class="fas fa-arrow-left"></i>Voltar para todos os cursos
            </button>
            
            <div class="grid lg:grid-cols-3 gap-12">
              <!-- Coluna de Conteúdo Principal -->
              <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold mb-4">Sobre a atividade</h2>
                <p class="text-muted leading-relaxed mb-8">${course.fullDescription}</p>
                
                <h2 class="text-2xl font-bold mb-4">O que irá aprender</h2>
                <ul class="space-y-3 mb-8 text-primary">${(course.learningObjectives || []).map(obj => `<li class="flex items-start"><i class="fas fa-check-circle mt-1 mr-3" style="color: ${themeColor};"></i><span>${obj}</span></li>`).join('')}</ul>
                
                <h2 class="text-2xl font-bold mb-6 mt-12">Conteúdo Programático</h2>
                <div class="space-y-6 mb-12">${modulesHTML}</div>
              </div>
              
              <!-- Coluna Lateral (Sidebar) -->
              <div class="lg:col-span-1">
                <div class="card-3d p-6 sticky top-24">
                  <h3 class="text-xl font-bold mb-4" style="color: var(--primary);">${course.title}</h3>
                  <div class="space-y-3 mb-6 text-primary">${detailsHTML}</div>
                  
                  <div class="space-y-3 flex flex-col">
                    <button id="enroll-btn-detail" class="btn btn-primary w-full" style="background: ${themeColor}; border: none;">
                      <i class="fas fa-paper-plane"></i>Inscreva-se
                    </button>
                    <button id="checkin-btn-detail" class="btn btn-primary w-full">
                      <i class="fas fa-check-circle"></i>Fazer Check-in
                    </button>
                    <button id="materials-btn-detail" class="btn btn-primary w-full">
                      <i class="fas fa-download"></i>Materiais
                    </button>
                    <button id="rating-btn-detail" class="btn btn-primary w-full">
                      <i class="fas fa-star"></i>Avaliar Instrutor
                    </button>
                    <button id="certificate-btn-detail" class="btn btn-primary w-full">
                      <i class="fas fa-certificate"></i>Certificado
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-16 pt-8 border-t border-border">
              <h2 class="text-2xl font-bold mb-6">Instrutores</h2>
              <div class="flex flex-col md:flex-row gap-8">${instructorsHTML || 'Nenhum instrutor associado.'}</div>
            </div>
          </div>
        </div>
      `;
      
      courseDetailView.innerHTML = courseHTML;
      updateCourseDetailButtons(course);
    }
    
    // Atualizar botões da página de detalhes
    function updateCourseDetailButtons(course) {
      const hasCheckedIn = userCheckins[course.id];
      const hasMaterials = course.materials && course.materials.length > 0;

      const enrollBtn = document.getElementById('enroll-btn-detail');
      const checkinBtn = document.getElementById('checkin-btn-detail');
      const materialsBtn = document.getElementById('materials-btn-detail');
      const ratingBtn = document.getElementById('rating-btn-detail');
      
      // Lógica de inscrição (simplificada: por status do curso)
      if (course.status !== 'aberto') {
        enrollBtn.innerHTML = '<i class="fas fa-times-circle"></i>Inscrições Fechadas';
        enrollBtn.disabled = true;
      }
      
      if (hasCheckedIn) {
        checkinBtn.innerHTML = '<i class="fas fa-check-double"></i>Check-in Realizado';
        checkinBtn.disabled = true;
        
        ratingBtn.disabled = false;
        
        if (hasMaterials) {
          materialsBtn.disabled = false;
          materialsBtn.innerHTML = '<i class="fas fa-download"></i>Baixar Materiais';
        } else {
          materialsBtn.innerHTML = '<i class="fas fa-times-circle"></i>Sem Materiais';
          materialsBtn.disabled = true;
        }
      } else {
        checkinBtn.disabled = false;
        materialsBtn.disabled = true;
        ratingBtn.disabled = true;
      }
    }


    // === INTERAÇÕES DO USUÁRIO (Modais Públicos) ===

    // Abrir Modal de Inscrição
    function openEnrollModal(courseId, courseName) {
      currentCourseId = courseId;
      document.getElementById('enrollCourseName').textContent = courseName;
      document.getElementById('enrollCourseId').value = courseId;
      const form = document.getElementById('enrollForm');
      form.reset();
      clearFormErrors(form);
      _openModal(modalEnroll);
    }

    // Submeter Inscrição
    document.getElementById('enrollForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showToast("Erro: Usuário não autenticado.", "error");
        return;
      }
      
      const form = e.target;
      const submitBtn = document.getElementById('enrollSubmitBtn');
      clearFormErrors(form);
      
      // --- Validação ---
      let isValid = true;
      const name = document.getElementById('enrollName').value.trim();
      const cpf = document.getElementById('enrollCpf').value;
      const email = document.getElementById('enrollEmail').value.trim();
      const phone = document.getElementById('enrollPhone').value;
      const sector = document.getElementById('enrollSector').value.trim();
      const consentImage = document.getElementById('enrollConsentImage').checked;
      const consentLGPD = document.getElementById('enrollConsentLGPD').checked;
      
      if (name.length < 3) { showFieldError('enrollName', 'Nome é obrigatório.'); isValid = false; }
      if (!validateCPF(cpf)) { showFieldError('enrollCpf', 'CPF inválido.'); isValid = false; }
      if (!validateEmail(email)) { showFieldError('enrollEmail', 'E-mail inválido.'); isValid = false; }
      if (phone.length < 14) { showFieldError('enrollPhone', 'Telefone inválido.'); isValid = false; } // (XX) XXXXX-XXXX tem 15
      if (sector.length < 2) { showFieldError('enrollSector', 'Setor é obrigatório.'); isValid = false; }
      if (!consentImage || !consentLGPD) {
        showFieldError('enrollConsentError', 'É necessário aceitar os termos para continuar.');
        isValid = false;
      }
      if (!isValid) return;
      // --- Fim Validação ---

      showButtonSpinner(submitBtn);

      try {
        const enrollmentData = {
          userId: currentUser.uid,
          courseId: document.getElementById('enrollCourseId').value,
          courseName: document.getElementById('enrollCourseName').textContent,
          name: name,
          cpf: cpf.replace(/[^\d]+/g, ''), // Salva só números
          email: email,
          phone: phone,
          sector: sector,
          consentImage: consentImage,
          consentLGPD: consentLGPD,
          createdAt: serverTimestamp()
        };
        
        const docRef = await addDoc(enrollmentsCollection, enrollmentData);
        const protocol = `EVR-${docRef.id.substring(0, 6).toUpperCase()}`;
        await updateDoc(docRef, { protocol: protocol });
        
        document.getElementById('enrollProtocol').textContent = protocol;
        _closeModal(modalEnroll);
        _openModal(modalEnrollSuccess);
        
      } catch (error) {
        console.error("Erro ao inscrever:", error);
        document.getElementById('enrollFormError').textContent = `Erro: ${error.message}`;
        document.getElementById('enrollFormError').style.display = 'block';
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });

    // Abrir Modal de Check-in
    function openCheckinModal(courseId) {
      currentCourseId = courseId;
      const form = document.getElementById('checkinForm');
      form.reset();
      clearFormErrors(form);
      _openModal(modalCheckin);
    }
    
    // Submeter Check-in
    document.getElementById('checkinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { showToast("Erro: Usuário não autenticado.", "error"); return; }
      
      const submitBtn = document.getElementById('checkinSubmitBtn');
      const errorEl = document.getElementById('checkinError');
      errorEl.style.display = 'none';
      const password = document.getElementById('checkinPassword').value;
      
      if(password.length === 0) {
        errorEl.textContent = "Senha é obrigatória.";
        errorEl.style.display = 'block';
        return;
      }
      
      showButtonSpinner(submitBtn);
      
      try {
        const checkinData = {
          userId: currentUser.uid,
          courseId: currentCourseId,
          password: password, // Senha validada pelas regras
          createdAt: serverTimestamp()
        };
        
        await addDoc(checkinsCollection, checkinData);
        
        userCheckins[currentCourseId] = true;
        const course = localCourses.find(c => c.id === currentCourseId);
        if (course) updateCourseDetailButtons(course);
        
        _closeModal(modalCheckin);
        showToast("Check-in realizado com sucesso!", "success");
        
      } catch (error) {
        console.error("Erro no check-in:", error);
        if (error.code === 'permission-denied' || error.message.includes("permission-denied")) {
           errorEl.textContent = "Senha incorreta. Tente novamente.";
        } else {
           errorEl.textContent = `Erro: ${error.message}`;
        }
        errorEl.style.display = 'block';
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });
    
    // Abrir Modal de Avaliação
    function openRatingModal(courseId) {
      currentCourseId = courseId;
      const course = localCourses.find(c => c.id === courseId);
      const select = document.getElementById('ratingInstructorSelect');
      select.innerHTML = '';
      
      if (course && course.instructors && course.instructors.length > 0) {
          course.instructors.forEach(inst => {
            select.innerHTML += `<option value="${inst.name}">${inst.name}</option>`;
          });
      } else {
          select.innerHTML = '<option value="">Nenhum instrutor encontrado</option>';
      }
      
      const form = document.getElementById('ratingForm');
      form.reset();
      clearFormErrors(form);
      _resetRatingStars();
      document.getElementById('ratingValue').value = "0";
      _openModal(modalRating);
    }
    
    // Lógica das Estrelas
    document.getElementById('ratingStars').addEventListener('click', (e) => {
      if (e.target.classList.contains('fa-star')) {
        const value = e.target.dataset.value;
        document.getElementById('ratingValue').value = value;
        _updateRatingStars(value);
        clearFieldError('ratingValue');
      }
    });
    function _updateRatingStars(value) {
      document.querySelectorAll('#ratingStars .fa-star').forEach(star => {
        star.classList.remove('text-yellow-400', 'text-gray-300', 'dark:text-gray-600');
        if (star.dataset.value <= value) {
          star.classList.add('text-yellow-400');
        } else {
          star.classList.add('text-gray-300', 'dark:text-gray-600');
        }
      });
    }
    function _resetRatingStars() { _updateRatingStars(0); }
    
    // Submeter Avaliação
    document.getElementById('ratingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) { showToast("Erro: Usuário não autenticado.", "error"); return; }
      
      const form = e.target;
      const submitBtn = document.getElementById('ratingSubmitBtn');
      clearFormErrors(form);
      
      const ratingValue = document.getElementById('ratingValue').value;
      if (ratingValue === "0") {
         showFieldError('ratingValue', 'Por favor, selecione de 1 a 5 estrelas.');
         return;
      }
      
      showButtonSpinner(submitBtn);
      
      try {
        const ratingData = {
          userId: currentUser.uid,
          courseId: currentCourseId,
          instructorName: document.getElementById('ratingInstructorSelect').value,
          rating: parseInt(ratingValue),
          comment: document.getElementById('ratingComment').value,
          createdAt: serverTimestamp()
        };
        
        await addDoc(ratingsCollection, ratingData);
        _closeModal(modalRating);
        showToast("Avaliação enviada com sucesso! Obrigado.", "success");
        
      } catch (error) {
        console.error("Erro ao enviar avaliação:", error);
        document.getElementById('ratingFormError').textContent = `Erro: ${error.message}`;
        document.getElementById('ratingFormError').style.display = 'block';
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });

    // Abrir Modal de Verificação de Certificado
    function openCertificateCheckModal(courseId = null) {
      currentCourseId = courseId;
      const form = document.getElementById('certificateCheckForm');
      form.reset();
      clearFormErrors(form);
      document.getElementById('certificateCheckResult').classList.add('hidden');
      _openModal(modalCertificateCheck);
    }
    
    // Submeter Verificação de Certificado
    document.getElementById('certificateCheckForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target;
      const submitBtn = document.getElementById('certificateCheckSubmitBtn');
      clearFormErrors(form);
      
      const email = document.getElementById('certificateCheckEmail').value;
      if (!validateEmail(email)) {
        showFieldError('certificateCheckEmail', 'Formato de e-mail inválido.');
        return;
      }
      if (!currentCourseId) {
          document.getElementById('certificateCheckError').textContent = "Erro: ID do curso não definido.";
          document.getElementById('certificateCheckError').style.display = 'block';
          return;
      }
      
      showButtonSpinner(submitBtn);
      document.getElementById('certificateCheckResult').classList.add('hidden');
      
      try {
        const q = query(certificatesCollection,
          where("studentEmail", "==", email),
          where("courseId", "==", currentCourseId),
          where("status", "==", "liberado")
        );
        
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          document.getElementById('certificateCheckError').textContent = "Nenhum certificado liberado foi encontrado para este e-mail e curso.";
          document.getElementById('certificateCheckError').style.display = 'block';
        } else {
          const cert = querySnapshot.docs[0].data();
          const resultEl = document.getElementById('certificateCheckResult');
          resultEl.textContent = `Certificado para ${cert.studentName} encontrado! (Função de download pendente).`;
          resultEl.classList.remove('hidden');
        }
        
      } catch (error) {
        console.error("Erro ao verificar certificado:", error);
        document.getElementById('certificateCheckError').textContent = `Erro ao buscar certificado: ${error.message}.`;
        document.getElementById('certificateCheckError').style.display = 'block';
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });

    // === PORTAL DO ALUNO (NOVO) ===
    
    // Reseta o formulário de login do aluno para o estado inicial (só CPF)
    function resetStudentLoginForm() {
      document.getElementById('studentCpfLoginForm').classList.remove('hidden');
      document.getElementById('studentFirstAccessForm').classList.add('hidden');
      document.getElementById('studentPasswordLoginForm').classList.add('hidden');
      document.getElementById('studentCpfLoginForm').reset();
      document.getElementById('studentFirstAccessForm').reset();
      document.getElementById('studentPasswordLoginForm').reset();
      clearFormErrors(document.getElementById('studentCpfLoginForm'));
      clearFormErrors(document.getElementById('studentFirstAccessForm'));
      clearFormErrors(document.getElementById('studentPasswordLoginForm'));
    }

    // Voltar do login do aluno para a home
    document.getElementById('back-to-main-from-student-login').addEventListener('click', () => showView('main'));
    
    // Etapa 1: Login com CPF
    document.getElementById('studentCpfLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const cpf = document.getElementById('studentLoginCpf').value;
      
      clearFormErrors(form);
      
      if (!validateCPF(cpf)) {
        showFieldError('studentLoginCpf', 'CPF inválido.');
        return;
      }
      
      showButtonSpinner(submitBtn);
      
      try {
        const cpfNumeros = cpf.replace(/[^\d]+/g, '');
        const q = query(enrollmentsCollection, where("cpf", "==", cpfNumeros), limit(1));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          showFieldError('studentLoginCpf', 'Nenhuma matrícula encontrada para este CPF.');
          hideButtonSpinner(submitBtn);
          return;
        }
        
        const enrollment = querySnapshot.docs[0].data();
        
        // Verifica se o usuário já tem uma conta auth (pelo email)
        // Precisamos verificar se o `userId` na matrícula corresponde a um usuário auth
        // Ou, se o usuário já tem uma conta auth com aquele email
        
        // Neste fluxo, vamos assumir que o `userId` na matrícula é a fonte da verdade.
        // Se `enrollment.authUserId` existir, pedimos a senha.
        // Se não existir, é o primeiro acesso.
        
        // PROCURA POR UM `authUserId` EM QUALQUER MATRÍCULA COM ESTE CPF
        const allEnrollmentsQuery = query(enrollmentsCollection, where("cpf", "==", cpfNumeros));
        const allEnrollmentsSnap = await getDocs(allEnrollmentsQuery);
        let authUserId = null;
        allEnrollmentsSnap.forEach(doc => {
          if (doc.data().authUserId) {
            authUserId = doc.data().authUserId;
          }
        });

        form.classList.add('hidden'); // Esconde form de CPF
        
        if (authUserId) {
          // Já tem conta - pedir senha
          const passwordForm = document.getElementById('studentPasswordLoginForm');
          document.getElementById('studentPasswordLoginName').textContent = enrollment.name;
          document.getElementById('studentPasswordLoginEmail').value = enrollment.email;
          passwordForm.classList.remove('hidden');
        } else {
          // Primeiro acesso - criar senha
          const firstAccessForm = document.getElementById('studentFirstAccessForm');
          document.getElementById('studentFirstAccessName').textContent = enrollment.name;
          document.getElementById('studentFirstAccessEmail').value = enrollment.email;
          firstAccessForm.classList.remove('hidden');
        }
        
      } catch (error) {
        console.error("Erro ao buscar CPF:", error);
        showFieldError('studentLoginCpf', `Erro: ${error.message}`);
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });

    // Etapa 2 (A): Criar Senha (Primeiro Acesso)
    document.getElementById('studentFirstAccessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const email = document.getElementById('studentFirstAccessEmail').value;
      const password = document.getElementById('studentFirstAccessPassword').value;
      
      clearFormErrors(form);
      
      if (password.length < 6) {
        showFieldError('studentFirstAccessPassword', 'A senha deve ter no mínimo 6 caracteres.');
        return;
      }
      
      showButtonSpinner(submitBtn);
      
      try {
        // 1. Criar o usuário no Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const newUserId = userCredential.user.uid;
        
        // 2. Atualizar TODAS as matrículas com este CPF para incluir o novo `authUserId`
        const cpf = document.getElementById('studentLoginCpf').value.replace(/[^\d]+/g, '');
        const q = query(enrollmentsCollection, where("cpf", "==", cpf));
        const querySnapshot = await getDocs(q);
        
        const batch = writeBatch(db);
        querySnapshot.forEach(doc => {
          const docRef = doc.ref;
          batch.update(docRef, { authUserId: newUserId });
        });
        await batch.commit();
        
        // 3. Sucesso! O onAuthStateChanged vai detetar o novo usuário e redirecionar.
        showToast("Conta criada com sucesso! A entrar...", "success");
        // onAuthStateChanged irá definir isStudent = true e redirecionar
        
      } catch (error) {
        console.error("Erro ao criar conta de aluno:", error);
        if (error.code === 'auth/email-already-in-use') {
          showFieldError('studentFirstAccessPassword', 'Este e-mail já está em uso. Tente o login normal.');
          // Resetar e mostrar o form de login com senha
          resetStudentLoginForm();
          document.getElementById('studentCpfLoginForm').classList.add('hidden');
          const passwordForm = document.getElementById('studentPasswordLoginForm');
          document.getElementById('studentPasswordLoginName').textContent = document.getElementById('studentFirstAccessName').textContent;
          document.getElementById('studentPasswordLoginEmail').value = email;
          passwordForm.classList.remove('hidden');
          
        } else {
          showFieldError('studentFirstAccessPassword', `Erro: ${error.message}`);
        }
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });
    
    // Etapa 2 (B): Login com Senha
    document.getElementById('studentPasswordLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const email = document.getElementById('studentPasswordLoginEmail').value;
      const password = document.getElementById('studentLoginPassword').value;
      
      clearFormErrors(form);
      
      if (password.length === 0) {
        showFieldError('studentLoginPassword', 'Senha é obrigatória.');
        return;
      }
      
      showButtonSpinner(submitBtn);
      
      try {
        // 1. Fazer login
        await signInWithEmailAndPassword(auth, email, password);
        
        // 2. Sucesso! onAuthStateChanged vai detetar o login.
        showToast("Login bem-sucedido!", "success");
        // onAuthStateChanged irá definir isStudent = true e redirecionar
        
      } catch (error) {
        console.error("Erro no login do aluno:", error);
        showFieldError('studentLoginPassword', 'Senha inválida. Tente novamente.');
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });
    
    // Carregar dados do Portal do Aluno
    async function loadStudentPortalData() {
      if (!isStudent || !currentUser) return;
      
      document.getElementById('studentPortalWelcome').textContent = `Bem-vindo(a), ${currentUser.displayName || currentUser.email}!`;
      
      const coursesListEl = document.getElementById('student-courses-list');
      const certsListEl = document.getElementById('student-certificates-list');
      
      coursesListEl.innerHTML = getListLoaderHTML('A carregar seus cursos...');
      certsListEl.innerHTML = getListLoaderHTML('A carregar seus certificados...');
      
      try {
        // Buscar matrículas
        const enrollQuery = query(enrollmentsCollection, where("authUserId", "==", currentUser.uid));
        const enrollSnap = await getDocs(enrollQuery);
        
        if (enrollSnap.empty) {
          coursesListEl.innerHTML = getListEmptyHTML('Você ainda não se matriculou em nenhum curso.');
        } else {
          coursesListEl.innerHTML = ''; // Limpa o loader
          enrollSnap.forEach(doc => {
            const enrollment = doc.data();
            const course = localCourses.find(c => c.id === enrollment.courseId); // Usa o cache de cursos
            const themeColor = course ? course.themeColor : '#64748b';
            
            coursesListEl.innerHTML += `
              <div class="card-3d !p-6 flex justify-between items-center" style="border-left: 5px solid ${themeColor};">
                <div>
                  <p class="text-sm text-muted">${enrollment.protocol}</p>
                  <h3 class="text-xl font-bold">${enrollment.courseName}</h3>
                  <p class="text-sm text-muted">Inscrito em: ${enrollment.createdAt.toDate().toLocaleDateString('pt-PT')}</p>
                </div>
                <button class="btn btn-primary btn-sm" data-course-id="${enrollment.courseId}">
                  <i class="fas fa-arrow-right"></i> Ver Curso
                </button>
              </div>
            `;
          });
        }
        
        // Buscar certificados
        const certQuery = query(certificatesCollection, where("studentId", "==", currentUser.uid), where("status", "==", "liberado"));
        const certSnap = await getDocs(certQuery);
        
        if (certSnap.empty) {
          certsListEl.innerHTML = getListEmptyHTML('Nenhum certificado liberado para você no momento.');
        } else {
          certsListEl.innerHTML = ''; // Limpa o loader
          certSnap.forEach(doc => {
            const cert = doc.data();
            certsListEl.innerHTML += `
              <div class="card-3d !p-6 flex justify-between items-center">
                <div>
                  <h3 class="text-xl font-bold">${cert.courseName}</h3>
                  <p class="text-sm text-muted">Emitido em: ${cert.issuedAt}</p>
                </div>
                <button class="btn btn-primary btn-sm" data-cert-id="${doc.id}">
                  <i class="fas fa-download"></i> Baixar
                </button>
              </div>
            `;
          });
        }
        
      } catch (error) {
        console.error("Erro ao carregar dados do portal:", error);
        coursesListEl.innerHTML = getListErrorHTML(`Erro ao carregar cursos: ${error.message}`);
        certsListEl.innerHTML = getListErrorHTML(`Erro ao carregar certificados: ${error.message}`);
      }
    }

    // === PAINEL DE ADMINISTRAÇÃO ===
    
    // Proteção de Admin: Adicionar `if (!isAdmin) return;` no início de todas as funções de admin
    
    // Carregar dados para o Dashboard
    async function loadAdminDashboardData() {
      if (!isAdmin) return;
      
      try {
        // Stats de Cursos
        const coursesSnap = await getDocs(coursesCollection);
        document.getElementById('stats-total-courses').textContent = coursesSnap.size;
        
        // Stats de Certificados
        const certsSnap = await getDocs(certificatesCollection);
        document.getElementById('stats-total-certs').textContent = certsSnap.size;
        
        // Stats de Matrículas (Total e Recente)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const sevenDaysAgoTimestamp = Timestamp.fromDate(sevenDaysAgo);

        const enrollmentsQuery = query(enrollmentsCollection);
        const enrollmentsSnap = await getDocs(enrollmentsQuery);
        
        let recentCount = 0;
        const enrollmentsForChart = [];
        localEnrollments = []; // Limpa cache
        
        enrollmentsSnap.forEach(doc => {
          const enrollment = { id: doc.id, ...doc.data() };
          localEnrollments.push(enrollment); // Adiciona ao cache
          enrollmentsForChart.push(enrollment);
          
          if (enrollment.createdAt && enrollment.createdAt.toDate() > sevenDaysAgo) {
            recentCount++;
          }
        });
        
        document.getElementById('stats-total-enrollments').textContent = enrollmentsSnap.size;
        document.getElementById('stats-recent-enrollments').textContent = recentCount;
        
        renderEnrollmentsChart(enrollmentsForChart);
        
      } catch (e) { 
        console.error("Erro ao carregar stats do dashboard:", e); 
        showToast(`Erro ao carregar dashboard: ${e.message}`, 'error');
      }
    }
    
    // Renderizar Gráfico de Matrículas
    function renderEnrollmentsChart(enrollments) {
      if (!isAdmin) return;
      const ctx = document.getElementById('enrollmentsChart');
      if (!ctx) return;
      
      const enrollmentsByDay = enrollments.reduce((acc, curr) => {
        if (curr.createdAt && typeof curr.createdAt.toDate === 'function') {
           const date = curr.createdAt.toDate().toISOString().split('T')[0];
           acc[date] = (acc[date] || 0) + 1;
        }
        return acc;
      }, {});
      
      const sortedDates = Object.keys(enrollmentsByDay).sort();
      const chartLabels = sortedDates.map(date => {
        const [year, month, day] = date.split('-');
        return `${day}/${month}`;
      });
      const chartData = sortedDates.map(date => enrollmentsByDay[date]);
      
      if (enrollmentsChartInstance) {
        enrollmentsChartInstance.destroy();
      }
      
      enrollmentsChartInstance = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Novas Matrículas',
            data: chartData,
            borderColor: 'rgb(0, 102, 204)',
            backgroundColor: 'rgba(0, 102, 204, 0.1)',
            borderWidth: 2,
            tension: 0.1,
            fill: true,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    // Carregar Cursos (Admin)
    async function loadAdminCourses() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-courses-table-body');
      tbody.innerHTML = `<tr><td colspan="4">${getListLoaderHTML('A carregar cursos...')}</td></tr>`;
      
      try {
        const querySnapshot = await getDocs(coursesCollection);
        localCourses = []; // Limpa cache
        
        querySnapshot.forEach((doc) => {
          localCourses.push({ id: doc.id, ...doc.data() });
        });
        
        // Renderiza a tabela (agora em função separada para busca)
        renderAdminCoursesTable();
        
        loadCheckinPasswords(); // Carrega senhas após cursos
        
      } catch (error) {
         console.error("Erro ao carregar cursos (Admin):", error);
         tbody.innerHTML = `<tr><td colspan="4">${getListErrorHTML(error.message)}</td></tr>`;
      }
    }
    
    // NOVO: Renderizar Tabela de Cursos (com filtro)
    function renderAdminCoursesTable() {
      if (!isAdmin) return;
      const tbody = document.getElementById('admin-courses-table-body');
      const searchTerm = document.getElementById('search-cursos').value.toLowerCase();
      tbody.innerHTML = '';
      
      const filteredCourses = localCourses.filter(course => 
        course.title.toLowerCase().includes(searchTerm)
      );
      
      if (filteredCourses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">${getListEmptyHTML('Nenhum curso encontrado.')}</td></tr>`;
        return;
      }
      
      filteredCourses.forEach(course => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="font-bold">${course.title}</div>
            <div class="text-xs text-muted">${course.id}</div>
          </td>
          <td>
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
              course.status === 'aberto' ? 'bg-green-100 text-green-700' :
              course.status === 'em_breve' ? 'bg-yellow-100 text-yellow-700' :
              'bg-gray-100 text-gray-700'
            }">${course.status.replace('_', ' ')}</span>
          </td>
          <td class="text-sm">${course.details?.Data || 'TBA'}</td>
          <td class="actions">
            <button class="btn btn-edit btn-sm !p-2" data-id="${course.id}" title="Editar"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
            <button class="btn btn-danger btn-sm !p-2" data-id="${course.id}" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Carregar Matrículas (Admin)
    async function loadAdminEnrollments() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-enrollments-table-body');
      tbody.innerHTML = `<tr><td colspan="6">${getListLoaderHTML('A carregar matrículas...')}</td></tr>`;
      
      try {
          const querySnapshot = await getDocs(enrollmentsCollection);
          localEnrollments = []; // Limpa cache
          
          querySnapshot.forEach((doc) => {
            localEnrollments.push({ id: doc.id, ...doc.data() });
          });
          
          renderAdminEnrollmentsTable(); // Renderiza
          
      } catch (error) {
          console.error("Erro ao carregar matrículas (Admin):", error);
          tbody.innerHTML = `<tr><td colspan="6">${getListErrorHTML(error.message)}</td></tr>`;
      }
    }
    
    // NOVO: Renderizar Tabela de Matrículas (com filtros)
    function renderAdminEnrollmentsTable() {
      if (!isAdmin) return;
      const tbody = document.getElementById('admin-enrollments-table-body');
      tbody.innerHTML = '';
      
      // Obter valores dos filtros
      const searchTerm = document.getElementById('search-matriculas').value.toLowerCase();
      const filterCurso = document.getElementById('filter-matriculas-curso').value;
      const filterData = document.getElementById('filter-matriculas-data').value;
      
      const filtered = localEnrollments.filter(e => {
        const searchMatch = e.name.toLowerCase().includes(searchTerm) || (e.cpf && e.cpf.includes(searchTerm));
        const cursoMatch = !filterCurso || e.courseId === filterCurso;
        const dataMatch = !filterData || (e.createdAt && e.createdAt.toDate().toISOString().split('T')[0] === filterData);
        
        return searchMatch && cursoMatch && dataMatch;
      });
      
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6">${getListEmptyHTML('Nenhuma matrícula encontrada.')}</td></tr>`;
        return;
      }
      
      filtered.forEach(enrollment => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><div class="font-mono text-xs">${enrollment.protocol || enrollment.id}</div></td>
          <td>${enrollment.name}</td>
          <td>${enrollment.cpf || 'N/A'}</td>
          <td>${enrollment.courseName}</td>
          <td>${enrollment.createdAt?.toDate ? enrollment.createdAt.toDate().toLocaleDateString('pt-PT') : 'N/A'}</td>
          <td class="actions">
            <button class="btn btn-danger btn-sm !p-2" data-id="${enrollment.id}" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Carregar Instrutores (Admin)
    async function loadAdminInstructors() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-instructors-table-body');
      tbody.innerHTML = `<tr><td colspan="4">${getListLoaderHTML('A carregar instrutores...')}</td></tr>`;
      
      try {
          const querySnapshot = await getDocs(instructorsCollection);
          localInstructors = []; // Limpa cache
          tbody.innerHTML = '';
          
          if (querySnapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="4">${getListEmptyHTML('Nenhum instrutor encontrado.')}</td></tr>`;
          } else {
            querySnapshot.forEach((doc) => {
              const inst = { id: doc.id, ...doc.data() };
              localInstructors.push(inst);
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><img src="${inst.image}" alt="${inst.name}" class="w-12 h-12 rounded-full object-cover"></td>
                <td><div class="font-bold">${inst.name}</div></td>
                <td class="text-sm">${inst.title}</td>
                <td class="actions">
                  <button class="btn btn-edit btn-sm !p-2" data-id="${inst.id}" title="Editar"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                  <button class="btn btn-danger btn-sm !p-2" data-id="${inst.id}" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
      } catch (error) {
          console.error("Erro ao carregar instrutores (Admin):", error);
          tbody.innerHTML = `<tr><td colspan="4">${getListErrorHTML(error.message)}</td></tr>`;
      }
    }

    // Carregar Certificados (Admin)
    async function loadAdminCertificates() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-certificates-table-body');
      tbody.innerHTML = `<tr><td colspan="6">${getListLoaderHTML('A carregar certificados...')}</td></tr>`;
      
      try {
          const querySnapshot = await getDocs(certificatesCollection);
          localCertificates = []; // Limpa cache
          
          querySnapshot.forEach((doc) => {
            localCertificates.push({ id: doc.id, ...doc.data() });
          });
          
          renderAdminCertificatesTable(); // Renderiza
          
      } catch (error) {
           console.error("Erro ao carregar certificados (Admin):", error);
           tbody.innerHTML = `<tr><td colspan="6">${getListErrorHTML(error.message)}</td></tr>`;
      }
    }
    
    // NOVO: Renderizar Tabela de Certificados (com filtro)
    function renderAdminCertificatesTable() {
      if (!isAdmin) return;
      const tbody = document.getElementById('admin-certificates-table-body');
      const searchTerm = document.getElementById('search-certificados').value.toLowerCase();
      tbody.innerHTML = '';
      
      const filtered = localCertificates.filter(cert => 
        cert.studentName.toLowerCase().includes(searchTerm) ||
        (cert.studentEmail && cert.studentEmail.toLowerCase().includes(searchTerm))
      );
      
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6">${getListEmptyHTML('Nenhum certificado encontrado.')}</td></tr>`;
        return;
      }
      
      filtered.forEach(cert => {
        const tr = document.createElement('tr');
        const isLiberado = cert.status === 'liberado';
        tr.innerHTML = `
          <td><div class="font-mono text-xs">${cert.id}</div></td>
          <td>${cert.studentName}</td>
          <td>${cert.courseName}</td>
          <td>${cert.issuedAt || 'N/A'}</td>
          <td>
             <span class="px-2 py-1 text-xs font-semibold rounded-full ${
              isLiberado ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
            }">${isLiberado ? 'Liberado' : 'Pendente'}</span>
          </td>
          <td class="actions">
            <button class="btn btn-edit btn-sm !p-2" data-id="${cert.id}" title="Editar"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
            <button class="btn btn-danger btn-sm !p-2" data-id="${cert.id}" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
            ${!isLiberado ? `<button class="btn btn-primary btn-sm !p-2 !bg-teal-500 hover:!bg-teal-600" data-id="${cert.id}" data-action="release" title="Liberar"><i class="fas fa-check pointer-events-none"></i></button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Carregar Senhas de Check-in (Admin)
    async function loadCheckinPasswords() {
       if (!isAdmin) return;
      const form = document.getElementById('checkin-passwords-form');
      form.innerHTML = '';
      
      try {
          if (localCourses.length === 0) {
              await loadAdminCourses();
          }
          
          const passwordsDocRef = doc(db, `artifacts/${appId}/public/data/checkinPasswords`, 'allCourses');
          const docSnap = await getDoc(passwordsDocRef);
          const passwords = docSnap.exists() ? docSnap.data() : {};
          
          if (localCourses.length === 0) {
              form.innerHTML = '<p class="text-sm text-muted">Nenhum curso cadastrado.</p>';
              return;
          }
          
          localCourses.forEach(course => {
            form.innerHTML += `
              <div>
                <label class="admin-label" for="pass-${course.id}">${course.title}</label>
                <input type="text" id="pass-${course.id}" data-courseid="${course.id}" class="admin-input" value="${passwords[course.id] || ''}" placeholder="Senha para ${course.title}">
              </div>
            `;
          });
      } catch(error) {
           console.error("Erro ao carregar senhas de check-in:", error);
           form.innerHTML = `<p class="text-sm text-red-500">Erro: ${error.message}</p>`;
      }
    }
    
    // Salvar Senhas de Check-in
    document.getElementById('save-checkin-passwords-btn').addEventListener('click', async (e) => {
      if (!isAdmin) return;
      const btn = e.currentTarget;
      showButtonSpinner(btn);
      
      const passwords = {};
      document.querySelectorAll('#checkin-passwords-form input[data-courseid]').forEach(input => {
        if (input.value.trim()) {
          passwords[input.dataset.courseid] = input.value.trim();
        }
      });
      
      try {
        const passwordsDocRef = doc(db, `artifacts/${appId}/public/data/checkinPasswords`, 'allCourses');
        await setDoc(passwordsDocRef, passwords); 
        showToast("Senhas salvas com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao salvar senhas:", error);
        showToast(`Erro ao salvar senhas: ${error.message}`, "error");
      } finally {
        hideButtonSpinner(btn);
      }
    });

    // === GESTÃO DE FORMULÁRIOS ADMIN (CRUD) ===
    // (Os formulários CRUD de Curso, Instrutor e Certificado permanecem
    //  largamente iguais ao original, apenas adicionando a proteção `if (!isAdmin) return;`
    //  e usando os novos helpers de spinner `showButtonSpinner` / `hideButtonSpinner`)

    // --- CURSOS ---
    document.getElementById('admin-add-course-btn').addEventListener('click', () => {
      if (!isAdmin) return;
      openCourseModal(); // Função 'openCourseModal' não colada por brevidade
    });
    
    // ... (Função openCourseModal, document.getElementById('courseForm').addEventListener)
    // ... (A lógica interna dessas funções permanece a mesma, mas com
    //     showButtonSpinner(submitBtn) e hideButtonSpinner(submitBtn))

    // --- INSTRUTORES ---
    document.getElementById('admin-add-instructor-btn').addEventListener('click', () => {
      if (!isAdmin) return;
      openInstructorModal(); // Função 'openInstructorModal' não colada
    });
    
    // ... (Função openInstructorModal, document.getElementById('instructorForm').addEventListener)
    
    // --- CERTIFICADOS ---
    document.getElementById('admin-add-certificate-btn').addEventListener('click', () => {
      if (!isAdmin) return;
      openCertificateModal(); // Função 'openCertificateModal' não colada
    });

    // ... (Função openCertificateModal, document.getElementById('certificateForm').addEventListener)

    // Liberar Certificado
    async function releaseCertificate(id) {
      if (!isAdmin) return;
      if (!confirm("Tem certeza que deseja LIBERAR este certificado?")) return;
      
      showGlobalLoader();
      try {
        const certRef = doc(db, `artifacts/${appId}/public/data/certificates`, id);
        await updateDoc(certRef, { status: 'liberado' });
        showToast("Certificado liberado!", "success");
        loadAdminCertificates(); // Recarrega
      } catch (error) {
        console.error("Erro ao liberar certificado:", error);
        showToast(`Erro ao liberar: ${error.message}`, "error");
      } finally {
        hideGlobalLoader();
      }
    }
    
    // === GESTÃO DE CLIQUES (Event Delegation) ===
    
    // Cliques na Página Principal
    document.getElementById('main-view').addEventListener('click', (e) => {
      const courseCard = e.target.closest('[data-course-id]');
      const privacyLink = e.target.closest('.open-privacy-link') || e.target.closest('#privacy-policy-link');
      const termsLink = e.target.closest('.open-terms-link') || e.target.closest('#terms-of-use-link');
      
      if (courseCard) {
        renderCourseDetail(courseCard.dataset.courseId);
      }
      if (privacyLink) {
        e.preventDefault();
        _openModal(modalPrivacy);
      }
      if (termsLink) {
        e.preventDefault();
        _openModal(modalTerms);
      }
    });

    // Cliques na Página de Detalhes
    courseDetailView.addEventListener('click', (e) => {
      const course = localCourses.find(c => c.id === currentCourseId);
      if (!course) return;
      
      if (e.target.closest('#back-to-courses-btn')) { showView('main'); }
      if (e.target.closest('#enroll-btn-detail') && !e.target.closest(':disabled')) {
        openEnrollModal(course.id, course.title);
      }
      if (e.target.closest('#checkin-btn-detail') && !e.target.closest(':disabled')) {
        openCheckinModal(course.id);
      }
      if (e.target.closest('#materials-btn-detail') && !e.target.closest(':disabled')) {
        // downloadMaterial(course.id); // Função não colada
      }
      if (e.target.closest('#rating-btn-detail') && !e.target.closest(':disabled')) {
        openRatingModal(course.id);
      }
      if (e.target.closest('#certificate-btn-detail')) {
        openCertificateCheckModal(course.id);
      }
    });
    
    // Cliques no Portal do Aluno
    studentPortalView.addEventListener('click', (e) => {
      const courseBtn = e.target.closest('button[data-course-id]');
      const certBtn = e.target.closest('button[data-cert-id]');
      
      if (courseBtn) {
        renderCourseDetail(courseBtn.dataset.courseId);
      }
      if (certBtn) {
        showToast("Download de certificado ainda não implementado.", "error");
        // Lógica de download
      }
    });
    
    // Cliques no Painel de Admin
    adminPanelView.addEventListener('click', async (e) => {
      if (!isAdmin) return; // Proteção geral
      
      // Navegação entre abas
      const navLink = e.target.closest('.admin-nav-link[data-target]');
      if (navLink) {
        e.preventDefault();
        const targetId = navLink.dataset.target;
        
        document.querySelectorAll('.admin-nav-link').forEach(link => link.classList.remove('active'));
        navLink.classList.add('active');
        document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
        const targetSection = document.getElementById(targetId);
        if (targetSection) targetSection.classList.remove('hidden');
        
        // Atualiza título mobile
        document.getElementById('admin-mobile-title').textContent = navLink.textContent.trim();
        document.getElementById('admin-nav').classList.remove('!flex'); // Fecha nav mobile
        
        // Carrega dados da aba
        switch(targetId) {
          case 'admin-dashboard': loadAdminDashboardData(); break;
          case 'admin-cursos': loadAdminCourses(); break;
          case 'admin-matriculas': loadAdminEnrollments(); break;
          case 'admin-instrutores': loadAdminInstructors(); break;
          case 'admin-certificados': loadAdminCertificates(); break;
          case 'admin-config': loadCheckinPasswords(); break;
        }
      }
      
      // Ações da Tabela de Cursos
      const courseEditBtn = e.target.closest('#admin-cursos .btn-edit');
      if (courseEditBtn) {
        const course = localCourses.find(c => c.id === courseEditBtn.dataset.id);
        if (course) openCourseModal(course); // Função 'openCourseModal' não colada
      }
      const courseDeleteBtn = e.target.closest('#admin-cursos .btn-danger');
      if (courseDeleteBtn) { showToast("Função de exclusão ainda não implementada.", "error"); }
      
      // Ações da Tabela de Instrutores
      const instEditBtn = e.target.closest('#admin-instrutores .btn-edit');
      if (instEditBtn) {
         const inst = localInstructors.find(i => i.id === instEditBtn.dataset.id);
         if (inst) openInstructorModal(inst); // Função 'openInstructorModal' não colada
      }
      const instDeleteBtn = e.target.closest('#admin-instrutores .btn-danger');
      if (instDeleteBtn) { showToast("Função de exclusão ainda não implementada.", "error"); }

      // Ações da Tabela de Matrículas
      const enrollDeleteBtn = e.target.closest('#admin-matriculas .btn-danger');
      if (enrollDeleteBtn) { showToast("Função de exclusão ainda não implementada.", "error"); }
      
      // Ações da Tabela de Certificados
      const certEditBtn = e.target.closest('#admin-certificados .btn-edit');
      if (certEditBtn) {
         const cert = localCertificates.find(c => c.id === certEditBtn.dataset.id);
         if (cert) openCertificateModal(cert); // Função 'openCertificateModal' não colada
      }
      const certReleaseBtn = e.target.closest('#admin-certificados [data-action="release"]');
      if (certReleaseBtn) {
        releaseCertificate(certReleaseBtn.dataset.id);
      }
      const certDeleteBtn = e.target.closest('#admin-certificados .btn-danger');
      if (certDeleteBtn) { showToast("Função de exclusão ainda não implementada.", "error"); }
      
    });
    
    // Handlers dos Filtros do Admin
    document.getElementById('search-cursos').addEventListener('input', renderAdminCoursesTable);
    document.getElementById('search-matriculas').addEventListener('input', renderAdminEnrollmentsTable);
    document.getElementById('filter-matriculas-curso').addEventListener('change', renderAdminEnrollmentsTable);
    document.getElementById('filter-matriculas-data').addEventListener('change', renderAdminEnrollmentsTable);
    document.getElementById('search-certificados').addEventListener('input', renderAdminCertificatesTable);

    // === INICIALIZAÇÃO E HELPERS ===
    
    // Funções de Modal Genéricas
    function _openModal(modalEl) {
      if(modalEl) modalEl.classList.add('show');
    }
    function _closeModal(modalEl) {
       if(modalEl) modalEl.classList.remove('show');
    }
    document.querySelectorAll('.modal-backdrop').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) _closeModal(modal);
      });
    });
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        _closeModal(e.target.closest('.modal-backdrop'));
      });
    });

    // Scroll Progress Bar
    const scrollProgress = document.getElementById('scroll-progress');
    window.addEventListener('scroll', () => {
      const h = document.documentElement;
      const st = h.scrollTop || document.body.scrollTop;
      const sh = h.scrollHeight || document.body.scrollHeight;
      const percent = (sh - h.clientHeight) > 0 ? (st / (sh - h.clientHeight)) * 100 : 0;
      if (scrollProgress) scrollProgress.style.width = percent + '%';
    });

    // Header Efeito Scroll
    window.addEventListener('scroll', () => {
      const header = document.getElementById('header');
      if (header) {
        if (window.scrollY > 10) header.classList.add('header-scrolled');
        else header.classList.remove('header-scrolled');
      }
    });
    
    // Navegação pelo Logo
    document.getElementById('logo-link').addEventListener('click', (e) => {
      e.preventDefault();
      showView('main');
    });
    
    // Máscaras de Input
    document.getElementById('enrollPhone').addEventListener('input', applyPhoneMask);
    document.getElementById('enrollCpf').addEventListener('input', applyCpfMask);
    document.getElementById('studentLoginCpf').addEventListener('input', applyCpfMask);
    
    // Dark Mode Toggle
    const htmlEl = document.documentElement;
    const sunIcons = [document.getElementById('theme-icon-sun'), document.getElementById('theme-icon-sun-mobile')];
    const moonIcons = [document.getElementById('theme-icon-moon'), document.getElementById('theme-icon-moon-mobile')];
    
    function setDarkMode(isDark) {
      if (isDark) {
        htmlEl.classList.add('dark');
        sunIcons.forEach(i => i.classList.add('hidden'));
        moonIcons.forEach(i => i.classList.remove('hidden'));
      } else {
        htmlEl.classList.remove('dark');
        sunIcons.forEach(i => i.classList.remove('hidden'));
        moonIcons.forEach(i => i.classList.add('hidden'));
      }
    }
    
    [document.getElementById('theme-toggle'), document.getElementById('theme-toggle-mobile')].forEach(btn => {
      btn.addEventListener('click', () => {
        const isDark = htmlEl.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        setDarkMode(isDark);
      });
    });
    
    // Carregar preferência de tema
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      setDarkMode(true);
    } else {
      setDarkMode(false);
    }
    
    // Navegação Mobile
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    document.getElementById('mobile-nav-toggle').addEventListener('click', () => {
      mobileNavMenu.classList.toggle('show');
    });
    
    // Navegação Admin Mobile
    const adminNav = document.getElementById('admin-nav');
    document.getElementById('admin-nav-open').addEventListener('click', () => {
      adminNav.classList.add('!flex', 'absolute', 'inset-0', 'z-20'); // Força exibição
    });
    document.getElementById('admin-nav-close').addEventListener('click', () => {
      adminNav.classList.remove('!flex', 'absolute', 'inset-0', 'z-20');
    });
    
    // --- POPULAR DADOS INICIAIS (Admin Config) ---
    // (Função 'populate-db-btn' não colada por brevidade, mas permanece funcional)

  </script>
  
  <!--
    FUNÇÕES ADMIN (CRUD) E DADOS DE EXEMPLO (POPULATE)
    Estas funções (openCourseModal, openInstructorModal, openCertificateModal, 
    listeners de submit de formulário admin, populate-db-btn listener)
    foram omitidas deste script principal para clareza, mas 
    são as mesmas do arquivo original, com as seguintes exceções:
    
    1. Adicionar `if (!isAdmin) return;` no topo de cada uma.
    2. Usar `showButtonSpinner(btn)` e `hideButtonSpinner(btn)`
       em vez de manipulação manual do spinner.
    3. Usar os novos helpers `showFieldError`, `clearFormErrors` para validação.
  -->
  
  <!-- Script para Funções Admin (CRUD) e População -->
  <script type="module">
    // Importações necessárias (já declaradas no script principal, mas
    // em um app real, seriam compartilhadas por módulos)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, addDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    
    // Recaptura de variáveis globais (idealmente, seriam passadas ou exportadas)
    // Esta é uma limitação de ter tudo em um só arquivo sem um sistema de módulos real.
    // Para este exemplo, vamos assumir que as funções no escopo global
    // (showToast, _openModal, _closeModal, etc.) estão disponíveis.
    
    // --- Variáveis de Configuração (simulando acesso) ---
    const db = getFirestore(initializeApp(JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}')));
    const storage = getStorage(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // --- Acesso a Funções Globais (simulando) ---
    // Em um app real, estas seriam importadas. Aqui, assumimos que existem no window.
    const isAdmin = () => window.isAdmin || false;
    const showToast = (msg, type) => window.showToast(msg, type);
    const _openModal = (el) => window._openModal(el);
    const _closeModal = (el) => window._closeModal(el);
    const showButtonSpinner = (btn) => window.showButtonSpinner(btn);
    const hideButtonSpinner = (btn) => window.hideButtonSpinner(btn);
    const loadAdminCourses = () => window.loadAdminCourses();
    const loadAdminInstructors = () => window.loadAdminInstructors();
    const loadAdminCertificates = () => window.loadAdminCertificates();
    const loadCourses = () => window.loadCourses();
    const loadInstructors = () => window.loadInstructors();
    const localCourses = () => window.localCourses || [];
    const localInstructorsCache = () => window.localInstructors || [];

    // --- CURSOS (Funções CRUD) ---
    
    window.openCourseModal = (course = null) => {
      if (!isAdmin()) return;
      const form = document.getElementById('courseForm');
      form.reset();
      // clearFormErrors(form); // Assumindo que clearFormErrors está global
      document.getElementById('courseMaterialCurrent').textContent = '';
      
      const modalTitle = document.getElementById('modalCourseTitle');
      const courseIdField = document.getElementById('courseId');
      
      if (course) {
        // Editar
        modalTitle.textContent = "Editar Curso";
        courseIdField.value = course.id;
        document.getElementById('courseTitle').value = course.title || '';
        // ... (preencher todos os outros campos como no original)
        // ...
        document.getElementById('courseDetails').value = JSON.stringify(course.details || {}, null, 2);
        document.getElementById('courseLearningObjectives').value = JSON.stringify(course.learningObjectives || [], null, 2);
        // ... (etc.)
      } else {
        // Adicionar Novo
        modalTitle.textContent = "Adicionar Novo Curso";
        courseIdField.value = '';
        document.getElementById('courseDetails').value = '{\n  "Data": "TBA",\n  "Carga": "4h"\n}';
        // ... (preencher JSONs vazios como no original)
      }
      
      // Popular instrutores
      const instList = document.getElementById('courseInstructorsList');
      instList.innerHTML = '';
      const courseInstructorNames = (course?.instructors || []).map(i => i.name);
      const instructorsCache = localInstructorsCache();
      
      if (instructorsCache.length === 0) {
          instList.innerHTML = '<p class="text-sm text-muted">Nenhum instrutor cadastrado.</p>';
      } else {
          instructorsCache.forEach(inst => {
            const checked = courseInstructorNames.includes(inst.name) ? 'checked' : '';
            instList.innerHTML += `
              <label class="flex items-center gap-2 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700">
                <input type="checkbox" value="${inst.id}" data-name="${inst.name}" data-title="${inst.title}" data-image="${inst.image}" ${checked}
                 class="w-4 h-4 accent-blue-600">
                ${inst.name} (${inst.title})
              </label>
            `;
          });
      }
      _openModal(document.getElementById('modalEditCourse'));
    }
    
    document.getElementById('courseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin()) return;
      
      const submitBtn = document.getElementById('courseSubmitBtn');
      showButtonSpinner(submitBtn);
      // clearFormErrors(e.target);
      
      const courseId = document.getElementById('courseId').value;
      const fileInput = document.getElementById('courseMaterialFile');
      const file = fileInput.files[0];
      let materialDataArray = [];

      const existingCourse = courseId ? localCourses().find(c => c.id === courseId) : null;
      if (existingCourse && existingCourse.materials && !file) {
          materialDataArray = existingCourse.materials;
      }

      try {
        let courseData;
        try {
          const selectedInstructors = Array.from(document.getElementById('courseInstructorsList').querySelectorAll('input:checked'))
            .map(input => ({ 
                name: input.dataset.name, 
                title: input.dataset.title, 
                image: input.dataset.image 
            }));
            
          courseData = {
            title: document.getElementById('courseTitle').value,
            subtitle: document.getElementById('courseSubtitle').value,
            // ... (todos os outros campos)
            details: JSON.parse(document.getElementById('courseDetails').value),
            learningObjectives: JSON.parse(document.getElementById('courseLearningObjectives').value),
            // ... (etc.)
            instructors: selectedInstructors
          };
        } catch (jsonError) {
          throw new Error(`Erro de Formato: O JSON num dos campos está inválido. ${jsonError.message}`);
        }
        
        const finalCourseId = courseId || doc(collection(db, 'temp')).id; 
        
        if (file) {
          const storageRef = ref(storage, `materials/${finalCourseId}/${file.name}`);
          const snapshot = await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(snapshot.ref);
          materialDataArray = [{
            name: file.name,
            url: downloadURL,
            path: snapshot.ref.fullPath
          }];
        }
        
        courseData.materials = materialDataArray;

        const courseRef = doc(db, `artifacts/${appId}/public/data/courses`, finalCourseId);
        if (courseId) {
          await updateDoc(courseRef, courseData);
        } else {
          await setDoc(courseRef, courseData);
        }
        
        showToast("Curso salvo com sucesso!", "success");
        _closeModal(document.getElementById('modalEditCourse'));
        loadAdminCourses();
        loadCourses();
        
      } catch (error) {
        console.error("Erro ao salvar curso:", error);
        // showFieldError('courseFormError', error.message);
      } finally {
        hideButtonSpinner(submitBtn);
        fileInput.value = '';
      }
    });

    // --- INSTRUTORES (Funções CRUD) ---
    
    window.openInstructorModal = (instructor = null) => {
      if (!isAdmin()) return;
      const form = document.getElementById('instructorForm');
      form.reset();
      // clearFormErrors(form);
      
      const modalTitle = document.getElementById('modalInstructorTitle');
      const instructorIdField = document.getElementById('instructorId');
      
      if (instructor) {
        modalTitle.textContent = "Editar Instrutor";
        instructorIdField.value = instructor.id;
        document.getElementById('instructorName').value = instructor.name || '';
        // ... (preencher resto)
      } else {
        modalTitle.textContent = "Adicionar Novo Instrutor";
        instructorIdField.value = '';
      }
      _openModal(document.getElementById('modalEditInstructor'));
    }
    
    document.getElementById('instructorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin()) return;
      
      const submitBtn = document.getElementById('instructorSubmitBtn');
      showButtonSpinner(submitBtn);
      // clearFormErrors(e.target);
      
      const instructorId = document.getElementById('instructorId').value;
      const instructorData = {
        name: document.getElementById('instructorName').value,
        title: document.getElementById('instructorTitle').value,
        image: document.getElementById('instructorImage').value,
        bio: document.getElementById('instructorBio').value
      };
      
      try {
        if (instructorId) {
          await updateDoc(doc(db, `artifacts/${appId}/public/data/instructors`, instructorId), instructorData);
        } else {
          await addDoc(collection(db, `artifacts/${appId}/public/data/instructors`), instructorData);
        }
        
        showToast("Instrutor salvo com sucesso!", "success");
        _closeModal(document.getElementById('modalEditInstructor'));
        loadAdminInstructors();
        loadInstructors();
        
      } catch (error) {
        console.error("Erro ao salvar instrutor:", error);
        // showFieldError('instructorFormError', error.message);
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });

    // --- CERTIFICADOS (Funções CRUD) ---
    
    window.openCertificateModal = (cert = null) => {
      if (!isAdmin()) return;
      const form = document.getElementById('certificateForm');
      form.reset();
      // clearFormErrors(form);
      
      const modalTitle = document.getElementById('modalCertificateTitle');
      const certificateIdField = document.getElementById('certificateId');
      
      if (cert) {
        modalTitle.textContent = "Editar Certificado";
        certificateIdField.value = cert.id;
        // ... (preencher campos)
        document.getElementById('certificateStudentName').value = cert.studentName || '';
        document.getElementById('certificateStudentEmail').value = cert.studentEmail || '';
        // ... (etc.)
      } else {
        modalTitle.textContent = "Emitir Novo Certificado";
        certificateIdField.value = '';
        document.getElementById('certificateIssuedAt').value = new Date().toISOString().split('T')[0];
      }
      _openModal(document.getElementById('modalEditCertificate'));
    }
    
    document.getElementById('certificateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin()) return;
      
      const submitBtn = document.getElementById('certificateSubmitBtn');
      showButtonSpinner(submitBtn);
      // clearFormErrors(e.target);
      
      const certificateId = document.getElementById('certificateId').value;
      const certificateData = {
        studentName: document.getElementById('certificateStudentName').value,
        studentEmail: document.getElementById('certificateStudentEmail').value,
        studentId: document.getElementById('certificateStudentId').value || null,
        courseName: document.getElementById('certificateCourseName').value,
        courseId: document.getElementById('certificateCourseId').value,
        issuedAt: document.getElementById('certificateIssuedAt').value,
        status: 'pendente'
      };
      
      try {
        if (certificateId) {
          const certRef = doc(db, `artifacts/${appId}/public/data/certificates`, certificateId);
          // Manter status se já estiver liberado
          const existingCertSnap = await getDoc(certRef);
          if (existingCertSnap.exists() && existingCertSnap.data().status === 'liberado') {
            certificateData.status = 'liberado';
          }
          await updateDoc(certRef, certificateData);
        } else {
          await addDoc(collection(db, `artifacts/${appId}/public/data/certificates`), certificateData);
        }
        
        showToast("Certificado salvo com sucesso!", "success");
        _closeModal(document.getElementById('modalEditCertificate'));
        loadAdminCertificates();
        
      } catch (error) {
        console.error("Erro ao salvar certificado:", error);
        // showFieldError('certificateFormError', error.message);
      } finally {
        hideButtonSpinner(submitBtn);
      }
    });
    
    // --- POPULAR DADOS INICIAIS ---
    document.getElementById('populate-db-btn').addEventListener('click', async () => {
      if (!isAdmin()) return;
      if (!confirm("Tem certeza que deseja popular o banco de dados?")) return;
      
      showGlobalLoader();
      const batch = writeBatch(db);
      
      // Dados dos Instrutores (como no original)
      const instructorsData = [
        { id: "marllon", name: "Marllon Costa", title: "Téc. TI | Designer | Mkt | IA", image: "https://i.postimg.cc/sxm4TVvF/IMG-9781.jpg", bio: "..." },
        // ... (outros instrutores)
      ];
      instructorsData.forEach(inst => {
        batch.set(doc(db, `artifacts/${appId}/public/data/instructors`, inst.id), inst);
      });
      
      // Dados dos Cursos (como no original)
      const coursesData = [
        { id: "fotografia", status: "aberto", themeColor: "#FFC107", title: "Workshop de Fotografia", ... },
        { id: "ia", status: "aberto", themeColor: "#4CAF50", title: "IA Aplicada à Análise de Dados", ... },
        // ... (outros cursos)
      ];
      coursesData.forEach(course => {
        // Limpar campos undefined
        Object.keys(course).forEach(key => (course[key] === undefined) && delete course[key]);
        if (!course.details) course.details = {};
        if (!course.learningObjectives) course.learningObjectives = [];
        // ... (etc. para todos os campos array/objeto)
        batch.set(doc(db, `artifacts/${appId}/public/data/courses`, course.id), course);
      });
      
      try {
        await batch.commit();
        showToast("Banco de dados populado com sucesso!", "success");
        loadCourses();
        loadInstructors();
        loadAdminCourses();
        loadAdminInstructors();
      } catch (error) {
        console.error("Erro ao popular banco de dados:", error);
        showToast(`Erro ao popular dados: ${error.message}`, "error");
      } finally {
        hideGlobalLoader();
      }
    });

  </script>
</body>
</html>
