<!DOCTYPE html>
<html lang="pt-pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evereste Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos do dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Cores do Logo LIDS */
      --brand-blue: #0066cc;
      --brand-orange: #ff6b35;
      --brand-teal: #00a896;
      --brand-purple: #6a4c93;
      --brand-yellow: #ffc857;

      /* Paleta Principal */
      --primary: #0066cc;
      --primary-dark: #004c99;
      --primary-light: #3385d6;
      --accent: #ff6b35;
      --accent-light: #ff8c61;

      /* Tema Claro */
      --surface: #ffff;
      --surface-light: #f8fafc;
      --surface-card: #ffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: rgba(0, 102, 204, 0.12);
      --glow: rgba(0, 102, 204, 0.2);

      /* Hero (Tema Escuro) */
      --hero-bg: #0f172a;
      --hero-text: #ffff;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 50%, #fef3c7 100%);
      color: var(--text);
      position: relative;
      overflow-x: hidden; /* Previne scroll horizontal */
    }

    /* Scroll Progress Bar */
    #scroll-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
      z-index: 100;
      transition: width 100ms ease;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    /* Header Glassmorphism */
    .header-glass {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(180%) blur(16px);
      background: rgba(255, 255, 255, 0.85);
      border-bottom: 1px solid var(--border);
      transition: all 300ms ease;
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.08);
    }

    .header-scrolled {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 10px 30px rgba(0, 102, 204, 0.15);
      border-color: rgba(0, 102, 204, 0.2);
    }

    /* Hero (Tema Escuro) */
    .hero {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
      background-size: 200% 200%;
      animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {
      0%,
      100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(1200px 500px at 80% -10%, rgba(0, 102, 204, 0.2), transparent 50%),
        radial-gradient(900px 380px at 10% 10%, rgba(255, 107, 53, 0.15), transparent 60%);
      pointer-events: none;
    }

    .scroll-indicator {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      animation: bounce 2s infinite;
      color: var(--hero-text);
    }

    @keyframes bounce {
      0%,
      100% {
        transform: translateX(-50%) translateY(0);
      }
      50% {
        transform: translateX(-50%) translateY(-10px);
      }
    }

    /* Particles */
    .particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .particles span {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 999px;
      animation: float 12s linear infinite;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
    }

    @keyframes float {
      0% {
        transform: translateY(0) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-120vh) translateX(20vw);
        opacity: 0;
      }
    }

    /* 3D Cards with Gradient Border */
    .card-3d {
      background: var(--surface-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 102, 204, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card-3d::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      padding: 2px;
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 300ms ease;
    }

    .card-3d:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0, 102, 204, 0.2), 0 0 0 1px var(--glow);
    }

    .card-3d:hover::before {
      opacity: 1;
    }

    /* Solid Color Course Cards */
    .course-card-solid {
      border: none;
      color: white;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .course-card-solid::before {
      display: none;
    }

    .course-card-solid:hover {
      transform: translateY(-8px) scale(1.02);
      filter: brightness(1.1);
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal));
      border: 1px solid rgba(0, 102, 204, 0.3);
      border-radius: 12px;
      color: #fff;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.25);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      transition: transform 400ms ease;
    }

    .btn-primary:hover::before {
      transform: translateX(100%);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 102, 204, 0.35);
    }

    .btn-ghost {
      background: rgba(0, 102, 204, 0.08);
      border: 1px solid var(--border);
      color: var(--primary);
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
    }

    .btn-ghost:hover {
      transform: translateY(-2px);
      background: rgba(0, 102, 204, 0.15);
      border-color: var(--primary);
    }
    
    .btn-disabled {
      background: #94a3b8;
      color: #e2e8f0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-disabled:hover {
      background: #94a3b8;
      box-shadow: none;
      transform: none;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-danger:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .btn-danger-outline {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-danger-outline:hover {
      background: #dc2626;
      color: white;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #64748b;
      color: white;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-secondary:hover {
      background: #475569;
    }


    /* Reveal Animation */
    .reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: all 600ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .reveal.show {
      opacity: 1;
      transform: translateY(0);
    }

    .stagger-1 {
      transition-delay: 100ms;
    }

    .stagger-2 {
      transition-delay: 200ms;
    }

    .stagger-3 {
      transition-delay: 300ms;
    }

    .stagger-4 {
      transition-delay: 400ms;
    }

    .stagger-5 {
      transition-delay: 500ms;
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(0, 102, 204, 0.12);
      border: 1px solid rgba(0, 102, 204, 0.25);
      color: var(--primary);
      font-size: 14px;
    }

    .badge-soon {
      background: rgba(255, 200, 87, 0.15);
      border-color: rgba(255, 200, 87, 0.4);
      color: #d97706;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      visibility: hidden;
      transition: all 250ms ease;
      z-index: 70;
      display: flex; /* Alterado para flex */
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-card {
      width: 100%;
      border-radius: 20px;
      background: var(--surface-card);
      border: 1px solid var(--border);
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 70px rgba(0, 102, 204, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      max-height: 90vh; /* Altura máxima */
      overflow-y: auto; /* Scroll se necessário */
    }
    
    .modal-card-sm { max-width: 520px; }
    .modal-card-md { max-width: 640px; }
    .modal-card-lg { max-width: 800px; }
    .modal-card-xl { max-width: 1024px; }


    .modal-backdrop.show .modal-card {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    /* Gradient Text */
    .gradient-text {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Blur Blob Decoration */
    .blur-blob {
      position: absolute;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.15;
      pointer-events: none;
      z-index: -1;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-light);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--brand-blue), var(--brand-teal));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
    
    /* Scrollbar para Modais */
    .modal-card::-webkit-scrollbar-thumb {
      background: var(--brand-purple);
    }

    /* Instructor Avatar */
    .instructor-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      transition: all 250ms ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .instructor-avatar:hover {
      transform: scale(1.1);
    }

    /* Section Backgrounds */
    .section-light {
      background: var(--surface);
    }

    .section-alt {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.03), rgba(0, 168, 150, 0.03));
    }

    /* Course Detail Page Styles */
    .course-detail-hero {
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }

    .course-detail-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Admin Panel Styles (Light Mode) */
    #admin-panel {
      min-height: 100vh;
      display: flex;
    }
    #admin-nav {
      width: 260px;
      background: #ffffff; /* Alterado de escuro para branco */
      color: #334155; /* Alterado de claro para escuro */
      border-right: 1px solid #e2e8f0; /* Adicionada borda */
      flex-shrink: 0;
    }
    #admin-content {
      flex: 1;
      background: #f1f5f9; /* Light gray */
      min-width: 0; /* Garante que o conteúdo pode encolher */
    }
    .admin-nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: #64748b; /* Alterado de #94a3b8 */
      font-weight: 600;
      transition: all 200ms ease;
      border-left: 4px solid transparent;
    }
    .admin-nav-link:hover {
      color: #1e293b; /* Alterado de #f1f5f9 */
      background: #f1f5f9; /* Alterado de #1e293b */
    }
    .admin-nav-link.active {
      color: var(--primary); /* Alterado de #fff */
      background: linear-gradient(90deg, rgba(0,102,204,0.1), transparent); /* Gradiente mais leve */
      border-left-color: var(--brand-blue);
    }
    .admin-nav-link .fa-solid {
      width: 20px;
      text-align: center;
    }
    
    /* Admin Table Styles */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .admin-table th, .admin-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    .admin-table th:first-child, .admin-table td:first-child {
      white-space: normal; /* Permite quebra de linha no título */
    }
    .admin-table th {
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 700;
    }
    .admin-table td {
      color: #334155;
      font-size: 14px;
    }
    .admin-table tbody tr:last-child td {
      border-bottom: none;
    }
    .admin-table tbody tr:hover {
      background: #f1f5f9;
    }
    .admin-table .actions {
      display: flex;
      gap: 10px;
    }
    
    /* Admin Form Fields */
    .admin-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-muted);
    }
    .admin-input, .admin-textarea, .admin-select {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text);
      background: var(--surface-light);
      transition: all 200ms ease;
    }
    .admin-input:focus, .admin-textarea:focus, .admin-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.2);
    }
    .admin-textarea {
      min-height: 120px;
    }
    
    /* Checkbox list */
    .checkbox-list {
      max-height: 150px;
      overflow-y: auto;
      background: var(--surface-light);
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
    }
    .checkbox-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    .checkbox-list label:hover {
      background: #e2e8f0;
    }
    .checkbox-list input {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    /* Toasts (Notificações) */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .toast {
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border: 1px solid rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(120%);
      opacity: 0;
      transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 300px;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast-success {
      background: #dcfce7;
      color: #166534;
      border-left: 5px solid #22c55e;
    }
    .toast-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 5px solid #ef4444;
    }
    .toast .icon {
      font-size: 20px;
    }
    .toast-message {
      font-weight: 600;
      flex: 1;
    }
    .toast-close {
      background: transparent;
      border: none;
      color: inherit;
      opacity: 0.6;
      cursor: pointer;
      font-size: 18px;
    }
    .toast-close:hover {
      opacity: 1;
    }

    /* Dynamic Form Builder Styles */
    .form-builder-item {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 12px;
      margin-bottom: 12px;
    }
    .form-builder-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }
    .form-builder-item-content {
      flex: 1;
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr; /* Default */
    }
    .key-value-pair .form-builder-item-content {
      grid-template-columns: 1fr 2fr; /* Key-Value */
    }
    .module .form-builder-item-content {
      grid-template-columns: 1fr; /* Module */
    }
    .activity .form-builder-item-content {
      grid-template-columns: 1fr 2fr; /* Activity */
    }

    .form-builder-item textarea {
      min-height: 80px;
    }

    .btn-add-item {
      background: #ecfdf5;
      color: #047857;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      transition: all 200ms ease;
      border: 1px solid #a7f3d0;
    }
    .btn-add-item:hover {
      background: #d1fae5;
    }

    .form-builder-item .btn-danger-outline {
      margin-top: 28px; /* Alinha com o input */
    }
    .list-item .btn-danger-outline,
    .module-topic-item .btn-danger-outline {
      margin-top: 0; /* Ajuste para sub-itens */
    }
    
    .module-topics-container {
      border-left: 3px solid var(--brand-teal);
      padding-left: 12px;
      margin-left: 4px;
      margin-top: 8px;
    }
    .module-topic-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }
  </style>
</head>

<body class="antialiased">
  <!-- Container de Notificações Toast -->
  <div id="toast-container"></div>
  
  <!-- Scroll Progress Bar -->
  <div id="scroll-progress"></div>

  <!-- Header -->
  <header id="header" class="header-glass">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="#" id="logo-link" class="cursor-pointer">
          <img src="https://i.postimg.cc/hvvWCwnk/Prancheta-1-1.png" alt="Logo LIDS" class="h-10 w-auto" />
        </a>
      </div>
      <div class="flex items-center gap-4">
        <!-- Botão Admin visível apenas se logado como admin -->
        <button id="adminBtnHeader" class="btn-ghost text-sm"><i class="fas fa-lock mr-2"></i>Admin</button>
        <!-- Botão Logout visível apenas se logado como admin -->
        <button id="logoutBtnHeader" class="btn-danger text-sm hidden"><i class="fas fa-right-from-bracket mr-2"></i>Logout</button>
      </div>
    </div>
  </header>

  <!-- Main View (Course List) -->
  <div id="main-view">
    <!-- Hero (Tema Escuro) -->
    <section class="hero relative text-white">
      <div class="relative z-10 container mx-auto px-6 py-24 md:py-32">
        <div class="reveal max-w-3xl">
          <span class="badge mb-5" style="background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-bolt"></i> Inscrições Abertas</span>
          <h1 class="text-5xl md:text-7xl font-black leading-tight mb-4" style="color: white;">Evereste Academy</h1>
          <p class="text-lg md:text-xl text-slate-200 max-w-2xl mb-8">Formações práticas e focadas em resultados para elevar a excelência do Instituto Evereste. Profissionalismo, dinamismo e tecnologia a favor do seu desenvolvimento.</p>
          <div class="flex items-center gap-4 flex-wrap">
            <a href="#cursos" class="btn-primary"><i class="fa-solid fa-graduation-cap mr-2"></i> Ver Cursos</a>
          </div>
        </div>
      </div>
      <div class="scroll-indicator text-white text-2xl">
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="particles" id="particles"></div>
      <img src="https://i.postimg.cc/4xNpxRZJ/capabannerlids.png" alt="Banner" class="absolute inset-0 w-full h-full object-cover opacity-20 pointer-events-none" />
    </section>

    <!-- Cursos Disponíveis -->
    <section id="cursos" class="section-light container mx-auto px-6 py-20 md:py-28 relative">
      <div class="blur-blob" style="background: var(--brand-blue); top: -200px; right: -200px;"></div>
      <div class="blur-blob" style="background: var(--brand-orange); bottom: -200px; left: -200px;"></div>
      
      <!-- Cursos com Vagas Abertas -->
      <div class="reveal text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-black mb-4" style="color: var(--text);">Cursos Disponíveis</h2>
        <p class="text-lg" style="color: var(--text-muted);">Inscrições abertas para as próximas turmas</p>
      </div>
      <div id="courses-list-open" class="grid md:grid-cols-2 gap-8 mb-20">
        <!-- Cards de cursos com status 'aberto' -->
        <p class="text-center md:col-span-2 text-gray-500">A carregar cursos...</p>
      </div>

      <!-- Cursos Futuros -->
      <div class="reveal">
        <h3 class="text-3xl font-bold mb-8 text-center" style="color: var(--text);">Em Breve</h3>
        <div id="courses-list-soon" class="grid md:grid-cols-3 gap-6">
          <!-- Cards de cursos com status 'em_breve' -->
           <p class="text-center md:col-span-3 text-gray-500">A carregar futuros cursos...</p>
        </div>
      </div>
    </section>

    <!-- REMOVIDO: Seção Instrutores -->

    <!-- Sobre -->
    <section id="sobre" class="section-alt container mx-auto px-6 py-20 md:py-28">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div class="reveal">
          <h2 class="text-4xl md:text-5xl font-black mb-6" style="color: var(--text);">Excelência e Profissionalismo</h2>
          <p class="text-lg mb-6" style="color: var(--text-muted);">O Programa Evereste Academy é uma iniciativa do Instituto Evereste que oferece experiências imersivas, conteúdos aplicados e uma abordagem voltada à prática. Unimos design moderno, tecnologia e didática para acelerar o desenvolvimento.</p>
          <ul class="space-y-4">
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Instrutores com experiência prática</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Conteúdo atualizado e relevante</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Foco em resultados e aplicabilidade</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Aprendizagem validada com check-in</span></li>
          </ul>
        </div>
        <div class="reveal">
          <div class="card-3d p-8">
            <img src="https://i.postimg.cc/SKQh2j5n/logo-evereste-2025-horizontal-2.png" alt="Instituto Evereste" class="w-full h-auto rounded-lg p-6" style="background: rgba(0,102,204,0.03);" />
            <p class="mt-6 text-center font-medium" style="color: var(--text-muted);">Uma iniciativa do Instituto Evereste para formações transformadoras.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="border-t" style="border-color: var(--border); background: var(--surface);">
      <div class="container mx-auto px-6 py-12">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
          <div class="text-center md:text-left">
            <p class="text-sm" style="color: var(--text-muted);">© 2025 Evereste Academy. Todos os direitos reservados.</p>
            <a href="#" id="privacy-policy-link" class="text-sm text-blue-600 hover:underline">Política de Privacidade</a>
          </div>
          <div class="flex items-center gap-4">
            <button id="adminBtnFooter" class="btn-ghost text-sm"><i class="fas fa-lock mr-2"></i>Acesso Admin</button>
            <button id="logoutBtnFooter" class="btn-danger text-sm hidden"><i class="fas fa-right-from-bracket mr-2"></i>Logout</button>
            <img src="https://i.postimg.cc/SKQh2j5n/logo-evereste-2025-horizontal-2.png" alt="Instituto Evereste" class="h-8 w-auto" />
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Course Detail View -->
  <div id="course-detail-view" class="hidden">
    <!-- O conteúdo dinâmico será injetado aqui pela função renderCourseDetail() -->
    <p class="text-center p-20">A carregar detalhes do curso...</p>
  </div>
  
  <!-- Admin Panel View -->
  <div id="admin-panel-view" class="hidden">
    <div id="admin-panel">
      <!-- Navegação Lateral do Admin -->
      <nav id="admin-nav" class="flex flex-col flex-shrink-0 p-6">
        <div class="mb-10 px-4 pt-3"> <!-- Apenas ajustei o padding/margem -->
          <h2 class="text-2xl font-bold text-slate-800">Painel Admin</h2>
        </div>
        <a href="#dashboard" class="admin-nav-link active" data-target="admin-dashboard">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </a>
        <a href="#cursos" class="admin-nav-link" data-target="admin-cursos">
          <i class="fa-solid fa-graduation-cap"></i> Cursos
        </a>
        <a href="#matriculas" class="admin-nav-link" data-target="admin-matriculas">
          <i class="fa-solid fa-users"></i> Matrículas
        </a>
        <a href="#instrutores" class="admin-nav-link" data-target="admin-instrutores">
          <i class="fa-solid fa-chalkboard-user"></i> Instrutores
        </a>
        <!-- REMOVIDO: Link de Certificados -->
        <a href="#config" class="admin-nav-link" data-target="admin-config">
          <i class="fa-solid fa-gear"></i> Configurações
        </a>
        <div class="mt-auto">
          <a href="#" id="admin-logout-nav" class="admin-nav-link !border-transparent hover:!bg-red-100 hover:!text-red-700"> <!-- Classes de hover alteradas -->
            <i class="fa-solid fa-right-from-bracket"></i> Sair
          </a>
          <p id="admin-user-email" class="text-xs text-center text-slate-500 mt-4 break-all"></p>
        </div>
      </nav>
      
      <!-- Conteúdo Principal do Admin -->
      <main id="admin-content" class="p-10 overflow-y-auto">
        
        <!-- Seção Dashboard -->
        <section id="admin-dashboard" class="admin-section">
          <h1 class="text-3xl font-bold mb-8">Dashboard</h1>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Matrículas</h3>
              <p id="stats-total-enrollments" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Check-ins</h3>
              <p id="stats-total-checkins" class="text-3xl font-bold text-teal-600">0</p>
            </div>
            <!-- REMOVIDO: Card de Estatísticas de Certificados -->
          </div>
          <div class="card-3d !p-6">
            <h3 class="text-lg font-bold mb-4">Matrículas ao Longo do Tempo</h3>
            <canvas id="enrollmentsChart" height="100"></canvas>
          </div>
        </section>
        
        <!-- Seção Cursos -->
        <section id="admin-cursos" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Cursos</h1>
            <button id="admin-add-course-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Novo Curso</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Status</th>
                  <th>Data</th>
                  <th>Avaliação</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-courses-table-body">
                <!-- Linhas de cursos -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Matrículas -->
        <section id="admin-matriculas" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8">Gestão de Matrículas</h1>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Protocolo</th>
                  <th>Aluno</th>
                  <th>E-mail</th>
                  <th>Curso</th>
                  <th>Data</th>
                  <th>Setor</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-enrollments-table-body">
                <!-- Linhas de matrículas -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Instrutores -->
        <section id="admin-instrutores" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Instrutores</h1>
            <button id="admin-add-instructor-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Instrutor</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Foto</th>
                  <th>Nome</th>
                  <th>Título</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-instructors-table-body">
                <!-- Linhas de instrutores -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- REMOVIDO: Seção de Gestão de Certificados -->

        <!-- Seção Configurações -->
        <section id="admin-config" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8">Configurações</h1>
          <div class="card-3d !p-6 max-w-2xl">
            <h3 class="text-lg font-bold mb-4">Senhas de Check-in</h3>
            <p class="text-sm text-gray-500 mb-6">Defina aqui as senhas que os instrutores irão fornecer aos alunos para o check-in.</p>
            <div id="checkin-passwords-form" class="space-y-4">
              <!-- Campos de senha serão injetados aqui -->
              <p class="text-sm text-gray-400">A carregar senhas dos cursos...</p>
            </div>
            <button id="save-checkin-passwords-btn" class="btn-primary mt-6"><i class="fas fa-save mr-2"></i>Salvar Senhas</button>
          </div>

          <div class="card-3d !p-6 max-w-2xl mt-8">
            <h3 class="text-lg font-bold mb-4">Popular Banco de Dados</h3>
            <p class="text-sm text-gray-500 mb-6">Se o seu banco de dados estiver vazio, clique aqui para adicionar os dados iniciais dos cursos (Fotografia, IA) e dos instrutores. <strong class="text-red-600">Atenção:</strong> Isso pode sobrescrever dados existentes se os IDs forem iguais.</p>
            <button id="populate-db-btn" class="btn-primary"><i class="fas fa-database mr-2"></i>Popular Dados Iniciais</button>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAIS -->

  <!-- Modal Login -->
  <div id="modalLogin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Acesso Administrativo</h3>
          <p class="text-sm" style="color: var(--text-muted);">Área restrita para gestores</p>
        </div>
        <button id="closeLogin" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="admin-label">E-mail</label>
          <input id="loginEmail" type="email" class="admin-input" placeholder="admin@evereste.org" required />
        </div>
        <div>
          <label class="admin-label">Senha</label>
          <input id="loginPassword" type="password" class="admin-input" placeholder="••••••••" required />
        </div>
        <p id="loginError" class="text-red-600 text-sm hidden">Erro ao fazer login.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base"><i class="fa-solid fa-right-to-bracket mr-2"></i>Entrar</button>
      </form>
    </div>
  </div>

  <!-- Modal Inscrição -->
  <div id="modalEnroll" class="modal-backdrop">
    <div class="modal-card modal-card-md p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Formulário de Inscrição</h3>
          <p class="text-sm" style="color: var(--text-muted);">Inscreva-se no curso: <strong id="enrollCourseName" class="text-blue-600"></strong></p>
        </div>
        <button id="closeEnroll" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="enrollForm" class="space-y-4">
        <div>
          <label class="admin-label">Nome Completo</label>
          <input id="enrollName" type="text" class="admin-input" placeholder="O seu nome" required />
        </div>
        <div>
          <label class="admin-label">E-mail</label>
          <input id="enrollEmail" type="email" class="admin-input" placeholder="voce@email.com" required />
        </div>
        <div>
          <label class="admin-label">Telefone</label>
          <input id="enrollPhone" type="tel" class="admin-input" placeholder="(00) 00000-0000" required />
        </div>
        <div>
          <label class="admin-label">Setor</label>
          <input id="enrollSector" type="text" class="admin-input" placeholder="Ex: Comunicação, Pedagógico..." required />
        </div>

        <!-- Termos e LGPD -->
        <div class="space-y-3 pt-2">
          <label class="flex items-start gap-3 cursor-pointer text-sm">
            <input type="checkbox" id="enrollTermImage" class="mt-1 h-5 w-5 accent-blue-600" required />
            <span class="text-gray-700">Eu concordo com o <a href="#" target="_blank" class="text-blue-600 underline">Termo de Uso de Imagem</a>.</span>
          </label>
          <label class="flex items-start gap-3 cursor-pointer text-sm">
            <input type="checkbox" id="enrollTermPrivacy" class="mt-1 h-5 w-5 accent-blue-600" required />
            <span class="text-gray-700">Eu li e concordo com a <a href="#" target="_blank" class="text-blue-600 underline">Política de Privacidade (LGPD)</a>.</span>
          </label>
        </div>

        <p id="enrollError" class="text-red-600 text-sm hidden">Erro ao processar inscrição. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="enrollSubmitBtnText"><i class="fa-solid fa-paper-plane mr-2"></i>Confirmar Inscrição</span>
          <span id="enrollSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A processar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Sucesso Inscrição (Protocolo) -->
  <div id="modalEnrollSuccess" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
      <div class="text-center">
        <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
        <h3 class="text-2xl font-bold" style="color: var(--text);">Inscrição Confirmada!</h3>
        <p class="text-base mt-2" style="color: var(--text-muted);">Guarde o seu número de protocolo:</p>
        <p id="enrollProtocol" class="text-3xl font-bold text-blue-600 bg-blue-50 border-2 border-blue-200 rounded-lg py-4 my-4"></p>
        <p class="text-sm" style="color: var(--text-muted);">Você receberá os detalhes da inscrição no seu e-mail.</p>
      </div>
      <button id="closeEnrollSuccess" class="btn-primary w-full mt-6">Fechar</button>
    </div>
  </div>

  <!-- Modal Check-in -->
  <div id="modalCheckin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Check-in do Curso</h3>
          <p class="text-sm" style="color: var(--text-muted);">Insira a senha fornecida pelo instrutor.</p>
        </div>
        <button id="closeCheckin" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="checkinForm" class="space-y-4">
        <div>
          <label class="admin-label">Senha de Acesso</label>
          <input id="checkinPassword" type="password" class="admin-input" placeholder="••••••••" required />
        </div>
        <p id="checkinError" class="text-red-600 text-sm hidden">Senha incorreta. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="checkinSubmitBtnText">Validar Check-in</span>
          <span id="checkinSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A validar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Avaliar Instrutor -->
  <div id="modalRating" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Avaliar Instrutor</h3>
          <p class="text-sm" style="color: var(--text-muted);">O seu feedback é importante para nós.</p>
        </div>
        <button id="closeRating" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="ratingForm" class="space-y-4">
        <div>
          <label class="admin-label">Selecione o Instrutor</label>
          <select id="ratingInstructorSelect" class="admin-select" required>
            <!-- Opções de instrutores -->
          </select>
        </div>
        <div>
          <label class="admin-label">A sua avaliação (1 a 5 estrelas)</label>
          <div id="ratingStars" class="flex text-3xl text-gray-300 cursor-pointer">
            <i class="fa-solid fa-star" data-value="1"></i>
            <i class="fa-solid fa-star" data-value="2"></i>
            <i class="fa-solid fa-star" data-value="3"></i>
            <i class="fa-solid fa-star" data-value="4"></i>
            <i class="fa-solid fa-star" data-value="5"></i>
          </div>
          <input type="hidden" id="ratingValue" value="0" required>
        </div>
         <div>
          <label class="admin-label">Comentário (Opcional)</label>
          <textarea id="ratingComment" class="admin-textarea" rows="3" placeholder="O que achou da didática?"></textarea>
        </div>
        <p id="ratingError" class="text-red-600 text-sm hidden">Erro ao enviar. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="ratingSubmitBtnText">Enviar Avaliação</span>
          <span id="ratingSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A enviar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- REMOVIDO: Modal de Verificação de Certificado -->

  <!-- Modal Admin: Editar Curso -->
  <div id="modalEditCourse" class="modal-backdrop">
    <div class="modal-card modal-card-xl p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalCourseTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditCourse" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      
      <form id="courseForm" class="space-y-6">
        <input type="hidden" id="courseId">
        
        <!-- Seção 1: Informações Básicas -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2">Informações Básicas</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="courseTitle">Título</label>
            <input class="admin-input" type="text" id="courseTitle" required>
          </div>
          <div>
            <label class="admin-label" for="courseSubtitle">Subtítulo</label>
            <input class="admin-input" type="text" id="courseSubtitle" required>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="admin-label" for="courseThemeColor">Cor (Hex)</label>
            <input class="admin-input" type="text" id="courseThemeColor" placeholder="#FFC107" required>
          </div>
          <div>
            <label class="admin-label" for="courseIcon">Ícone (FontAwesome)</label>
            <input class="admin-input" type="text" id="courseIcon" placeholder="fa-camera-retro" required>
          </div>
          <div>
            <label class="admin-label" for="courseStatus">Status</label>
            <select id="courseStatus" class="admin-select" required>
              <option value="aberto">Vagas Abertas</option>
              <option value="em_breve">Em Breve</option>
              <option value="fechado">Fechado (Oculto)</option>
            </select>
          </div>
        </div>
         <div>
            <label class="admin-label" for="courseHeaderImage">URL Imagem Capa</label>
            <input class="admin-input" type="text" id="courseHeaderImage" placeholder="https://url-da-imagem.com/capa.jpg" required>
          </div>
        
        <!-- Seção 2: Descrições -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Descrições</h4>
        <div>
          <label class="admin-label" for="courseSummary">Resumo (Card)</label>
          <textarea class="admin-textarea" id="courseSummary" rows="2" required></textarea>
        </div>
        <div>
          <label class="admin-label" for="courseFullDescription">Descrição Completa</label>
          <textarea class="admin-textarea" id="courseFullDescription" rows="3" required></textarea>
        </div>
        <div>
          <label class="admin-label" for="courseTargetAudience">Público-alvo</label>
          <textarea class="admin-textarea" id="courseTargetAudience" rows="2" required></textarea>
        </div>
        
        <!-- Seção 3: Construtores Dinâmicos (Substituindo JSON) -->
        
        <!-- Detalhes (Key-Value) -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Detalhes (Data, Carga, etc.)</h4>
        <div id="courseDetails-builder" class="space-y-3">
          <!-- Campos de Detalhes (Key-Value) serão injetados aqui -->
        </div>
        <button type="button" id="addDetail-btn" class="btn-add-item"><i class="fas fa-plus mr-2"></i>Adicionar Detalhe</button>

        <!-- Objetivos (List) -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Objetivos de Aprendizagem</h4>
        <div id="courseObjectives-builder" class="space-y-3">
          <!-- Campos de Objetivos (Lista) serão injetados aqui -->
        </div>
        <button type="button" id="addObjective-btn" class="btn-add-item"><i class="fas fa-plus mr-2"></i>Adicionar Objetivo</button>

        <!-- Requisitos (List) -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Requisitos</h4>
        <div id="courseRequirements-builder" class="space-y-3">
          <!-- Campos de Requisitos (Lista) serão injetados aqui -->
        </div>
        <button type="button" id="addRequirement-btn" class="btn-add-item"><i class="fas fa-plus mr-2"></i>Adicionar Requisito</button>

        <!-- Atividades Práticas (Title-Description) -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Atividades Práticas</h4>
        <div id="courseActivities-builder" class="space-y-3">
          <!-- Campos de Atividades (Title-Desc) serão injetados aqui -->
        </div>
        <button type="button" id="addActivity-btn" class="btn-add-item"><i class="fas fa-plus mr-2"></i>Adicionar Atividade</button>
        
        <!-- Módulos (Title-Topics List) -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Módulos do Curso</h4>
        <div id="courseModules-builder" class="space-y-3">
          <!-- Campos de Módulos (Title-Topics) serão injetados aqui -->
        </div>
        <button type="button" id="addModule-btn" class="btn-add-item"><i class="fas fa-plus mr-2"></i>Adicionar Módulo</button>

        
        <!-- Seção 4: Configurações -->
        <h4 class="text-lg font-bold text-gray-700 border-b pb-2 mt-4">Configurações</h4>
        <!-- Instructors Selection -->
        <div>
          <label class="admin-label">Instrutores</label>
          <div id="courseInstructorsList" class="checkbox-list">
            <!-- Checkboxes de instrutores -->
          </div>
        </div>
        
        <!-- Liberação de Avaliação -->
        <div>
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="courseIsRatingEnabled" class="h-5 w-5 accent-blue-600" />
            <span class="admin-label !mb-0">Liberar Avaliação do Curso?</span>
          </label>
          <p class="text-sm text-gray-500 mt-1">Se marcado, o botão "Avaliar Instrutor" aparecerá para alunos que fizeram check-in.</p>
        </div>

        <!-- REMOVIDO: Seção de Upload de Material -->

        <p id="courseFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4 border-t mt-6">
          <button type="button" id="courseFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="courseSubmitBtnText">Salvar Curso</span>
            <span id="courseFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Instrutor -->
  <div id="modalEditInstructor" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalInstructorTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditInstructor" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="instructorForm" class="space-y-6">
        <input type="hidden" id="instructorId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="instructorName">Nome</label>
            <input class="admin-input" type="text" id="instructorName" required>
          </div>
           <div>
            <label class="admin-label" for="instructorTitle">Título</label>
            <input class="admin-input" type="text" id="instructorTitle" placeholder="Ex: Supervisor de Marketing" required>
          </div>
        </div>
        <div>
            <label class="admin-label" for="instructorImage">URL da Foto</label>
            <input class="admin-input" type="text" id="instructorImage" placeholder="https://url-da-foto.com/perfil.jpg" required>
        </div>
        <div>
          <label class="admin-label" for="instructorBio">Biografia (Card)</label>
          <textarea class="admin-textarea" id="instructorBio" rows="3" placeholder="Pequena descrição que aparece no card..."></textarea>
        </div>
        
        <p id="instructorFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="instructorFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="instructorSubmitBtnText">Salvar Instrutor</span>
            <span id="instructorFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Modal Confirmação de Exclusão -->
  <div id="modalConfirmDelete" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-6"></i>
        <h3 class="text-2xl font-bold" style="color: var(--text);">Tem a certeza?</h3>
        <p class="text-base mt-2 mb-6" style="color: var(--text-muted);" id="modalConfirmMessage">Esta ação é irreversível.</p>
        <div class="flex justify-center gap-4">
          <button id="modalConfirmCancel" class="btn-ghost w-full">Cancelar</button>
          <button id="modalConfirmDeleteBtn" class="btn-danger w-full">Sim, Excluir</button>
        </div>
    </div>
  </div>

  <!-- REMOVIDO: Modal Admin: Emitir Certificado -->


  <!-- SCRIPTS -->

  <!-- Firebase -->
  <script type="module">
    // Importar funções do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      signInAnonymously,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      collection,
      query,
      where,
      getDocs,
      onSnapshot,
      Timestamp,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // === CONFIGURAÇÃO E INICIALIZAÇÃO ===
    
    // Configuração do Firebase
    // As variáveis __firebase_config e __app_id são injetadas pelo ambiente.
    let firebaseConfig;
    let appId;

    try {
      // Tenta usar as variáveis injetadas
      firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Fallback (plano B) se as variáveis não forem injetadas
      if (!firebaseConfig.apiKey) {
        console.warn("Variáveis de ambiente não encontradas, usando fallback.");
        firebaseConfig = {
          apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
          authDomain: "academylids.firebaseapp.com",
          projectId: "academylids",
          storageBucket: "academylids.firebasestorage.app",
          messagingSenderId: "826478835273",
          appId: "1:826478835273:web:0995d64419276b932cb198",
          measurementId: "G-T2TN7FL590"
        };
        appId = 'default-app-id'; // Use um appId de fallback se necessário
      }

    } catch (e) {
      console.error("Erro ao parsear configuração do Firebase:", e);
      // Fallback crítico em caso de erro de parse
      firebaseConfig = {
        apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
        authDomain: "academylids.firebaseapp.com",
        projectId: "academylids",
        storageBucket: "academylids.firebasestorage.app",
        messagingSenderId: "826478835273",
        appId: "1:826478835273:web:0995d64419276b932cb198",
        measurementId: "G-T2TN7FL590"
      };
      appId = 'default-app-id';
    }

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    // setLogLevel('debug'); // Descomente para logs detalhados do Firestore

    // Estado da Aplicação
    let currentUser = null;
    let isAdmin = false;
    let localCourses = []; // Cache local de cursos
    let localInstructors = []; // Cache local de instrutores
    let userCheckins = {}; // Cache de check-ins do usuário
    let currentCourseId = null; // ID do curso na página de detalhes
    
    // Referências de Coleções (Baseado nas Regras)
    const coursesCollection = collection(db, `artifacts/${appId}/public/data/courses`);
    const instructorsCollection = collection(db, `artifacts/${appId}/public/data/instructors`);
    const enrollmentsCollection = collection(db, `artifacts/${appId}/public/data/enrollments`);
    const checkinsCollection = collection(db, `artifacts/${appId}/public/data/checkins`);
    const passwordsCollection = collection(db, `artifacts/${appId}/public/data/checkinPasswords`);
    // REMOVIDO: certificatesCollection
    const ratingsCollection = collection(db, `artifacts/${appId}/public/data/ratings`);
    const adminsCollection = collection(db, 'admins'); // Coleção raiz

    // === GESTÃO DE ESTADO E UI ===

    // Elementos DOM
    const mainView = document.getElementById('main-view');
    const courseDetailView = document.getElementById('course-detail-view');
    const adminPanelView = document.getElementById('admin-panel-view');
    const coursesListOpen = document.getElementById('courses-list-open');
    const coursesListSoon = document.getElementById('courses-list-soon');
    // REMOVIDO: instructorsList
    
    // Botões de Admin/Logout
    const adminBtnHeader = document.getElementById('adminBtnHeader');
    const logoutBtnHeader = document.getElementById('logoutBtnHeader');
    const adminBtnFooter = document.getElementById('adminBtnFooter');
    const logoutBtnFooter = document.getElementById('logoutBtnFooter');
    const adminLogoutNav = document.getElementById('admin-logout-nav');
    const adminUserEmail = document.getElementById('admin-user-email');

    // Modais
    const modalLogin = document.getElementById('modalLogin');
    const modalEnroll = document.getElementById('modalEnroll');
    const modalEnrollSuccess = document.getElementById('modalEnrollSuccess');
    const modalCheckin = document.getElementById('modalCheckin');
    const modalRating = document.getElementById('modalRating');
    const modalConfirmDelete = document.getElementById('modalConfirmDelete');
    // REMOVIDO: modalCertificateCheck
    const modalEditCourse = document.getElementById('modalEditCourse');
    const modalEditInstructor = document.getElementById('modalEditInstructor');
    // REMOVIDO: modalEditCertificate

    // Função para mostrar/esconder o painel de Admin
    function setAdminUI(isAdmin) {
      if (isAdmin) {
        adminBtnHeader.textContent = "Painel Admin";
        adminBtnHeader.onclick = () => showView('admin');
        adminBtnFooter.textContent = "Painel Admin";
        adminBtnFooter.onclick = () => showView('admin');
        logoutBtnHeader.classList.remove('hidden');
        logoutBtnFooter.classList.remove('hidden');
        adminUserEmail.textContent = currentUser ? currentUser.email : '';
      } else {
        adminBtnHeader.textContent = "Admin";
        adminBtnHeader.onclick = () => _openModal(modalLogin);
        adminBtnFooter.textContent = "Acesso Admin";
        adminBtnFooter.onclick = () => _openModal(modalLogin);
        logoutBtnHeader.classList.add('hidden');
        logoutBtnFooter.classList.add('hidden');
      }
    }
    
    // Função para navegar entre as vistas
    function showView(viewName) {
      mainView.classList.add('hidden');
      courseDetailView.classList.add('hidden');
      adminPanelView.classList.add('hidden');

      if (viewName === 'main') {
        mainView.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else if (viewName === 'detail') {
        courseDetailView.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else if (viewName === 'admin') {
        if (isAdmin) {
          adminPanelView.classList.remove('hidden');
          // Carregar dados da aba default (Dashboard)
          loadAdminDashboardData();
          renderEnrollmentsChart();
          // Resetar para a aba dashboard
          document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
          document.querySelector('.admin-nav-link[data-target="admin-dashboard"]').classList.add('active');
          document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
          document.getElementById('admin-dashboard').classList.remove('hidden');
          
          window.scrollTo(0, 0);
        } else {
          // Se não for admin, volta para a main e abre o login
          mainView.classList.remove('hidden');
          _openModal(modalLogin);
        }
      }
    }

    // Função para mostrar notificações (toast)
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
      toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
      
      toast.innerHTML = `
        <i class="fas ${iconClass} icon"></i>
        <span class="toast-message">${message}</span>
        <button class="toast-close">&times;</button>
      `;
      
      container.appendChild(toast);
      
      // Animação de entrada
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Fechar
      const closeBtn = toast.querySelector('.toast-close');
      const closeToast = () => {
        toast.classList.remove('show');
        // Remover da DOM após a animação
        setTimeout(() => toast.remove(), 500);
      };
      
      closeBtn.onclick = closeToast;
      // Fechar automaticamente
      setTimeout(closeToast, 5000);
    }

    // === AUTENTICAÇÃO ===

    onAuthStateChanged(auth, async (user) => {
      // Tentativa de login com Custom Token (se injetado)
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !auth.currentUser) {
          try {
              console.log("A tentar login com Custom Token...");
              await signInWithCustomToken(auth, __initial_auth_token);
              // O onAuthStateChanged será chamado novamente com o usuário logado
              return; // Saia por agora, deixe o próximo onAuthStateChanged tratar
          } catch (error) {
              console.error("Erro no login com Custom Token:", error);
              // Continua para login anônimo se o token falhar
          }
      }
      
      if (user) {
        // Usuário está logado
        currentUser = user;
        
        if (user.isAnonymous) {
          console.log("Usuário logado anonimamente:", user.uid);
          isAdmin = false;
          setAdminUI(false);
        } else {
          console.log("Usuário logado:", user.email);
          // É um usuário com e-mail, verificar se é admin
          await checkAdminStatus(user.uid);
          setAdminUI(isAdmin);
          if (isAdmin) {
            // Se for admin, carrega dados do painel
            loadAdminDashboardData();
            renderEnrollmentsChart();
          }
        }
        
        // Carregar dados públicos (cursos, instrutores)
        // Isso agora acontece DEPOIS que a autenticação (anônima ou não) foi estabelecida
        loadCourses();
        loadInstructors(); // Carrega instrutores para o cache
        
        // Carregar dados privados do usuário (check-ins)
        loadUserCheckins(user.uid);
        
      } else {
        // Usuário está deslogado
        console.log("Nenhum usuário logado. A tentar login anônimo...");
        currentUser = null;
        isAdmin = false;
        setAdminUI(false);
        
        // Tentar login anônimo para ter permissão de leitura
        try {
          await signInAnonymously(auth);
          // O onAuthStateChanged será chamado novamente com o usuário anônimo
        } catch (error) {
          console.error("Erro no login anônimo:", error);
          showToast("Não foi possível conectar. Verifique a sua rede.", "error");
        }
      }
    });

    // Função de verificação de Admin
    async function checkAdminStatus(uid) {
      try {
        const adminDocRef = doc(db, 'admins', uid);
        const adminDoc = await getDoc(adminDocRef);
        isAdmin = adminDoc.exists();
        console.log(`Status de Admin para ${uid}: ${isAdmin}`);
      } catch (error) {
        // MUDANÇA: Tratar erro de permissão como "não-admin" sem poluir a consola
        if (error.code === 'permission-denied' || (error.message && error.message.includes('Missing or insufficient permissions'))) {
          // Isso é esperado se o usuário for um usuário normal (não-admin)
          // ou se as regras de admin ainda não estiverem 100% corretas.
          console.log("Verificação de admin falhou (permissões), assumindo não-admin.");
        } else {
          // Outros erros (ex: rede)
          console.error("Erro ao verificar status de admin:", error);
        }
        isAdmin = false;
      }
    }

    // Formulário de Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      
      try {
        errorEl.classList.add('hidden');
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        // Sucesso, o onAuthStateChanged vai tratar o resto
        _closeModal(modalLogin);
        showView('admin'); // Força a ida ao admin
        showToast(`Bem-vindo, ${userCredential.user.email}!`, 'success');
      } catch (error) {
        console.error("Erro de login:", error.code, error.message);
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          errorEl.textContent = "E-mail ou senha inválidos.";
        } else if (error.code === 'auth/operation-not-allowed') {
           errorEl.textContent = "Login por email e senha não está ativado no Firebase.";
        } else {
          errorEl.textContent = `Erro: ${error.message}`;
        }
        errorEl.classList.remove('hidden');
      }
    });

    // Função de Logout
    async function handleLogout() {
      try {
        await signOut(auth);
        // Sucesso, o onAuthStateChanged vai tratar o login anônimo
        showView('main');
        showToast("Logout realizado com sucesso.", 'success');
      } catch (error) {
        console.error("Erro no logout:", error);
      }
    }
    logoutBtnHeader.addEventListener('click', handleLogout);
    logoutBtnFooter.addEventListener('click', handleLogout);
    adminLogoutNav.addEventListener('click', (e) => {
      e.preventDefault();
      handleLogout();
    });

    // === CARREGAMENTO DE DADOS PÚBLICOS ===

    // Carregar Cursos
    async function loadCourses() {
      try {
        const querySnapshot = await getDocs(coursesCollection);
        localCourses = [];
        querySnapshot.forEach((doc) => {
          localCourses.push({ id: doc.id, ...doc.data() });
        });
        
        // Ordenar cursos (opcional, mas bom)
        localCourses.sort((a, b) => a.title.localeCompare(b.title));
        
        renderCoursesLists();
        
        // Se estiver na página de detalhes, re-renderize
        if (currentCourseId) {
          const course = localCourses.find(c => c.id === currentCourseId);
          if (course) {
            renderCourseDetail(course);
          } else {
            showView('main'); // Curso não existe mais
          }
        }
        
      } catch (error) {
        console.error("Erro ao carregar cursos:", error);
        coursesListOpen.innerHTML = `<p class="text-center md:col-span-2 text-red-500">Erro ao carregar cursos. Verifique as permissões do Firestore.</p>`;
        coursesListSoon.innerHTML = `<p class="text-center md:col-span-3 text-red-500">Erro ao carregar cursos.</p>`;
      }
    }
    
    // Carregar Instrutores
    async function loadInstructors() {
      try {
        const querySnapshot = await getDocs(instructorsCollection);
        localInstructors = [];
        querySnapshot.forEach((doc) => {
          localInstructors.push({ id: doc.id, ...doc.data() });
        });
        localInstructors.sort((a, b) => a.name.localeCompare(b.name));
        
        // renderInstructorsList(); // Função removida da UI principal
        
      } catch (error) {
        console.error("Erro ao carregar instrutores:", error);
        // instructorsList.innerHTML = `<p class="text-center md:col-span-3 text-red-500">Erro ao carregar instrutores.</p>`;
      }
    }
    
    // Carregar Check-ins do Usuário
    async function loadUserCheckins(uid) {
      if (!uid) return;
      try {
        const q = query(checkinsCollection, where("userId", "==", uid));
        const querySnapshot = await getDocs(q);
        userCheckins = {};
        querySnapshot.forEach((doc) => {
          const checkin = doc.data();
          userCheckins[checkin.courseId] = true; // Marca que o usuário fez check-in neste curso
        });
        console.log("Check-ins do usuário carregados:", userCheckins);
        
        // Se estiver na página de detalhes, atualize os botões
        if (currentCourseId) {
          const course = localCourses.find(c => c.id === currentCourseId);
          if(course) updateCourseDetailButtons(course);
        }
        
      } catch (error) {
        console.error("Erro ao carregar check-ins:", error);
      }
    }

    // === RENDERIZAÇÃO (PÁGINA PÚBLICA) ===
    
    // Renderizar Cards de Cursos na Home
    function renderCoursesLists() {
      coursesListOpen.innerHTML = '';
      coursesListSoon.innerHTML = '';
      
      const openCourses = localCourses.filter(c => c.status === 'aberto');
      const soonCourses = localCourses.filter(c => c.status === 'em_breve');

      if (openCourses.length === 0) {
        coursesListOpen.innerHTML = `<p class="text-center md:col-span-2 text-gray-500">Nenhum curso com vagas abertas no momento.</p>`;
      } else {
        openCourses.forEach(course => {
          const cardHTML = `
            <article class="card-3d p-6 reveal stagger-1 cursor-pointer course-card-solid" data-course-id="${course.id}" style="background: ${course.themeColor}; color: white; border-bottom: 5px solid ${course.themeColorDark || course.themeColor};">
              <div class="flex items-center gap-4 mb-4">
                <i class="fa-solid ${course.icon} text-3xl opacity-80" style="width: 40px;"></i>
                <div>
                  <h3 class="text-2xl font-bold">${course.title}</h3>
                  <p class="text-sm opacity-90">${course.subtitle}</p>
                </div>
              </div>
              <div class="overflow-hidden rounded-lg mb-5 shadow-inner">
                <img src="${course.headerOverlayImage}" alt="${course.title}" class="w-full h-40 object-cover opacity-90 transition-transform duration-300 hover:scale-105" />
              </div>
              <p class="mb-6 opacity-90 text-sm">${course.summary}</p>
              <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-3 px-4 rounded-lg transition-all"><i class="fa-solid fa-arrow-right mr-2"></i>Ver Detalhes</button>
            </article>
          `;
          coursesListOpen.innerHTML += cardHTML;
        });
      }
      
      if (soonCourses.length === 0) {
        coursesListSoon.innerHTML = `<p class="text-center md:col-span-3 text-gray-500">Nenhum curso futuro programado.</p>`;
      } else {
         soonCourses.forEach(course => {
            const cardHTML = `
              <div class="card-3d p-5 course-card-solid" style="background: ${course.themeColor || '#6a4c93'};">
                <span class="badge-soon mb-3" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-clock mr-2"></i>Em breve</span>
                <h4 class="font-bold text-lg mb-2">${course.title}</h4>
                <p class="text-sm opacity-90">${course.instructors ? course.instructors.map(i => i.name).join(', ') : 'Instrutores a definir'}</p>
              </div>
            `;
            coursesListSoon.innerHTML += cardHTML;
         });
      }
      
      // Re-anexar observador de animação
      document.querySelectorAll('.reveal').forEach(el => io.observe(el));
    }
    
    // Renderizar Página de Detalhes do Curso
    function renderCourseDetail(course) {
      currentCourseId = course.id; // Define o curso atual
      
      // Funções auxiliares para tentar parsear JSON
      const parseJSON = (data, fallback = []) => {
        if (!data) return fallback;
        if (Array.isArray(data) || typeof data === 'object') return data; // Já é objeto/array
        // Se não for JSON (por causa da migração antiga), trata como string simples
        if (typeof data === 'string' && !data.startsWith('[') && !data.startsWith('{')) {
          return [data]; // Transforma string simples em array
        }
        try {
          return JSON.parse(data) || fallback;
        } catch (e) {
          console.warn("Falha ao parsear JSON, tratando como texto:", data, e);
          return [data]; // Retorna a string original num array
        }
      };
      
      // Garantir que os dados dos construtores de formulário sejam arrays/objetos
      const details = course.details || {};
      const objectives = course.learningObjectives || [];
      const modules = course.modules || [];
      const activities = course.practicalActivities || [];
      const requirements = course.requirements || [];
      
      const detailsHTML = Object.entries(details).map(([key, value]) => `
        <div class="flex items-start">
          <i class="fas fa-check mt-1 mr-3" style="color: ${course.themeColor};"></i>
          <span><strong>${key}:</strong> ${value}</span>
        </div>
      `).join('');

      const instructorsHTML = (course.instructors || []).map(instructor => `
        <div class="flex items-start space-x-4">
          <img class="h-16 w-16 rounded-full object-cover shadow-lg" src="${instructor.image}" alt="${instructor.name}">
          <div>
            <p class="font-bold text-lg text-gray-800">${instructor.name}</p>
            <p class="text-sm text-gray-500">${instructor.title}</p>
            ${instructor.bio ? `<p class="text-xs text-gray-400 mt-1">${instructor.bio}</p>` : ''}
          </div>
        </div>
      `).join('');

      const modulesHTML = modules.map(module => `
        <div class="bg-gray-50 p-5 rounded-lg border-l-4" style="border-color: ${course.themeColor};">
          <h4 class="font-bold text-lg" style="color: ${course.themeColorDark || course.themeColor};">${module.title}</h4>
          <ul class="mt-3 space-y-2 list-disc list-inside text-gray-600">
            ${(module.topics || []).map(topic => `<li>${topic}</li>`).join('')}
          </ul>
        </div>
      `).join('');

      const practicalActivitiesHTML = activities.map(activity => `
        <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm">
          <h4 class="font-bold flex items-center text-lg" style="color: ${course.themeColor};"><i class="fas fa-flask mr-3"></i>${activity.title}</h4>
          <p class="text-gray-600 mt-2 pl-8">${activity.description}</p>
        </div>
      `).join('');

      const courseHTML = `
        <section class="relative text-white py-20 md:py-32 overflow-hidden course-detail-hero" style="background: linear-gradient(-45deg, ${course.themeColor}, ${course.themeColorDark || course.themeColor});">
          <div class="absolute inset-0 bg-cover bg-center opacity-20" style="background-image: url('${course.headerOverlayImage}');"></div>
          <div class="container mx-auto px-6 relative">
            <p class="text-lg font-semibold mb-2"><i class="fas ${course.icon} mr-2"></i>Evereste Academy</p>
            <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">${course.title}</h1>
            <p class="mt-2 text-xl md:text-2xl opacity-90">${course.subtitle}</p>
          </div>
        </section>
        <div class="bg-white shadow-lg -mt-16 md:-mt-20 relative z-10 max-w-6xl mx-auto rounded-t-2xl">
          <button id="back-to-courses-btn" class="mb-10 font-semibold hover:underline block p-8 pb-0" style="color: ${course.themeColor};">
            <i class="fas fa-arrow-left mr-2"></i>Voltar para todos os cursos
          </button>
          
          <div class="container mx-auto px-6 md:px-10 py-10 course-detail-content">
            <div class="grid lg:grid-cols-3 gap-12">
              <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Sobre a atividade</h2>
                <p class="text-gray-600 leading-relaxed mb-8">${course.fullDescription}</p>
                
                <h2 class="text-2xl font-bold text-gray-800 mb-4">O que irá aprender</h2>
                <ul class="space-y-3 mb-8">${objectives.map(obj => `<li class="flex items-start"><i class="fas fa-check-circle mt-1 mr-3" style="color: ${course.themeColor};"></i><span>${obj}</span></li>`).join('')}</ul>
                
                <h2 class="text-2xl font-bold text-gray-800 mb-6 mt-12">Conteúdo Programático</h2>
                <div class="space-y-6 mb-12">${modulesHTML}</div>
                
                ${practicalActivitiesHTML.length > 0 ? `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Atividades Práticas</h2>
                <div class="space-y-4 mb-12">${practicalActivitiesHTML}</div>` : ''}

                <h2 class="text-2xl font-bold text-gray-800 mb-4">Requisitos</h2>
                <ul class="space-y-3">${requirements.map(req => `<li class="flex items-start"><i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i><span>${req}</span></li>`).join('')}</ul>
              </div>
              <div class="lg:col-span-1">
                <div class="bg-gray-50 border p-6 rounded-lg shadow-xl sticky top-24">
                  <span class="inline-block text-sm font-semibold mb-4 px-3 py-1 rounded-full" style="background-color: ${course.themeColor}20; color: ${course.themeColor};">Inscrições abertas</span>
                  <h3 class="text-xl font-bold mb-4" style="color: var(--primary);">${course.title}</h3>
                  <div class="space-y-3 mb-6 text-gray-700">${detailsHTML}</div>
                  
                  <!-- Botões de Ação do Aluno -->
                  <div class="space-y-3">
                    <button id="enroll-btn-detail" class="btn-primary w-full" style="background: ${course.themeColor}; border: none;">
                      <i class="fas fa-paper-plane mr-2"></i>Inscreva-se
                    </button>
                    <button id="checkin-btn-detail" class="btn-primary w-full">
                      <i class="fas fa-check-circle mr-2"></i>Fazer Check-in
                    </button>
                    <!-- REMOVIDO: Botão Materiais -->
                    <button id="rating-btn-detail" class="btn-primary w-full btn-disabled">
                      <i class="fas fa-star mr-2"></i>Avaliar Instrutor
                    </button>
                    <!-- REMOVIDO: Botão Certificado -->
                  </div>
                </div>
              </div>
            </div>
            
            ${instructorsHTML.length > 0 ? `
            <div class="mt-16 pt-8 border-t">
              <h2 class="text-2xl font-bold text-gray-800 mb-6">Instrutores</h2>
              <div class="flex flex-col md:flex-row gap-8">${instructorsHTML}</div>
            </div>` : ''}
            
            <div class="mt-16 pt-8 border-t">
              <h2 class="text-2xl font-bold text-gray-800 mb-6">Público-alvo</h2>
              <p class="text-gray-600">${course.targetAudience}</p>
            </div>
          </div>
        </div>
      `;
      
      courseDetailView.innerHTML = courseHTML;
      showView('detail');
      updateCourseDetailButtons(course);
    }
    
    // Atualizar botões da página de detalhes (Check-in, Materiais, etc.)
    function updateCourseDetailButtons(course) {
      const hasCheckedIn = userCheckins[course.id];
      const isRatingEnabled = course.isRatingEnabled === true;

      const checkinBtn = document.getElementById('checkin-btn-detail');
      const ratingBtn = document.getElementById('rating-btn-detail');
      
      if (hasCheckedIn) {
        checkinBtn.innerHTML = '<i class="fas fa-check-double mr-2"></i>Check-in Realizado';
        checkinBtn.classList.add('btn-disabled');
        
        // Habilitar avaliação APENAS se fez check-in E admin liberou
        if (isRatingEnabled) {
          ratingBtn.classList.remove('btn-disabled');
        } else {
          ratingBtn.innerHTML = '<i class="fas fa-star mr-2"></i>Avaliação Fechada';
          ratingBtn.classList.add('btn-disabled');
        }
        
      } else {
        checkinBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Fazer Check-in';
        checkinBtn.classList.remove('btn-disabled');
        
        ratingBtn.innerHTML = '<i class="fas fa-star mr-2"></i>Avaliar Instrutor';
        ratingBtn.classList.add('btn-disabled'); // Desabilitado se não fez check-in
      }
    }


    // === AÇÕES DO ALUNO (MODAIS) ===

    // Abrir modal de Inscrição
    function openEnrollModal(courseId, courseName) {
      document.getElementById('enrollForm').reset();
      document.getElementById('enrollCourseName').textContent = courseName;
      document.getElementById('enrollError').classList.add('hidden');
      document.getElementById('enrollForm').dataset.courseId = courseId;
      document.getElementById('enrollForm').dataset.courseName = courseName;
      _openModal(modalEnroll);
    }

    // Submeter formulário de Inscrição
    document.getElementById('enrollForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showToast("Erro: Usuário não autenticado.", "error");
        return;
      }
      
      const courseId = e.target.dataset.courseId;
      const courseName = e.target.dataset.courseName;
      
      const spinner = document.getElementById('enrollSpinner');
      const btnText = document.getElementById('enrollSubmitBtnText');
      const errorEl = document.getElementById('enrollError');
      
      spinner.classList.remove('hidden');
      btnText.classList.add('hidden');
      e.target.querySelector('button[type="submit"]').disabled = true;
      errorEl.classList.add('hidden');

      try {
        const enrollmentData = {
          userId: currentUser.uid,
          courseId: courseId,
          courseName: courseName,
          name: document.getElementById('enrollName').value,
          email: document.getElementById('enrollEmail').value,
          phone: document.getElementById('enrollPhone').value,
          sector: document.getElementById('enrollSector').value,
          createdAt: serverTimestamp(),
          protocol: `EVR-${Math.random().toString(36).substr(2, 8).toUpperCase()}`
        };
        
        const docRef = await addDoc(enrollmentsCollection, enrollmentData);
        
        _closeModal(modalEnroll);
        document.getElementById('enrollProtocol').textContent = enrollmentData.protocol;
        _openModal(modalEnrollSuccess);
        
      } catch (error) {
        console.error("Erro ao inscrever:", error);
        errorEl.textContent = `Erro ao processar inscrição. Tente novamente. (${error.message})`;
        errorEl.classList.remove('hidden');
      } finally {
        spinner.classList.add('hidden');
        btnText.classList.remove('hidden');
        e.target.querySelector('button[type="submit"]').disabled = false;
      }
    });

    // Abrir modal de Check-in
    function openCheckinModal(courseId) {
      document.getElementById('checkinForm').reset();
      document.getElementById('checkinError').classList.add('hidden');
      document.getElementById('checkinForm').dataset.courseId = courseId;
      _openModal(modalCheckin);
    }
    
    // Submeter formulário de Check-in
    document.getElementById('checkinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      
      const courseId = e.target.dataset.courseId;
      const password = document.getElementById('checkinPassword').value;
      
      const spinner = document.getElementById('checkinSpinner');
      const btnText = document.getElementById('checkinSubmitBtnText');
      const errorEl = document.getElementById('checkinError');
      
      spinner.classList.remove('hidden');
      btnText.classList.add('hidden');
      e.target.querySelector('button[type="submit"]').disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        // A lógica de validação da senha está 100% nas Regras de Segurança do Firestore
        // Apenas tentamos escrever o documento com a senha
        await addDoc(checkinsCollection, {
          userId: currentUser.uid,
          courseId: courseId,
          password: password, // A regra vai comparar isso
          createdAt: serverTimestamp()
        });
        
        // Sucesso!
        userCheckins[courseId] = true; // Atualiza cache local
        _closeModal(modalCheckin);
        showToast("Check-in realizado com sucesso!", "success");
        
        // Atualiza botões na página de detalhes
        const course = localCourses.find(c => c.id === courseId);
        if(course) updateCourseDetailButtons(course);
        
      } catch (error) {
        console.error("Erro no check-in:", error);
        if (error.code === 'permission-denied') {
          errorEl.textContent = "Senha incorreta. Tente novamente.";
        } else {
          errorEl.textContent = `Erro ao validar. (${error.message})`;
        }
        errorEl.classList.remove('hidden');
      } finally {
        spinner.classList.add('hidden');
        btnText.classList.remove('hidden');
        e.target.querySelector('button[type="submit"]').disabled = false;
      }
    });
    
    // Abrir modal de Avaliação
    function openRatingModal(courseId) {
      const form = document.getElementById('ratingForm');
      form.reset();
      document.getElementById('ratingError').classList.add('hidden');
      form.dataset.courseId = courseId;
      
      // Limpar estrelas
      document.querySelectorAll('#ratingStars i').forEach(star => {
        star.classList.remove('text-yellow-400');
        star.classList.add('text-gray-300');
      });
      document.getElementById('ratingValue').value = "0";
      
      // Popular select de instrutores
      const select = document.getElementById('ratingInstructorSelect');
      select.innerHTML = '<option value="">Selecione um instrutor</option>';
      const course = localCourses.find(c => c.id === courseId);
      if (course && course.instructors) {
        course.instructors.forEach(inst => {
          select.innerHTML += `<option value="${inst.name}">${inst.name}</option>`;
        });
      }
      _openModal(modalRating);
    }
    
    // Lógica das estrelas de avaliação
    document.getElementById('ratingStars').addEventListener('click', (e) => {
      const star = e.target.closest('i');
      if (!star) return;
      const value = star.dataset.value;
      document.getElementById('ratingValue').value = value;
      // Atualizar visual
      document.querySelectorAll('#ratingStars i').forEach(s => {
        if (s.dataset.value <= value) {
          s.classList.add('text-yellow-400');
          s.classList.remove('text-gray-300');
        } else {
          s.classList.remove('text-yellow-400');
          s.classList.add('text-gray-300');
        }
      });
    });

    // Submeter formulário de Avaliação
    document.getElementById('ratingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const courseId = e.target.dataset.courseId;
      const ratingValue = document.getElementById('ratingValue').value;
      
      if (ratingValue === "0") {
        document.getElementById('ratingError').textContent = "Por favor, selecione de 1 a 5 estrelas.";
        document.getElementById('ratingError').classList.remove('hidden');
        return;
      }
      
      const spinner = document.getElementById('ratingSpinner');
      const btnText = document.getElementById('ratingSubmitBtnText');
      const errorEl = document.getElementById('ratingError');
      
      spinner.classList.remove('hidden');
      btnText.classList.add('hidden');
      e.target.querySelector('button[type="submit"]').disabled = true;
      errorEl.classList.add('hidden');

      try {
        await addDoc(ratingsCollection, {
          userId: currentUser.uid,
          courseId: courseId,
          instructorName: document.getElementById('ratingInstructorSelect').value,
          rating: parseInt(ratingValue, 10),
          comment: document.getElementById('ratingComment').value,
          createdAt: serverTimestamp()
        });
        
        _closeModal(modalRating);
        showToast("Avaliação enviada. Obrigado!", "success");
        
      } catch (error) {
        console.error("Erro ao enviar avaliação:", error);
        errorEl.textContent = `Erro ao enviar. Tente novamente. (${error.message})`;
        errorEl.classList.remove('hidden');
      } finally {
        spinner.classList.add('hidden');
        btnText.classList.remove('hidden');
        e.target.querySelector('button[type="submit"]').disabled = false;
      }
    });

    // === PAINEL DE ADMINISTRAÇÃO ===
    
    // Navegação do Painel Admin
    document.getElementById('admin-nav').addEventListener('click', (e) => {
      const link = e.target.closest('.admin-nav-link');
      if (link && link.dataset.target) {
        e.preventDefault();
        // Mudar tab ativa
        document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        // Mudar seção visível
        document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
        document.getElementById(link.dataset.target).classList.remove('hidden');
        
        // Carregar dados da seção
        switch(link.dataset.target) {
          case 'admin-dashboard': loadAdminDashboardData(); renderEnrollmentsChart(); break;
          case 'admin-cursos': loadAdminCourses(); break;
          case 'admin-matriculas': loadAdminEnrollments(); break;
          case 'admin-instrutores': loadAdminInstructors(); break;
          case 'admin-config': loadCheckinPasswords(); break;
        }
      }
    });
    
    // Carregar dados do Dashboard (Stats e Gráfico)
    let enrollmentsChartInstance = null;
    async function loadAdminDashboardData() {
      // Carregar Stats
      try {
        const enrollmentsSnap = await getDocs(enrollmentsCollection);
        document.getElementById('stats-total-enrollments').textContent = enrollmentsSnap.size;
      } catch (e) { console.error("Erro ao carregar stats matrículas:", e); }
      
      try {
        const checkinsSnap = await getDocs(checkinsCollection);
        document.getElementById('stats-total-checkins').textContent = checkinsSnap.size;
      } catch (e) { console.error("Erro ao carregar stats checkins:", e); }
    }
    
    // Renderizar Gráfico de Matrículas
    async function renderEnrollmentsChart() {
      let enrollmentsData = [];
      try {
        const q = query(enrollmentsCollection);
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.createdAt && data.createdAt.toDate) {
            enrollmentsData.push({ date: data.createdAt.toDate() });
          }
        });
        
        // Agrupar por dia
        const enrollmentsByDay = enrollmentsData.reduce((acc, curr) => {
          const day = curr.date.toISOString().split('T')[0];
          acc[day] = (acc[day] || 0) + 1;
          return acc;
        }, {});
        
        // Preparar dados para o gráfico
        const sortedDays = Object.keys(enrollmentsByDay).sort();
        const labels = sortedDays.map(day => {
          const [year, month, d] = day.split('-');
          return `${d}/${month}`;
        });
        const data = sortedDays.map(day => enrollmentsByDay[day]);
        
        const ctx = document.getElementById('enrollmentsChart').getContext('2d');
        
        if (enrollmentsChartInstance) {
          enrollmentsChartInstance.destroy(); // Destrói gráfico anterior
        }
        
        enrollmentsChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Novas Matrículas',
              data: data,
              borderColor: 'rgba(0, 102, 204, 1)',
              backgroundColor: 'rgba(0, 102, 204, 0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
        
      } catch (e) {
        console.error("Erro ao renderizar gráfico:", e);
      }
    }

    // Carregar Cursos (Admin)
    async function loadAdminCourses() {
      const tableBody = document.getElementById('admin-courses-table-body');
      tableBody.innerHTML = '<tr><td colspan="5">A carregar cursos...</td></tr>';
      
      // Re-usa o cache local
      if (localCourses.length === 0) {
        await loadCourses(); // Garante que temos os dados
      }
      
      // NOVO FILTRO: Mostrar apenas cursos 'aberto' ou 'em_breve'
      const visibleCourses = localCourses.filter(
        course => course.status === 'aberto' || course.status === 'em_breve'
      );

      if (visibleCourses.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5">Nenhum curso "Aberto" ou "Em Breve" encontrado. (Cursos fechados ficam ocultos)</td></tr>';
        return;
      }
      
      tableBody.innerHTML = visibleCourses.map(course => {
        let statusClass = 'bg-yellow-100 text-yellow-700'; // Default 'em_breve'
        if (course.status === 'aberto') statusClass = 'bg-green-100 text-green-700';
        // if (course.status === 'fechado') statusClass = 'bg-gray-100 text-gray-700'; // Removido pois agora são filtrados

        // Tenta buscar a data
        const courseDate = course.details && course.details.Data ? course.details.Data : 'N/A';

        return `
          <tr data-id="${course.id}">
            <td class="font-medium">${course.title}</td>
            <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${course.status}</span></td>
            <td class="text-sm">${courseDate}</td>
            <td>
              <span class="px-2 py-1 text-xs font-semibold rounded-full ${course.isRatingEnabled ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}">
                ${course.isRatingEnabled ? 'Aberta' : 'Fechada'}
              </span>
            </td>
            <td class="actions">
              <button class="btn-edit !px-3 !py-2 !text-xs" data-action="edit-course" title="Editar"><i class="fas fa-pencil"></i></button>
              <button class="btn-danger !px-3 !py-2 !text-xs" data-action="delete-course" title="Excluir"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `
      }).join('');
    }
    
    // Carregar Matrículas (Admin)
    async function loadAdminEnrollments() {
      const tableBody = document.getElementById('admin-enrollments-table-body');
      tableBody.innerHTML = '<tr><td colspan="7">A carregar matrículas...</td></tr>';
      
      try {
        const q = query(enrollmentsCollection); // Poderia adicionar orderBy
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          tableBody.innerHTML = '<tr><td colspan="7">Nenhuma matrícula encontrada.</td></tr>';
          return;
        }
        
        let rows = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          rows.push({ id: doc.id, ...data });
        });
        
        // Ordenar por data (mais recente primeiro)
        rows.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
        
        tableBody.innerHTML = rows.map(data => `
          <tr data-id="${data.id}">
            <td class="font-mono text-xs">${data.protocol}</td>
            <td class="font-medium">${data.name}</td>
            <td>${data.email}</td>
            <td>${data.courseName}</td>
            <td>${data.createdAt ? data.createdAt.toDate().toLocaleDateString('pt-PT') : 'N/A'}</td>
            <td>${data.sector}</td>
            <td class="actions">
              <button class="btn-danger !px-3 !py-2 !text-xs" data-action="delete-enrollment" title="Excluir"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
        
      } catch (e) {
        console.error("Erro ao carregar matrículas:", e);
        tableBody.innerHTML = `<tr><td colspan="7" class="text-red-500">Erro ao carregar matrículas: ${e.message}</td></tr>`;
      }
    }
    
    // Carregar Instrutores (Admin)
    async function loadAdminInstructors() {
      const tableBody = document.getElementById('admin-instructors-table-body');
      tableBody.innerHTML = '<tr><td colspan="4">A carregar instrutores...</td></tr>';
      
      // Re-usa o cache local
      if (localInstructors.length === 0) {
        await loadInstructors(); // Garante que temos os dados
      }
      
      if (localInstructors.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4">Nenhum instrutor encontrado.</td></tr>';
        return;
      }
      
      tableBody.innerHTML = localInstructors.map(inst => `
        <tr data-id="${inst.id}">
          <td><img src="${inst.image}" alt="${inst.name}" class="w-10 h-10 rounded-full object-cover"></td>
          <td class="font-medium">${inst.name}</td>
          <td class="text-sm">${inst.title}</td>
          <td class="actions">
            <button class="btn-edit !px-3 !py-2 !text-xs" data-action="edit-instructor" title="Editar"><i class="fas fa-pencil"></i></button>
            <button class="btn-danger !px-3 !py-2 !text-xs" data-action="delete-instructor" title="Excluir"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }
    
    // Carregar Senhas de Check-in (Admin)
    async function loadCheckinPasswords() {
      const form = document.getElementById('checkin-passwords-form');
      form.innerHTML = '<p class="text-sm text-gray-400">A carregar senhas...</p>';
      
      try {
        const docRef = doc(passwordsCollection, 'allCourses');
        const docSnap = await getDoc(docRef);
        const passwords = docSnap.exists() ? docSnap.data() : {};
        
        if (localCourses.length === 0) {
          await loadCourses();
        }
        
        // FILTRO ADICIONADO: Mostrar apenas cursos relevantes
        const relevantCourses = localCourses.filter(
          course => course.status === 'aberto' || course.status === 'em_breve'
        );
        
        if (relevantCourses.length === 0) {
           form.innerHTML = '<p class="text-sm text-gray-500">Nenhum curso "Aberto" ou "Em Breve" encontrado para definir senhas.</p>';
           return;
        }
        
        form.innerHTML = relevantCourses.map(course => `
          <div>
            <label class="admin-label" for="pass-${course.id}">${course.title}</label>
            <input type="text" id="pass-${course.id}" data-course-id="${course.id}" class="admin-input" value="${passwords[course.id] || ''}" placeholder="Senha para ${course.title}">
          </div>
        `).join('');
        
      } catch (e) {
        console.error("Erro ao carregar senhas:", e);
        form.innerHTML = `<p class="text-sm text-red-500">Erro ao carregar senhas: ${e.message}</p>`;
      }
    }
    
    // Salvar Senhas de Check-in
    document.getElementById('save-checkin-passwords-btn').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>A salvar...';
      
      const passwordData = {};
      document.querySelectorAll('#checkin-passwords-form input').forEach(input => {
        if (input.value) {
          passwordData[input.dataset.courseId] = input.value;
        }
      });
      
      try {
        const docRef = doc(passwordsCollection, 'allCourses');
        await setDoc(docRef, passwordData, { merge: true });
        showToast("Senhas de check-in salvas!", "success");
      } catch (e) {
        console.error("Erro ao salvar senhas:", e);
        showToast(`Erro ao salvar senhas: ${e.message}`, "error");
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Senhas';
      }
    });

    // --- ADMIN: ABRIR MODAIS ---
    
    // Abrir Modal de Curso (para Adicionar ou Editar)
    document.getElementById('admin-add-course-btn').addEventListener('click', () => openCourseModal());

    function openCourseModal(course = null) {
      const form = document.getElementById('courseForm');
      form.reset();
      document.getElementById('courseFormError').classList.add('hidden');
      
      const modalTitle = document.getElementById('modalCourseTitle');
      const courseIdField = document.getElementById('courseId');
      
      // Popular checkboxes de instrutores
      const instList = document.getElementById('courseInstructorsList');
      instList.innerHTML = localInstructors.map(inst => `
        <label>
          <input type="checkbox" value="${inst.id}">
          <span>${inst.name}</span>
        </label>
      `).join('');
      
      // Limpar construtores dinâmicos
      document.getElementById('courseDetails-builder').innerHTML = '';
      document.getElementById('courseObjectives-builder').innerHTML = '';
      document.getElementById('courseRequirements-builder').innerHTML = '';
      document.getElementById('courseActivities-builder').innerHTML = '';
      document.getElementById('courseModules-builder').innerHTML = '';
      
      if (course) {
        // --- MODO EDIÇÃO ---
        modalTitle.textContent = "Editar Curso";
        courseIdField.value = course.id;
        document.getElementById('courseTitle').value = course.title || '';
        document.getElementById('courseSubtitle').value = course.subtitle || '';
        document.getElementById('courseThemeColor').value = course.themeColor || '';
        document.getElementById('courseIcon').value = course.icon || '';
        document.getElementById('courseStatus').value = course.status || 'aberto';
        document.getElementById('courseHeaderImage').value = course.headerOverlayImage || '';
        document.getElementById('courseSummary').value = course.summary || '';
        document.getElementById('courseFullDescription').value = course.fullDescription || '';
        document.getElementById('courseTargetAudience').value = course.targetAudience || '';
        document.getElementById('courseIsRatingEnabled').checked = course.isRatingEnabled || false;
        
        // Popular construtores dinâmicos
        (course.details ? Object.entries(course.details) : []).forEach(([key, value]) => addDetailField(key, value));
        (course.learningObjectives || []).forEach(value => addListItemField('courseObjectives-builder', value));
        (course.requirements || []).forEach(value => addListItemField('courseRequirements-builder', value));
        (course.practicalActivities || []).forEach(activity => addActivityField(activity));
        (course.modules || []).forEach(module => addModuleField(module));
        
        // Marcar checkboxes de instrutores
        const instructorIds = (course.instructors || []).map(i => i.id);
        instList.querySelectorAll('input').forEach(checkbox => {
          if (instructorIds.includes(checkbox.value)) {
            checkbox.checked = true;
          }
        });

      } else {
        // --- MODO ADICIONAR NOVO ---
        modalTitle.textContent = "Adicionar Novo Curso";
        courseIdField.value = '';
        // Adiciona um campo vazio para começar
        addDetailField();
        addListItemField('courseObjectives-builder');
        addListItemField('courseRequirements-builder');
        addActivityField();
        addModuleField();
      }
      
      _openModal(modalEditCourse);
    }
    
    // Abrir Modal de Instrutor (para Adicionar ou Editar)
    document.getElementById('admin-add-instructor-btn').addEventListener('click', () => openInstructorModal());
    
    function openInstructorModal(instructor = null) {
      const form = document.getElementById('instructorForm');
      form.reset();
      document.getElementById('instructorFormError').classList.add('hidden');
      
      const modalTitle = document.getElementById('modalInstructorTitle');
      const idField = document.getElementById('instructorId');
      
      if (instructor) {
        // Editar
        modalTitle.textContent = "Editar Instrutor";
        idField.value = instructor.id;
        document.getElementById('instructorName').value = instructor.name || '';
        document.getElementById('instructorTitle').value = instructor.title || '';
        document.getElementById('instructorImage').value = instructor.image || '';
        document.getElementById('instructorBio').value = instructor.bio || '';
      } else {
        // Adicionar
        modalTitle.textContent = "Adicionar Novo Instrutor";
        idField.value = '';
      }
      _openModal(modalEditInstructor);
    }
    
    // Abrir Modal de Confirmação de Exclusão
    let _onConfirmDelete = null; // Armazena a função a ser chamada
    function openConfirmModal(message, onConfirm) {
      document.getElementById('modalConfirmMessage').textContent = message;
      _onConfirmDelete = onConfirm;
      _openModal(modalConfirmDelete);
    }
    
    document.getElementById('modalConfirmCancel').addEventListener('click', () => {
      _onConfirmDelete = null;
      _closeModal(modalConfirmDelete);
    });

    document.getElementById('modalConfirmDeleteBtn').addEventListener('click', async () => {
      if (typeof _onConfirmDelete === 'function') {
        const btn = document.getElementById('modalConfirmDeleteBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i>';
        
        try {
          await _onConfirmDelete(); // Executa a função de exclusão
        } catch (e) {
          console.error("Erro ao excluir:", e);
          showToast(`Erro ao excluir: ${e.message}`, 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'Sim, Excluir';
          _onConfirmDelete = null;
          _closeModal(modalConfirmDelete);
        }
      }
    });


    // --- ADMIN: SALVAR DADOS (FORMULÁRIOS) ---
    
    // Salvar Curso (Adicionar ou Editar)
    document.getElementById('courseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('courseSubmitBtnText');
      const spinner = document.getElementById('courseFormSpinner');
      const errorEl = document.getElementById('courseFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      const courseId = document.getElementById('courseId').value;
      const finalCourseId = courseId || doc(collection(db, 'temp')).id; // Gere um ID se for novo

      try {
        // --- 1. Coletar Dados (dos formulários dinâmicos) ---
        let courseData;
        let selectedInstructors = [];
        
        // Coletar instrutores selecionados
        document.querySelectorAll('#courseInstructorsList input:checked').forEach(checkbox => {
          const inst = localInstructors.find(i => i.id === checkbox.value);
          if (inst) {
            selectedInstructors.push({
              id: inst.id, name: inst.name, title: inst.title, image: inst.image, bio: inst.bio || ''
            });
          }
        });
          
        // Coletar Detalhes (Key-Value)
        const details = {};
        document.querySelectorAll('#courseDetails-builder .form-builder-item').forEach(pair => {
            const key = pair.querySelector('.key').value;
            const value = pair.querySelector('.value').value;
            if (key && value) details[key] = value;
        });

        // Coletar Objetivos (Lista)
        const objectives = [];
        document.querySelectorAll('#courseObjectives-builder .form-builder-item').forEach(item => {
            const value = item.querySelector('.value').value;
            if (value) objectives.push(value);
        });
        
        // Coletar Requisitos (Lista)
        const requirements = [];
        document.querySelectorAll('#courseRequirements-builder .form-builder-item').forEach(item => {
            const value = item.querySelector('.value').value;
            if (value) requirements.push(value);
        });
        
        // Coletar Atividades (Title-Desc)
        const activities = [];
        document.querySelectorAll('#courseActivities-builder .form-builder-item').forEach(item => {
            const title = item.querySelector('.title').value;
            const description = item.querySelector('.description').value;
            if (title && description) activities.push({ title, description });
        });
        
        // Coletar Módulos (Title-Topics)
        const modules = [];
        document.querySelectorAll('#courseModules-builder .form-builder-item').forEach(item => {
            const title = item.querySelector('.title').value;
            const topics = [];
            item.querySelectorAll('.module-topic-item').forEach(topicItem => {
              const topicValue = topicItem.querySelector('.value').value;
              if (topicValue) topics.push(topicValue);
            });
            if (title) modules.push({ title, topics });
        });

        courseData = {
          title: document.getElementById('courseTitle').value,
          subtitle: document.getElementById('courseSubtitle').value,
          themeColor: document.getElementById('courseThemeColor').value,
          themeColorDark: document.getElementById('courseThemeColor').value, // Pode ser customizado
          icon: document.getElementById('courseIcon').value,
          status: document.getElementById('courseStatus').value,
          headerOverlayImage: document.getElementById('courseHeaderImage').value,
          summary: document.getElementById('courseSummary').value,
          fullDescription: document.getElementById('courseFullDescription').value,
          targetAudience: document.getElementById('courseTargetAudience').value,
          isRatingEnabled: document.getElementById('courseIsRatingEnabled').checked,
          
          // Dados dos construtores
          details: details,
          learningObjectives: objectives,
          requirements: requirements,
          practicalActivities: activities,
          modules: modules,
          instructors: selectedInstructors
        };
        
        // --- 2. Salvar no Firestore ---
        try {
          const docRef = doc(coursesCollection, finalCourseId);
          await setDoc(docRef, courseData, { merge: true });
        } catch (dbError) {
          console.error("Erro ao salvar no Firestore:", dbError);
          throw new Error(`Erro ao Salvar: Não foi possível salvar no banco de dados. ${dbError.message}`);
        }
        
        // --- 3. Sucesso ---
        _closeModal(modalEditCourse);
        showToast(`Curso "${courseData.title}" salvo com sucesso!`, 'success');
        loadCourses(); // Recarrega a lista principal
        loadAdminCourses(); // Recarrega a tabela do admin
        
      } catch (error) {
        // Captura qualquer erro
        console.error("Erro geral ao salvar curso:", error);
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
      } finally {
        // Sempre reabilita o botão e esconde o spinner
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // --- INSTRUTORES ---
    document.getElementById('instructorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('instructorSubmitBtnText');
      const spinner = document.getElementById('instructorFormSpinner');
      const errorEl = document.getElementById('instructorFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      const instructorId = document.getElementById('instructorId').value;
      
      const instructorData = {
        name: document.getElementById('instructorName').value,
        title: document.getElementById('instructorTitle').value,
        image: document.getElementById('instructorImage').value,
        bio: document.getElementById('instructorBio').value,
      };
      
      try {
        let docRef;
        if (instructorId) {
          // Editar
          docRef = doc(instructorsCollection, instructorId);
          await updateDoc(docRef, instructorData);
        } else {
          // Adicionar
          docRef = await addDoc(instructorsCollection, instructorData);
        }
        
        _closeModal(modalEditInstructor);
        showToast(`Instrutor "${instructorData.name}" salvo com sucesso!`, 'success');
        loadInstructors(); // Recarrega o cache
        loadAdminInstructors(); // Recarrega a tabela
        
      } catch (error) {
        console.error("Erro ao salvar instrutor:", error);
        errorEl.textContent = `Erro ao salvar: ${error.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // --- Funções Helper do Construtor de Formulário ---
    
    // Adicionar Key-Value (Detalhes)
    function addDetailField(key = '', value = '') {
      const container = document.getElementById('courseDetails-builder');
      const div = document.createElement('div');
      div.className = 'form-builder-item key-value-pair';
      div.innerHTML = `
        <div class="form-builder-item-content">
          <input type="text" placeholder="Chave (Ex: Carga)" class="admin-input key" value="${key}">
          <input type="text" placeholder="Valor (Ex: 4 horas)" class="admin-input value" value="${value}">
        </div>
        <button type="button" class="btn-danger-outline remove-item-btn"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(div);
    }
    
    // Adicionar Item de Lista Simples (Objetivos, Requisitos)
    function addListItemField(containerId, value = '') {
      const container = document.getElementById(containerId);
      const div = document.createElement('div');
      div.className = 'form-builder-item list-item';
      div.innerHTML = `
        <div class="form-builder-item-content">
          <input type="text" placeholder="Texto do item" class="admin-input value" value="${value}">
        </div>
        <button type="button" class="btn-danger-outline remove-item-btn !mt-0"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(div);
    }
    
    // Adicionar Atividade (Title-Description)
    function addActivityField(activity = { title: '', description: '' }) {
      const container = document.getElementById('courseActivities-builder');
      const div = document.createElement('div');
      div.className = 'form-builder-item activity';
      div.innerHTML = `
        <div class="form-builder-item-content">
          <input type="text" placeholder="Título da Atividade" class="admin-input title" value="${activity.title}">
          <textarea placeholder="Descrição da Atividade" class="admin-input description">${activity.description}</textarea>
        </div>
        <button type="button" class="btn-danger-outline remove-item-btn"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(div);
    }
    
    // Adicionar Módulo (Title-Topics List)
    function addModuleField(module = { title: '', topics: [] }) {
      const container = document.getElementById('courseModules-builder');
      const div = document.createElement('div');
      div.className = 'form-builder-item module';
      
      const topicsHTML = module.topics.map(topic => `
        <div class="module-topic-item">
          <input type="text" placeholder="Tópico" class="admin-input value" value="${topic}">
          <button type="button" class="btn-danger-outline remove-sub-item-btn !mt-0"><i class="fas fa-times"></i></button>
        </div>
      `).join('');
      
      div.innerHTML = `
        <div class="form-builder-item-content">
          <input type="text" placeholder="Título do Módulo" class="admin-input title" value="${module.title}">
          <div class="module-topics-container space-y-2">
            <label class="admin-label !text-xs !mb-0">Tópicos do Módulo:</label>
            ${topicsHTML}
            <button type="button" class="btn-add-item !text-xs !px-2 !py-1 add-topic-btn"><i class="fas fa-plus mr-1"></i>Tópico</button>
          </div>
        </div>
        <button type="button" class="btn-danger-outline remove-item-btn"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(div);
    }
    
    // Listeners para botões "Adicionar"
    document.getElementById('addDetail-btn').addEventListener('click', () => addDetailField());
    document.getElementById('addObjective-btn').addEventListener('click', () => addListItemField('courseObjectives-builder'));
    document.getElementById('addRequirement-btn').addEventListener('click', () => addListItemField('courseRequirements-builder'));
    document.getElementById('addActivity-btn').addEventListener('click', () => addActivityField());
    document.getElementById('addModule-btn').addEventListener('click', () => addModuleField());
    
    // Listener para "Remover" itens (delegação de evento)
    document.getElementById('courseForm').addEventListener('click', (e) => {
      // Remover item principal
      if (e.target.closest('.remove-item-btn')) {
        e.target.closest('.form-builder-item').remove();
      }
      
      // Adicionar tópico de módulo
      if (e.target.closest('.add-topic-btn')) {
        const topicsContainer = e.target.closest('.module-topics-container');
        const div = document.createElement('div');
        div.className = 'module-topic-item';
        div.innerHTML = `
          <input type="text" placeholder="Tópico" class="admin-input value" value="">
          <button type="button" class="btn-danger-outline remove-sub-item-btn !mt-0"><i class="fas fa-times"></i></button>
        `;
        // Insere antes do botão "Adicionar Tópico"
        topicsContainer.insertBefore(div, e.target.closest('.add-topic-btn'));
      }
      
      // Remover tópico de módulo
      if (e.target.closest('.remove-sub-item-btn')) {
        e.target.closest('.module-topic-item').remove();
      }
    });
    
    
    // === GESTÃO DE CLIQUES (Event Delegation) ===
    
    // Cliques na Lista de Cursos (Home)
    document.getElementById('courses-list-open').addEventListener('click', (e) => {
      const card = e.target.closest('[data-course-id]');
      if (card) {
        const courseId = card.dataset.courseId;
        const course = localCourses.find(c => c.id === courseId);
        if (course) {
          renderCourseDetail(course);
        } else {
          console.warn("Curso não encontrado no cache:", courseId);
        }
      }
    });

    // Cliques na Página de Detalhes do Curso
    courseDetailView.addEventListener('click', (e) => {
      const course = localCourses.find(c => c.id === currentCourseId);
      if (!course) return; // Não faz nada se o curso não estiver carregado

      // Voltar
      if (e.target.closest('#back-to-courses-btn')) {
        showView('main');
        currentCourseId = null; // Limpa o ID do curso atual
      }
      // Abrir modal de inscrição
      if (e.target.closest('#enroll-btn-detail')) {
        openEnrollModal(course.id, course.title);
      }
      // Abrir modal de check-in (se o botão não estiver desabilitado)
      if (e.target.closest('#checkin-btn-detail') && !e.target.closest('.btn-disabled')) {
        openCheckinModal(course.id);
      }
      // Abrir modal de avaliação (se o botão não estiver desabilitado)
      if (e.target.closest('#rating-btn-detail') && !e.target.closest('.btn-disabled')) {
        openRatingModal(course.id);
      }
    });
    
    // Cliques no Painel de Admin
    document.getElementById('admin-panel-view').addEventListener('click', async (e) => {
      const actionButton = e.target.closest('[data-action]');
      if (!actionButton) return;
      
      const action = actionButton.dataset.action;
      const row = actionButton.closest('tr');
      const id = row?.dataset.id;
      
      switch (action) {
        // --- Ações de Curso ---
        case 'edit-course':
          const course = localCourses.find(c => c.id === id);
          if (course) openCourseModal(course);
          break;
        case 'delete-course':
          openConfirmModal(`Tem a certeza que quer excluir o curso "${id}"? Esta ação não pode ser desfeita.`, async () => {
            await deleteDoc(doc(coursesCollection, id));
            showToast("Curso excluído com sucesso.", "success");
            loadCourses(); // Recarrega cache
            loadAdminCourses(); // Recarrega tabela
          });
          break;
          
        // --- Ações de Instrutor ---
        case 'edit-instructor':
          const instructor = localInstructors.find(i => i.id === id);
          if (instructor) openInstructorModal(instructor);
          break;
        case 'delete-instructor':
          openConfirmModal(`Tem a certeza que quer excluir o instrutor "${id}"?`, async () => {
            await deleteDoc(doc(instructorsCollection, id));
            showToast("Instrutor excluído com sucesso.", "success");
            loadInstructors(); // Recarrega cache
            loadAdminInstructors(); // Recarrega tabela
          });
          break;
        
        // --- Ações de Matrícula ---
        case 'delete-enrollment':
          openConfirmModal(`Tem a certeza que quer excluir esta matrícula ("${id}")?`, async () => {
            await deleteDoc(doc(enrollmentsCollection, id));
            showToast("Matrícula excluída com sucesso.", "success");
            loadAdminEnrollments(); // Recarrega tabela
            loadAdminDashboardData(); // Atualiza contagem
          });
          break;
      }
    });
    
    // Botão de Popular DB
    document.getElementById('populate-db-btn').addEventListener('click', async (e) => {
      if (!isAdmin) {
        showToast("Apenas administradores podem executar esta ação.", "error");
        return;
      }
      
      const btn = e.target.closest('button');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>A popular...';

      try {
        const { initialCourses, initialInstructors } = getInitialData();
        
        const batch = writeBatch(db);
        
        // Adicionar instrutores
        initialInstructors.forEach(inst => {
          const docRef = doc(instructorsCollection, inst.id);
          batch.set(docRef, inst);
        });
        
        // Adicionar cursos
        initialCourses.forEach(course => {
          const docRef = doc(coursesCollection, course.id);
          batch.set(docRef, course);
        });
        
        await batch.commit();
        showToast("Banco de dados populado com dados iniciais!", "success");
        
        // Recarregar tudo
        loadCourses();
        loadInstructors();
        loadAdminCourses();
        loadAdminInstructors();
        
      } catch (error) {
        console.error("Erro ao popular DB:", error);
        showToast(`Erro ao popular banco de dados: ${error.message}`, "error");
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-database mr-2"></i>Popular Dados Iniciais';
      }
    });
    
    // === DADOS INICIAIS (POPULAR DB) ===
    function getInitialData() {
      const initialInstructors = [
        { id: "marllon", name: "Marllon Costa", title: "Técnico em TI | Designer | Inovação e IA", image: "https://i.postimg.cc/sxm4TVvF/IMG-9781.jpg", bio: "Designer gráfico, graduando em marketing e autodidata em Inovação e IA." },
        { id: "vinicius", name: "Vinícius Sena", title: "Fotógrafo Documental | Pós-produção", image: "https://i.postimg.cc/bw7kHG3D/vinicius.jpg", bio: "Formado em Animação, estudante e entusiasta de fotografia desde 2019." },
        { id: "bruno", name: "Bruno Diogo", title: "Supervisor de Marketing | Designer | UX/UI", image: "https://i.postimg.cc/yNhgmLJK/IMG-7311.avif", bio: "Supervisor de Marketing e Mídias Visuais | Designer Gráfico e Digital." },
        { id: "keven", name: "Keven Menezes", title: "Analista de TI | Designer Gráfico | Motion", image: "https://i.postimg.cc/fTgkcmpP/Whats-App-Image-2025-10-27-at-12-11-25.jpg", bio: "Formado em Design Gráfico e possui mais de 5 anos de experiência." },
        { id: "deyse", name: "Deyse Pereira", title: "Estrategista em Comunicação | Gestão de Projetos", image: "https://i.postimg.cc/T1sL3bXz/IMG-7381-jpg.png", bio: "Mestre em Design de Artefatos Digitais, pós-graduanda em Gestão de Projetos." }
      ];
      
      const initialCourses = [
        {
          id: "fotografia",
          title: "Workshop de Fotografia",
          subtitle: "O Olhar que Conecta Histórias",
          summary: "Aprenda a capturar a essência dos nossos projetos com sensibilidade e técnica.",
          fullDescription: "No Instituto Evereste, cada imagem conta uma parte da nossa história. Este workshop é um convite para desenvolver a sua percepção e criatividade.",
          targetAudience: "O Curso de Fotografia é voltado para pessoas que desejam explorar o poder da imagem como forma de expressão, comunicação e transformação social.",
          themeColor: "#FFC107",
          themeColorDark: "#E6A700",
          icon: "fa-camera-retro",
          status: "aberto",
          headerOverlayImage: "https://i.postimg.cc/3rLTy2xn/medium-shot-people-with-camera.jpg",
          details: {"Data": "28 de Outubro de 2025", "Horário": "08:30h - 12:15h", "Carga": "4 horas", "Modalidade": "Presencial e Online"},
          learningObjectives: [
            "Introduzir conceitos básicos de fotografia.",
            "Desenvolver habilidades práticas com câmaras e celulares.",
            "Capacitar para o registo de eventos e projetos."
          ],
          modules: [
            { "title": "Módulo 1: Fundamentos", "topics": ["Introdução", "Equipamento", "ISO, lentes e flash"] },
            { "title": "Módulo 2: Composição", "topics": ["Enquadramento", "Luz dura e suave", "Regra dos terços"] },
            { "title": "Módulo 3: Edição", "topics": ["Introdução ao Lightroom", "Correção de cores", "Exercícios práticos"] }
          ],
          practicalActivities: [
            { "title": "Exercício de Teste", "description": "Em duplas, os participantes tiram 3 fotos um do outro." },
            { "title": "Exercício de Conhecimento", "description": "Os participantes tiram 3-5 fotos com diferentes tipos de iluminação." }
          ],
          requirements: ["Não são necessários pré-requisitos.", "Incentivamos a trazer o seu próprio smartphone ou câmara."],
          instructors: [
            { id: "bruno", name: "Bruno Diogo", title: "Supervisor de Marketing | Designer | UX/UI", image: "https://i.postimg.cc/yNhgmLJK/IMG-7311.avif", bio: "Supervisor de Marketing e Mídias Visuais | Designer Gráfico e Digital." },
            { id: "vinicius", name: "Vinícius Sena", title: "Fotógrafo Documental | Pós-produção", image: "https://i.postimg.cc/bw7kHG3D/vinicius.jpg", bio: "Formado em Animação, estudante e entusiasta de fotografia desde 2019." }
          ],
          isRatingEnabled: true
        },
        {
          id: "ia",
          title: "IA Aplicada à Análise de Dados",
          subtitle: "Do Relatório ao Insight",
          summary: "Transforme relatórios e dados brutos em dashboards web interativos e de alto impacto.",
          fullDescription: "Num mundo movido por dados, a capacidade de extrair insights rápidos é um superpoder. Com o 'Método Evereste Ágil', este curso vai desmistificar a IA.",
          targetAudience: "Para todos os colaboradores, entusiastas de tecnologia e qualquer pessoa curiosa sobre o poder da inteligência artificial.",
          themeColor: "#4CAF50",
          themeColorDark: "#388E3C",
          icon: "fa-brain",
          status: "aberto",
          headerOverlayImage: "https://i.postimg.cc/bv25v2BZ/relat-rio-1.png",
          details: {"Data": "06 de Novembro de 2025", "Carga": "4 horas", "Modalidade": "Presencial ou Online", "Público": "Livre"},
          learningObjectives: [
            "Formular prompts eficazes no Gemini.",
            "Publicar um dashboard interativo na web.",
            "Estruturar uma apresentação de resultados."
          ],
          modules: [
            { "title": "Módulo 1: Fundamentos", "topics": ["Método Evereste Ágil", "Ferramentas de IA", "Construindo o prompt"] },
            { "title": "Módulo 2: Publicação", "topics": ["GitHub Pages", "Publicando o dashboard", "Refinamento"] },
            { "title": "Módulo 3: Apresentação", "topics": ["Técnicas para apresentar", "Simulação", "Próximos passos"] }
          ],
          practicalActivities: [
            { "title": "Oficina: O Prompt Perfeito", "description": "Participantes recebem um relatório e devem construir um prompt." },
            { "title": "Oficina: Dashboard no Ar", "description": "Passo a passo guiado para publicar o dashboard online." }
          ],
          requirements: ["Indispensável ter um notebook.", "Conta Google (Gemini)", "Conta no GitHub."],
          instructors: [
            { id: "marllon", name: "Marllon Costa", title: "Técnico em TI | Designer | Inovação e IA", image: "https://i.postimg.cc/sxm4TVvF/IMG-9781.jpg", bio: "Designer gráfico, graduando em marketing e autodidata em Inovação e IA." }
          ],
          isRatingEnabled: false
        }
      ];
      
      return { initialCourses, initialInstructors };
    }
    

    // === GESTÃO DE MODAIS (Genérico) ===
    
    // Abrir Modal
    function _openModal(modal) {
      if (!modal) return;
      modal.classList.add('show');
    }
    
    // Fechar Modal
    function _closeModal(modal) {
      if (!modal) return;
      modal.classList.remove('show');
    }
    
    // Fechar ao clicar no backdrop
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          _closeModal(backdrop);
        }
      });
    });
    
    // Botões de fechar específicos
    document.getElementById('closeLogin')?.addEventListener('click', () => _closeModal(modalLogin));
    document.getElementById('closeEnroll')?.addEventListener('click', () => _closeModal(modalEnroll));
    document.getElementById('closeEnrollSuccess')?.addEventListener('click', () => _closeModal(modalEnrollSuccess));
    document.getElementById('closeCheckin')?.addEventListener('click', () => _closeModal(modalCheckin));
    document.getElementById('closeRating')?.addEventListener('click', () => _closeModal(modalRating));
    document.getElementById('closeEditCourse')?.addEventListener('click', () => _closeModal(modalEditCourse));
    document.getElementById('courseFormCancel')?.addEventListener('click', () => _closeModal(modalEditCourse));
    document.getElementById('closeEditInstructor')?.addEventListener('click', () => _closeModal(modalEditInstructor));
    document.getElementById('instructorFormCancel')?.addEventListener('click', () => _closeModal(modalEditInstructor));
    
    
    // Animação de Scroll (Reveal)
    const io = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) e.target.classList.add('show');
      });
    }, { threshold: 0.1 });
    document.querySelectorAll('.reveal').forEach(el => io.observe(el));

    // Scroll Progress
    const scrollProgress = document.getElementById('scroll-progress');
    window.addEventListener('scroll', () => {
      const h = document.documentElement;
      const st = h.scrollTop || document.body.scrollTop;
      const sh = h.scrollHeight || document.body.scrollHeight;
      const percent = (st / (sh - h.clientHeight)) * 100;
      scrollProgress.style.width = percent + '%';
    });

    // Header Scroll
    const header = document.getElementById('header');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 10) header.classList.add('header-scrolled');
      else header.classList.remove('header-scrolled');
    });

    // Particles
    const particles = document.getElementById('particles');
    const createParticle = () => {
      const s = document.createElement('span');
      s.style.left = Math.random() * 100 + 'vw';
      s.style.bottom = '-10px';
      s.style.width = (Math.random() * 2 + 1) + 'px';
      s.style.height = (Math.random() * 2 + 1) + 'px';
      s.style.animationDelay = Math.random() * 8 + 's';
      particles.appendChild(s);
      setTimeout(() => s.remove(), 14000);
    };
    for (let i = 0; i < 60; i++) createParticle();
    setInterval(createParticle, 600);

    // Link do Logo para Home
    document.getElementById('logo-link').addEventListener('click', (e) => {
      e.preventDefault();
      showView('main');
    });

    // Link Política de Privacidade (placeholder)
    document.getElementById('privacy-policy-link').addEventListener('click', (e) => {
      e.preventDefault();
      showToast("Página de Política de Privacidade ainda não implementada.", "error");
    });
    
    // Carregar dados do gráfico no início (apenas se for admin)
    onAuthStateChanged(auth, (user) => {
      if (user && !user.isAnonymous) {
        checkAdminStatus(user.uid).then(() => {
          if (isAdmin) {
            renderEnrollmentsChart();
          }
        });
      }
    });
    
  </script>
</body>
</html>




